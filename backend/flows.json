[
    {
        "id": "a811a2d2.521d38",
        "type": "tab",
        "label": "Server common",
        "disabled": true,
        "info": "Common setups"
    },
    {
        "id": "7d373be5.bb59d4",
        "type": "tab",
        "label": "ZWave common",
        "disabled": true,
        "info": ""
    },
    {
        "id": "60924caf.ca9954",
        "type": "tab",
        "label": "Ventilation common",
        "disabled": true,
        "info": ""
    },
    {
        "id": "f0ffdbb3.6e78b",
        "type": "tab",
        "label": "Ventilation",
        "disabled": true,
        "info": ""
    },
    {
        "id": "d849a1af.eac2a8",
        "type": "tab",
        "label": "Thermo floor",
        "disabled": true,
        "info": ""
    },
    {
        "id": "db61ef7a.7e00d8",
        "type": "tab",
        "label": "Blinds",
        "disabled": true,
        "info": ""
    },
    {
        "id": "ed3957ea.447518",
        "type": "tab",
        "label": "Presence",
        "disabled": true,
        "info": ""
    },
    {
        "id": "4bd1c1bf.4f0b7",
        "type": "tab",
        "label": "Zwave statistics",
        "disabled": true,
        "info": ""
    },
    {
        "id": "630512a0.49d8d4",
        "type": "tab",
        "label": "Water leakage",
        "disabled": true,
        "info": ""
    },
    {
        "id": "f3145e9a.1298d",
        "type": "tab",
        "label": "Smoke",
        "disabled": true,
        "info": ""
    },
    {
        "id": "5dede675.638c1",
        "type": "tab",
        "label": "Weather",
        "disabled": true,
        "info": ""
    },
    {
        "id": "1cc6b114.588857",
        "type": "tab",
        "label": "Lights",
        "disabled": true,
        "info": ""
    },
    {
        "id": "f924f1b0.7621d8",
        "type": "tab",
        "label": "Conditionaire common",
        "disabled": true,
        "info": ""
    },
    {
        "id": "51524d6e.749374",
        "type": "tab",
        "label": "Conditionaire",
        "disabled": true,
        "info": ""
    },
    {
        "id": "fdd35751.cb5538",
        "type": "tab",
        "label": "Media",
        "disabled": true,
        "info": ""
    },
    {
        "id": "e3d814f7.61466",
        "type": "tab",
        "label": "Radiator",
        "disabled": true,
        "info": ""
    },
    {
        "id": "413770b3.4ab71",
        "type": "subflow",
        "name": "Concat values",
        "info": "Can concat values\npayload: {value: 1, interval: 1000}",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 120,
                "wires": [
                    {
                        "id": "e482495c.d300b8"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 340,
                "y": 120,
                "wires": [
                    {
                        "id": "e482495c.d300b8",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "b21069c1.94ff18",
        "type": "subflow",
        "name": "isWeekend",
        "info": "check is weekend",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 80,
                "wires": [
                    {
                        "id": "dcab36fd.cd0d38"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 800,
                "y": 40,
                "wires": [
                    {
                        "id": "5d34bf68.a9e8",
                        "port": 0
                    }
                ]
            },
            {
                "x": 800,
                "y": 120,
                "wires": [
                    {
                        "id": "5d34bf68.a9e8",
                        "port": 1
                    }
                ]
            }
        ]
    },
    {
        "id": "ca5dcdbd.466ec",
        "type": "subflow",
        "name": "Telegram confirm",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 60,
                "wires": [
                    {
                        "id": "158261d9.4db52e"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1920,
                "y": 140,
                "wires": [
                    {
                        "id": "d2446acb.576c48",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1680,
                "y": 260,
                "wires": [
                    {
                        "id": "330c13f3.7e5744",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1440,
                "y": 340,
                "wires": [
                    {
                        "id": "e375e8ae.86b3c8",
                        "port": 2
                    }
                ]
            }
        ],
        "env": []
    },
    {
        "id": "5b528460.e43bb4",
        "type": "subflow",
        "name": "Telegram msg",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "6857b825.816f88"
                    }
                ]
            }
        ],
        "out": [],
        "env": []
    },
    {
        "id": "ecf602b6.267b58",
        "type": "subflow",
        "name": "Get ventilation saved props",
        "info": "",
        "category": "ventilation",
        "in": [
            {
                "x": 40,
                "y": 80,
                "wires": [
                    {
                        "id": "1499e0d0.9fae07"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 660,
                "y": 80,
                "wires": [
                    {
                        "id": "a896c336.e48ac8",
                        "port": 0
                    }
                ]
            }
        ],
        "env": []
    },
    {
        "id": "b02e364.3dde7c8",
        "type": "subflow",
        "name": "Check blinds position",
        "info": "",
        "category": "blinds",
        "in": [
            {
                "x": 80,
                "y": 80,
                "wires": [
                    {
                        "id": "68745c5d.b9dac4"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 640,
                "y": 40,
                "wires": [
                    {
                        "id": "ac66d901.7bb75",
                        "port": 0
                    }
                ]
            },
            {
                "x": 640,
                "y": 100,
                "wires": [
                    {
                        "id": "ac66d901.7bb75",
                        "port": 1
                    }
                ]
            }
        ],
        "env": []
    },
    {
        "id": "479f7f9c.36dc5",
        "type": "subflow",
        "name": "get lux",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 120,
                "y": 140,
                "wires": [
                    {
                        "id": "5cc41779.465918"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 680,
                "y": 140,
                "wires": [
                    {
                        "id": "8bffe03.ee48ba",
                        "port": 0
                    }
                ]
            }
        ],
        "env": []
    },
    {
        "id": "66ec50f7.5c938",
        "type": "subflow",
        "name": "get humidity",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 160,
                "y": 100,
                "wires": [
                    {
                        "id": "61ef3aad.77d0fc"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 720,
                "y": 100,
                "wires": [
                    {
                        "id": "cf8b7f55.70304",
                        "port": 0
                    }
                ]
            }
        ],
        "env": []
    },
    {
        "id": "7c5f5dec.00cb4c",
        "type": "mqtt-broker",
        "z": "",
        "name": "broker",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": false,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "3bb6209c.4b0d08",
        "type": "mongodb",
        "z": "",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "server",
        "name": "mongo"
    },
    {
        "id": "c322dc72.eb0098",
        "type": "modbus-client",
        "z": "",
        "name": "modbus",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "tcpHost": "localhost",
        "tcpPort": "4444",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": "9600",
        "serialDatabits": "8",
        "serialStopbits": "1",
        "serialParity": "none",
        "serialConnectionDelay": "100",
        "unit_id": "1",
        "commandDelay": "1",
        "clientTimeout": "1000",
        "reconnectTimeout": "2000"
    },
    {
        "id": "95efe3a3.9ad27",
        "type": "telegram bot",
        "z": "",
        "botname": "",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "600",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "aeffd74.491f0a8",
        "type": "influxdb",
        "z": "",
        "hostname": "127.0.0.1",
        "port": "8086",
        "protocol": "http",
        "database": "statistics",
        "name": "influx config",
        "usetls": false,
        "tls": ""
    },
    {
        "id": "46e35d6a.85f28c",
        "type": "rmdevice",
        "z": "",
        "folder": "/home-automation/broadlink/SharedData",
        "mac": "FFFFFFFFFFFF",
        "host": "127.0.0.1"
    },
    {
        "id": "8333b8e6.541fc8",
        "type": "rmdevice",
        "z": "",
        "folder": "/home-automation/broadlink/SharedData",
        "mac": "FFFFFFFFFFFF",
        "host": "127.0.0.1"
    },
    {
        "id": "91390a98.35566",
        "type": "mongodb in",
        "z": "a811a2d2.521d38",
        "mongodb": "3bb6209c.4b0d08",
        "name": "",
        "collection": "config",
        "operation": "find",
        "x": 500,
        "y": 280,
        "wires": [
            [
                "aa7dccf8.3f19b"
            ]
        ]
    },
    {
        "id": "818578f8.6ea4a8",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "config func",
        "func": "msg.payload = {id: 1};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 280,
        "wires": [
            [
                "91390a98.35566"
            ]
        ]
    },
    {
        "id": "aa7dccf8.3f19b",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "get config",
        "func": "if(msg.payload && msg.payload.length) {\n    var result = msg.payload[0];\n    delete result._id;\n    delete result.id;\n    msg.payload = result;\n}\n\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 280,
        "wires": [
            [
                "8b2d127d.f407f8"
            ]
        ]
    },
    {
        "id": "a2ca5b19.ba3748",
        "type": "mqtt in dynamic",
        "z": "a811a2d2.521d38",
        "topic": "/server/settings/request",
        "qos": "1",
        "name": "settings request",
        "broker": "7c5f5dec.00cb4c",
        "x": 140,
        "y": 140,
        "wires": [
            [
                "818578f8.6ea4a8"
            ]
        ]
    },
    {
        "id": "813d048b.1bb5d",
        "type": "mqtt out dynamic",
        "z": "a811a2d2.521d38",
        "name": "mqtt out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1040,
        "y": 280,
        "wires": []
    },
    {
        "id": "5ae20c5c.c6aacc",
        "type": "inject",
        "z": "a811a2d2.521d38",
        "name": "startup",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 180,
        "y": 80,
        "wires": [
            [
                "818578f8.6ea4a8"
            ]
        ]
    },
    {
        "id": "9d1e5eb7.e62bd8",
        "type": "mqtt out dynamic",
        "z": "a811a2d2.521d38",
        "name": "heartbit out",
        "topic": "/server/heartbit/response",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 430,
        "y": 380,
        "wires": []
    },
    {
        "id": "8c9f2548.9135c",
        "type": "inject",
        "z": "a811a2d2.521d38",
        "name": "heartbit",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "2",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 140,
        "y": 380,
        "wires": [
            [
                "9d1e5eb7.e62bd8"
            ]
        ]
    },
    {
        "id": "8b2d127d.f407f8",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "init",
        "func": "msg.topic = '/server/settings/init';\nmsg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 200,
        "wires": [
            [
                "813d048b.1bb5d"
            ]
        ]
    },
    {
        "id": "6425153e.4a9664",
        "type": "zwave-in",
        "z": "7d373be5.bb59d4",
        "name": "zwave in",
        "controller": "",
        "x": 120,
        "y": 220,
        "wires": [
            [
                "a3b2eb16.6d22c"
            ]
        ]
    },
    {
        "id": "a3b2eb16.6d22c",
        "type": "switch",
        "z": "7d373be5.bb59d4",
        "name": "message type switch",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "zwave: scan complete",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: node added",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: value added",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: value changed",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: value refreshed",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: node ready",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: notification",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: node removed",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "zwave: controller command",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 360,
        "y": 220,
        "wires": [
            [
                "e74c5f75.98389",
                "ff2313df.64ff08"
            ],
            [
                "88263b2e.992b8"
            ],
            [
                "88263b2e.992b8"
            ],
            [
                "7911fd0f.d0d3fc",
                "fb00c0a.48d294"
            ],
            [
                "fb00c0a.48d294",
                "7911fd0f.d0d3fc"
            ],
            [
                "ce469275.dbae7",
                "88263b2e.992b8"
            ],
            [
                "845ef77c.2c0c38"
            ],
            [
                "ce469275.dbae7",
                "55b009b8.f3bd7",
                "706467b2.a9a4f8"
            ],
            [
                "ba7eb44a.8da14"
            ]
        ]
    },
    {
        "id": "eacc3f7e.bf2b48",
        "type": "mqtt out dynamic",
        "z": "7d373be5.bb59d4",
        "name": "mqtt out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1260,
        "y": 640,
        "wires": []
    },
    {
        "id": "d0b46be0.b162a",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "ready func",
        "func": "msg.topic = '/zwave/ready/response';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 980,
        "wires": [
            [
                "2886e7dd.abc1e"
            ]
        ]
    },
    {
        "id": "a7017de7.5cd57",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/ready/request",
        "qos": "1",
        "name": "ready in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 360,
        "wires": [
            [
                "4e1ea9ab.4fb4f8"
            ]
        ]
    },
    {
        "id": "e74c5f75.98389",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "set ready",
        "func": "\nflow.set('ready', true);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 40,
        "wires": [
            [
                "b7161ce7.5d30a8"
            ]
        ]
    },
    {
        "id": "4e1ea9ab.4fb4f8",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get ready",
        "func": "var isReady = flow.get('ready');\n\nif(isReady) {\n    return msg;\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 360,
        "wires": [
            [
                "2f4ee6ab.e6b99a"
            ]
        ]
    },
    {
        "id": "303d882a.233d18",
        "type": "zwave-out",
        "z": "7d373be5.bb59d4",
        "name": "zwave out",
        "controller": "",
        "x": 1260,
        "y": 700,
        "wires": [
            [
                "a5f15f6d.dd34f8"
            ]
        ]
    },
    {
        "id": "cc75e1ea.9b942",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/hardreset/request",
        "qos": "1",
        "name": "hard reset in",
        "broker": "7c5f5dec.00cb4c",
        "x": 130,
        "y": 440,
        "wires": [
            [
                "732eedcc.63df9c"
            ]
        ]
    },
    {
        "id": "732eedcc.63df9c",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "reset zwave",
        "func": "var msg = {};\n\nmsg.topic = \"hardReset\";\nmsg.payload = {};\nmsg.removeAll = true;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 440,
        "wires": [
            [
                "3a54f1ea.01319e",
                "288edf7f.d72758"
            ]
        ]
    },
    {
        "id": "b399d578.a03cc8",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "zwave out",
        "links": [
            "3a54f1ea.01319e",
            "b5d1158.4d9e8e8",
            "ab346834.7dc068",
            "766a0fb1.c291a8",
            "81ad74f9.d69fa",
            "dabbe9e7.7b78f",
            "16dd1768.2be309",
            "914260f2.e54998",
            "f609e699.df765",
            "234c60ac.1a3258",
            "7d9e65b7.fa525c",
            "223ecc12.68bbdc",
            "2035c52d.a9ea42",
            "2978b39.099174c",
            "386b77ef.2fc2b8",
            "e60f1237.204d5",
            "54f411a6.976e28",
            "17a80c99.121fe3",
            "6b9dbb8e.2af09c"
        ],
        "x": 1135,
        "y": 700,
        "wires": [
            [
                "303d882a.233d18"
            ]
        ]
    },
    {
        "id": "3a54f1ea.01319e",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 475,
        "y": 460,
        "wires": []
    },
    {
        "id": "473c9662.b157e8",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "mqtt out",
        "links": [
            "2886e7dd.abc1e",
            "7b06e1a4.fed97",
            "b79164a5.92e4e",
            "1c7944f2.0b88f3",
            "53648415.fb5e44",
            "8408d8b9.f0e2a8",
            "89ad614b.bdd22",
            "aa03e849.fffc88",
            "8e983d62.be5d08",
            "80084f8f.8638b",
            "1de251d8.bc9a86",
            "de7855d8.3abf98",
            "d02bbc76.64623"
        ],
        "x": 1135,
        "y": 640,
        "wires": [
            [
                "eacc3f7e.bf2b48"
            ]
        ]
    },
    {
        "id": "2886e7dd.abc1e",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 1455,
        "y": 980,
        "wires": []
    },
    {
        "id": "6f067004.c7bbf",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/addnode/request",
        "qos": "1",
        "name": "add node in",
        "broker": "7c5f5dec.00cb4c",
        "x": 130,
        "y": 520,
        "wires": [
            [
                "75c19750.c7d06"
            ]
        ]
    },
    {
        "id": "75c19750.c7d06",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "add zwave node",
        "func": "var msg = {};\n\nmsg.topic = \"addNode\";\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 520,
        "wires": [
            [
                "b5d1158.4d9e8e8"
            ]
        ]
    },
    {
        "id": "b5d1158.4d9e8e8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 515,
        "y": 520,
        "wires": []
    },
    {
        "id": "c2ab541c.a39498",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/cancelaction/request",
        "qos": "1",
        "name": "cancel action in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 640,
        "wires": [
            [
                "84e4c902.0b4d3"
            ]
        ]
    },
    {
        "id": "84e4c902.0b4d3",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "cancel zwave action",
        "func": "var msg = {};\n\nmsg.topic = \"cancelControllerCommand\";\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 640,
        "wires": [
            [
                "ab346834.7dc068"
            ]
        ]
    },
    {
        "id": "ab346834.7dc068",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 515,
        "y": 640,
        "wires": []
    },
    {
        "id": "a44ca019.ae5e98",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/removenode/request",
        "qos": "1",
        "name": "remove node in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 580,
        "wires": [
            [
                "127eeec4.13dfd1"
            ]
        ]
    },
    {
        "id": "127eeec4.13dfd1",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "remove zwave node",
        "func": "var msg = {};\n\nmsg.topic = \"removeNode\";\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 580,
        "wires": [
            [
                "766a0fb1.c291a8"
            ]
        ]
    },
    {
        "id": "766a0fb1.c291a8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 495,
        "y": 580,
        "wires": []
    },
    {
        "id": "ce469275.dbae7",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "save config",
        "func": "const newMsg = {};\n\nnewMsg.topic = \"writeConfig\";\nnewMsg.payload = {};\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 240,
        "wires": [
            [
                "81ad74f9.d69fa"
            ]
        ]
    },
    {
        "id": "81ad74f9.d69fa",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 815,
        "y": 240,
        "wires": []
    },
    {
        "id": "78e8c927.60be58",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "node ready",
        "func": "const newMsg = {};\nnewMsg.topic = '/zwave/addnode/response';\nnewMsg.payload = msg.payload;\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1770,
        "y": 60,
        "wires": [
            [
                "7b06e1a4.fed97"
            ]
        ]
    },
    {
        "id": "7b06e1a4.fed97",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 1915,
        "y": 60,
        "wires": []
    },
    {
        "id": "55b009b8.f3bd7",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "node removed",
        "func": "const nodeId = msg.payload.nodeid;\nmsg = {};\nmsg.topic = '/zwave/removenode/response';\nmsg.payload = {nodeid: nodeId};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 820,
        "y": 360,
        "wires": [
            [
                "b79164a5.92e4e"
            ]
        ]
    },
    {
        "id": "b79164a5.92e4e",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 975,
        "y": 360,
        "wires": []
    },
    {
        "id": "8408d8b9.f0e2a8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 855,
        "y": 160,
        "wires": []
    },
    {
        "id": "7911fd0f.d0d3fc",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "value changes",
        "func": "const value = msg.payload.value;\nmsg.topic = '/zwave/changevalue/response';\nmsg.payload = value;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 160,
        "wires": [
            [
                "8408d8b9.f0e2a8"
            ]
        ]
    },
    {
        "id": "b251668c.9f2188",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/getnodes/request",
        "qos": "1",
        "name": "get nodes",
        "broker": "7c5f5dec.00cb4c",
        "x": 100,
        "y": 980,
        "wires": [
            [
                "b19b0f7d.8111d8"
            ]
        ]
    },
    {
        "id": "b19b0f7d.8111d8",
        "type": "mongodb in",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get nodes",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 470,
        "y": 980,
        "wires": [
            [
                "435df10c.a373e"
            ]
        ]
    },
    {
        "id": "372410fd.6c526",
        "type": "inject",
        "z": "7d373be5.bb59d4",
        "name": "startup send nodes",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 170,
        "y": 1040,
        "wires": [
            [
                "b19b0f7d.8111d8"
            ]
        ]
    },
    {
        "id": "435df10c.a373e",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get nodes response",
        "func": "msg.topic = '/zwave/getnodes/response';\nmsg.payload.forEach(x=>{\n    delete x._id;\n});\nmsg.payload = msg.payload;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 980,
        "wires": [
            [
                "89ad614b.bdd22"
            ]
        ]
    },
    {
        "id": "89ad614b.bdd22",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 845,
        "y": 980,
        "wires": []
    },
    {
        "id": "ba7eb44a.8da14",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "failed node remove",
        "func": "if(msg.state !== 8) return;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 360,
        "wires": [
            [
                "55b009b8.f3bd7"
            ]
        ]
    },
    {
        "id": "8111695e.4fc648",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/namechange/request",
        "qos": "1",
        "name": "change name in",
        "broker": "7c5f5dec.00cb4c",
        "x": 110,
        "y": 1120,
        "wires": [
            [
                "7d3a717f.014d9",
                "6e9bc0a7.6b99e8"
            ]
        ]
    },
    {
        "id": "e9234ee7.a965f8",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "name": "change value in",
        "broker": "7c5f5dec.00cb4c",
        "x": 100,
        "y": 1180,
        "wires": [
            [
                "967ecd39.996488"
            ]
        ]
    },
    {
        "id": "967ecd39.996488",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform node for zwave",
        "func": "msg.topic = 'setValue';\nconst value = msg.payload.value;\n\nconst cmd = {};\ncmd.nodeid = value.node_id;\ncmd.cmdclass = value.class_id;\ncmd.instance = value.instance;\ncmd.cmdidx = value.index;\ncmd.value = value.value;\n    \nmsg.payload = cmd;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 1180,
        "wires": [
            [
                "5e068c7f.b76f24",
                "7cd6d82e.c6026",
                "7a1e4b3b.968e3c"
            ]
        ]
    },
    {
        "id": "16dd1768.2be309",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 875,
        "y": 1120,
        "wires": []
    },
    {
        "id": "13d252d9.ed9a35",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "heal network",
        "func": "var msg = {};\n\nmsg.topic = \"healNetwork\";\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 700,
        "wires": [
            [
                "914260f2.e54998"
            ]
        ]
    },
    {
        "id": "30a0603e.e0381",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/healnetwork/request",
        "qos": "1",
        "name": "heal in",
        "broker": "7c5f5dec.00cb4c",
        "x": 90,
        "y": 700,
        "wires": [
            [
                "13d252d9.ed9a35"
            ]
        ]
    },
    {
        "id": "914260f2.e54998",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 515,
        "y": 700,
        "wires": []
    },
    {
        "id": "845ef77c.2c0c38",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform payload dead/not dead",
        "func": "const nodeid = msg.payload.nodeid;\nconst newPayload = {};\n\n\nif(msg.payload.notification === 5) {\n   newPayload.dead = true;\n}\n\nelse if(msg.payload.notification === 6) {\n   newPayload.dead = false;\n} else {\n    return;\n}\n\n\nnewPayload.nodeid = nodeid\nmsg.payload = newPayload;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 280,
        "wires": [
            [
                "6ca06cc6.5f509c",
                "34592a68.ac045e"
            ]
        ]
    },
    {
        "id": "6ca06cc6.5f509c",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "update node status",
        "func": "msg.topic = '/zwave/nodestatus/response';\nmsg.payload = {nodeid: msg.payload.nodeid, dead: msg.payload.dead};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 280,
        "wires": [
            [
                "aa03e849.fffc88"
            ]
        ]
    },
    {
        "id": "aa03e849.fffc88",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 1195,
        "y": 280,
        "wires": []
    },
    {
        "id": "16cddc1d.18673c",
        "type": "mqtt in dynamic",
        "z": "a811a2d2.521d38",
        "topic": "/dashboard/save/request",
        "qos": "1",
        "name": "save",
        "broker": "7c5f5dec.00cb4c",
        "x": 70,
        "y": 560,
        "wires": [
            [
                "88377b93.1f8c1"
            ]
        ]
    },
    {
        "id": "88377b93.1f8c1",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "before search",
        "func": "msg.original = msg.payload;\nmsg.payload = {id: 1};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 260,
        "y": 560,
        "wires": [
            [
                "1c2db42c.c67314"
            ]
        ]
    },
    {
        "id": "6c4a6e44.3df268",
        "type": "mongodb out",
        "z": "a811a2d2.521d38",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save dashboard",
        "collection": "dashboard",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 900,
        "y": 480,
        "wires": []
    },
    {
        "id": "1c2db42c.c67314",
        "type": "mongodb in",
        "z": "a811a2d2.521d38",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find",
        "collection": "dashboard",
        "operation": "find",
        "x": 430,
        "y": 560,
        "wires": [
            [
                "cffbb013.3451c",
                "9b228e5.8dfd37"
            ]
        ]
    },
    {
        "id": "cffbb013.3451c",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "after search",
        "func": "if(msg.loading) return;\n\nlet found = msg.payload[0];\n\nif(!found) {\n    found = {id: 1};\n}\n\nfound.data = msg.original;\nmsg.payload = found;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 560,
        "wires": [
            [
                "6c4a6e44.3df268"
            ]
        ]
    },
    {
        "id": "78c8a147.dc7518",
        "type": "mqtt in dynamic",
        "z": "a811a2d2.521d38",
        "topic": "/dashboard/load/request",
        "qos": "1",
        "name": "load",
        "broker": "7c5f5dec.00cb4c",
        "x": 70,
        "y": 660,
        "wires": [
            [
                "a897d31c.5fcbf"
            ]
        ]
    },
    {
        "id": "a34dc89a.a318c",
        "type": "mqtt out dynamic",
        "z": "a811a2d2.521d38",
        "name": "send dashboard",
        "topic": "/dashboard/load/response",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 920,
        "y": 660,
        "wires": []
    },
    {
        "id": "9b228e5.8dfd37",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "after load",
        "func": "let found = msg.payload[0];\n\nif(!found) {\n    return;\n}\n\nif(!msg.loading) {\n    const newMsg = {};\n    newMsg.payload = { data: msg.original };\n    \n    return newMsg;\n}\n\nmsg.payload = {data: found.data};\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 660,
        "wires": [
            [
                "a34dc89a.a318c"
            ]
        ]
    },
    {
        "id": "a897d31c.5fcbf",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "before load",
        "func": "msg.loading = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 260,
        "y": 660,
        "wires": [
            [
                "88377b93.1f8c1"
            ]
        ]
    },
    {
        "id": "ca2a98b.856a5e8",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/removedead/request",
        "qos": "1",
        "name": "remove dead in",
        "broker": "7c5f5dec.00cb4c",
        "x": 100,
        "y": 780,
        "wires": [
            [
                "f0a0a946.a61b98",
                "f887be80.ae7bf8"
            ]
        ]
    },
    {
        "id": "f609e699.df765",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 435,
        "y": 820,
        "wires": []
    },
    {
        "id": "f0a0a946.a61b98",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "remove dead",
        "func": "const nodeId = msg.payload.nodeid;\n\nmsg.topic = \"removeFailedNode\";\nmsg.payload = { args: [nodeId] };\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 290,
        "y": 820,
        "wires": [
            [
                "f609e699.df765"
            ]
        ]
    },
    {
        "id": "8baacfb1.6ca9c",
        "type": "inject",
        "z": "60924caf.ca9954",
        "name": "Get status",
        "topic": "",
        "payload": "{\"payload\":{}}",
        "payloadType": "json",
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "x": 130,
        "y": 260,
        "wires": [
            [
                "5d46ccb1.3515b4",
                "2fd391d3.afa4b6",
                "5ad76232.7002ec",
                "e4f0fa9c.891198",
                "1c1ef7ed.ab97e",
                "e6d5ac0a.4809d",
                "364b6591.f95b3a",
                "f0fd2f45.288ce"
            ]
        ]
    },
    {
        "id": "4162c6e2.e50728",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "set modbus get params",
        "func": "if(!msg.payload.quantity) {\n    msg.payload.quantity = 1;\n}\nif(!msg.payload.fc) {\n    msg.payload.fc = 4;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 260,
        "wires": [
            [
                "6ba67241.22e62c"
            ]
        ]
    },
    {
        "id": "5d46ccb1.3515b4",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get error code",
        "func": "msg.topic = 'error';\nmsg.payload.address = 19;\nmsg.payload.quantity = 2;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 200,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "6ba67241.22e62c",
        "type": "modbus-flex-getter",
        "z": "60924caf.ca9954",
        "name": "status get",
        "showStatusActivities": false,
        "showErrors": false,
        "logIOActivities": false,
        "server": "c322dc72.eb0098",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "x": 820,
        "y": 260,
        "wires": [
            [],
            [
                "b5e8b977.ceaca"
            ]
        ]
    },
    {
        "id": "b5e8b977.ceaca",
        "type": "switch",
        "z": "60924caf.ca9954",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "error",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "power status",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "temperature",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "temperature setted",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan speed",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan speed setted",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan consumption",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ten consumption",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 8,
        "x": 990,
        "y": 180,
        "wires": [
            [
                "a8629540.c6ad28"
            ],
            [
                "24f291ab.2c0036"
            ],
            [
                "19e18ccf.3dfd7b"
            ],
            [
                "b37d538c.c9164"
            ],
            [
                "31b94002.889ac8"
            ],
            [
                "4f99f81b.f80628"
            ],
            [
                "ecc68a1b.6d7438"
            ],
            [
                "aff817d0.941b08"
            ]
        ]
    },
    {
        "id": "a8629540.c6ad28",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "error",
        "func": "const {data} = msg.payload;\nmsg.payload = {};\nif(data[0]+data[1]*0x10000 !== 0) {\n    msg.payload.error = true;\n} else {\n      msg.payload.error = false;\n}\n\nflow.set('error', msg.payload.error);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 140,
        "wires": [
            [
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "2fd391d3.afa4b6",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get power status",
        "func": "msg.topic = 'power status';\nmsg.payload.address = 10;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 260,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "24f291ab.2c0036",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "power status",
        "func": "const {data} = msg.payload;\nmsg.payload = {};\nif(data[0] == 1) {\n    msg.payload.enabled = true;\n} else {\n      msg.payload.enabled = false;\n}\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 200,
        "wires": [
            [
                "bc16d2a8.e81de",
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "5ad76232.7002ec",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get temperature",
        "func": "msg.topic = 'temperature';\nmsg.payload.address = 13;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 320,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "19e18ccf.3dfd7b",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "temperature",
        "func": "const {data} = msg.payload;\nmsg.payload = {temperature: data[0]/10};\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 260,
        "wires": [
            [
                "bc16d2a8.e81de",
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "e4f0fa9c.891198",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get fan speed",
        "func": "msg.topic = 'fan speed';\nmsg.payload.address = 17;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 380,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "31b94002.889ac8",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "fan speed",
        "func": "const {data} = msg.payload;\nmsg.payload = {speed: data[0]/100};\nmsg.topic = '/ventilation/status/response';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 380,
        "wires": [
            [
                "bc16d2a8.e81de",
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "1c1ef7ed.ab97e",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get fan consuption",
        "func": "msg.topic = 'fan consumption';\nmsg.payload.address = 10004;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 580,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "ecc68a1b.6d7438",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "fan consumption",
        "func": "const {data} = msg.payload;\n\nlet value = data[0] / 60 / 60;\n\nmsg.payload = {value: value, interval: (1000*60)*60};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 540,
        "wires": [
            [
                "4caed597.074fbc"
            ]
        ]
    },
    {
        "id": "e6d5ac0a.4809d",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get ten consuption",
        "func": "msg.topic = 'ten consumption';\nmsg.payload.address = 14004;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 640,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "aff817d0.941b08",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "ten consumption",
        "func": "const {data} = msg.payload;\n\nlet value = data[0] / 60 / 60;\n\nmsg.payload = {value: value, interval: (1000*60)*60};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 580,
        "wires": [
            [
                "370ae770.3cb66"
            ]
        ]
    },
    {
        "id": "e482495c.d300b8",
        "type": "function",
        "z": "413770b3.4ab71",
        "name": "concat value",
        "func": "let concatValue = context.get('val');\nconst setInt = context.get('set');\n\nif(!concatValue) {\n    concatValue = 0;\n}\n\nconcatValue += msg.payload.value;\n\ncontext.set('val', concatValue);\n\nif(!setInt) {\n    const interval = msg.payload.interval ? msg.payload.interval : 1000;\n    setInterval(()=>{\n        node.send({topic: msg.topic, payload: {value: concatValue}});\n        context.set('val', 0);\n    }, interval);\n    context.set('set', true);\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "4caed597.074fbc",
        "type": "subflow:413770b3.4ab71",
        "z": "60924caf.ca9954",
        "name": "",
        "x": 1490,
        "y": 540,
        "wires": [
            [
                "cd77ef2c.9e3268"
            ]
        ]
    },
    {
        "id": "370ae770.3cb66",
        "type": "subflow:413770b3.4ab71",
        "z": "60924caf.ca9954",
        "name": "",
        "x": 1490,
        "y": 580,
        "wires": [
            [
                "cd77ef2c.9e3268"
            ]
        ]
    },
    {
        "id": "c1a245d2.35a688",
        "type": "mongodb out",
        "z": "60924caf.ca9954",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save to db",
        "collection": "ventilation",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 720,
        "y": 80,
        "wires": []
    },
    {
        "id": "5277e75c.c8f1a",
        "type": "link out",
        "z": "60924caf.ca9954",
        "name": "",
        "links": [
            "fe713a7f.96f218"
        ],
        "x": 1635,
        "y": 240,
        "wires": []
    },
    {
        "id": "fe713a7f.96f218",
        "type": "link in",
        "z": "60924caf.ca9954",
        "name": "save to db",
        "links": [
            "5277e75c.c8f1a",
            "2815858d.5d1a5a"
        ],
        "x": 355,
        "y": 80,
        "wires": [
            [
                "555a5b28.7f03e4"
            ]
        ]
    },
    {
        "id": "fd1671cd.066b88",
        "type": "link in",
        "z": "60924caf.ca9954",
        "name": "mqtt out",
        "links": [
            "bc16d2a8.e81de",
            "2db78ca.9da5874"
        ],
        "x": 585,
        "y": 140,
        "wires": [
            [
                "5ca50c67.189e8c"
            ]
        ]
    },
    {
        "id": "bc16d2a8.e81de",
        "type": "link out",
        "z": "60924caf.ca9954",
        "name": "",
        "links": [
            "fd1671cd.066b88"
        ],
        "x": 1635,
        "y": 320,
        "wires": []
    },
    {
        "id": "e3c3faca.8e94a8",
        "type": "mqtt in dynamic",
        "z": "60924caf.ca9954",
        "topic": "/ventilation/allstatus/request",
        "qos": "1",
        "name": "request status",
        "broker": "7c5f5dec.00cb4c",
        "x": 140,
        "y": 800,
        "wires": [
            [
                "dfbf0ec0.716c1"
            ]
        ]
    },
    {
        "id": "5ca50c67.189e8c",
        "type": "mqtt out dynamic",
        "z": "60924caf.ca9954",
        "name": "mqtt out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 710,
        "y": 140,
        "wires": []
    },
    {
        "id": "dfbf0ec0.716c1",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get item",
        "func": "msg.payload = {id: 1};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 800,
        "wires": [
            [
                "d113cfb5.33cb5"
            ]
        ]
    },
    {
        "id": "d113cfb5.33cb5",
        "type": "mongodb in",
        "z": "60924caf.ca9954",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find item",
        "collection": "ventilation",
        "operation": "find",
        "x": 530,
        "y": 800,
        "wires": [
            [
                "90ad5ea2.386d6"
            ]
        ]
    },
    {
        "id": "90ad5ea2.386d6",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "ready to send",
        "func": "msg.payload = {data: msg.payload[0]};\nmsg.topic = '/ventilation/allstatus/response';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 800,
        "wires": [
            [
                "2db78ca.9da5874"
            ]
        ]
    },
    {
        "id": "2db78ca.9da5874",
        "type": "link out",
        "z": "60924caf.ca9954",
        "name": "",
        "links": [
            "fd1671cd.066b88"
        ],
        "x": 845,
        "y": 800,
        "wires": []
    },
    {
        "id": "47084b60.a8f764",
        "type": "modbus-flex-write",
        "z": "60924caf.ca9954",
        "name": "change values",
        "showStatusActivities": false,
        "showErrors": false,
        "server": "c322dc72.eb0098",
        "x": 980,
        "y": 1000,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "ec7afd9e.0d1038",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "set modbus post params",
        "func": "const isError = flow.get('error');\n\nif(isError) return;\n\nmsg.payload.fc = 6;\nmsg.payload.quantity = 1;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 1000,
        "wires": [
            [
                "47084b60.a8f764"
            ]
        ]
    },
    {
        "id": "555a5b28.7f03e4",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "set ready to save",
        "func": "msg.payload.id = 1;\nconst $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {id:1}};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 80,
        "wires": [
            [
                "c1a245d2.35a688"
            ]
        ]
    },
    {
        "id": "241ee1f3.3c92fe",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "enable/disable",
        "func": "if(msg.payload.value !== 0 && msg.payload.value !== 1) return;\n\nmsg.payload.address = 3;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 1000,
        "wires": [
            [
                "ec7afd9e.0d1038"
            ]
        ]
    },
    {
        "id": "83320a01.f26f9",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "temperature",
        "func": "msg.payload.value = Math.round(msg.payload.value);\n\nif(msg.payload.value < 5 && msg.payload.value > 34) return;\n\nmsg.payload.value = msg.payload.value * 10;\nmsg.payload.address = 1;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 1040,
        "wires": [
            [
                "ec7afd9e.0d1038"
            ]
        ]
    },
    {
        "id": "6d8ba987.9c56c",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "fan speed",
        "func": "if((msg.payload.value < 15 && msg.payload.value > 100) || (msg.payload.value !== 15 && msg.payload.value%10 !== 0)) return;\n\nmsg.payload.value = msg.payload.value * 100;\nmsg.payload.address = 0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 1080,
        "wires": [
            [
                "ec7afd9e.0d1038"
            ]
        ]
    },
    {
        "id": "e9bfe438.305a08",
        "type": "mqtt in dynamic",
        "z": "60924caf.ca9954",
        "topic": "/ventilation/setpower/request",
        "qos": "1",
        "name": "set power",
        "broker": "7c5f5dec.00cb4c",
        "x": 100,
        "y": 1000,
        "wires": [
            [
                "241ee1f3.3c92fe"
            ]
        ]
    },
    {
        "id": "3cc3ba98.a892b6",
        "type": "mqtt in dynamic",
        "z": "60924caf.ca9954",
        "topic": "/ventilation/settemperature/request",
        "qos": "1",
        "name": "set temperature",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 1040,
        "wires": [
            [
                "83320a01.f26f9"
            ]
        ]
    },
    {
        "id": "bf3acdb1.b363f8",
        "type": "mqtt in dynamic",
        "z": "60924caf.ca9954",
        "topic": "/ventilation/setfanspeed/request",
        "qos": "1",
        "name": "set fan speed",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 1080,
        "wires": [
            [
                "6d8ba987.9c56c"
            ]
        ]
    },
    {
        "id": "364b6591.f95b3a",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get setted fan speed",
        "func": "msg.topic = 'fan speed setted';\nmsg.payload.address = 0;\nmsg.payload.fc = 3;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 371,
        "y": 438,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "4f99f81b.f80628",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "fan speed setted",
        "func": "const {data} = msg.payload;\nmsg.payload = {settedSpeed: data[0]/100};\nmsg.topic = '/ventilation/status/response';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 440,
        "wires": [
            [
                "bc16d2a8.e81de",
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "f0fd2f45.288ce",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "get setted temperature",
        "func": "msg.topic = 'temperature setted';\nmsg.payload.address = 1;\nmsg.payload.fc = 3;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 500,
        "wires": [
            [
                "4162c6e2.e50728"
            ]
        ]
    },
    {
        "id": "b37d538c.c9164",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "temperature setted",
        "func": "const {data} = msg.payload;\nmsg.payload = {settedTemperature: data[0]/10};\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 320,
        "wires": [
            [
                "bc16d2a8.e81de",
                "5277e75c.c8f1a"
            ]
        ]
    },
    {
        "id": "6768cdd2.12ab7c",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "update without create in db",
        "links": [
            "7d3a717f.014d9",
            "34592a68.ac045e",
            "55a8b86e.07314",
            "92eb7753.80b22",
            "2db35d73.983ca2",
            "3f88a0e7.d77828",
            "e8b61997.5bc38"
        ],
        "x": 1135,
        "y": 780,
        "wires": [
            [
                "c50ce92a.425bc"
            ]
        ]
    },
    {
        "id": "fd572e33.74419",
        "type": "mongodb out",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "update without create",
        "collection": "zwave-nodes",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 1540,
        "y": 780,
        "wires": []
    },
    {
        "id": "bca677d3.c0ceb",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "update with create in db",
        "links": [
            "30afe4c4.212114",
            "745bb339.087274",
            "12e28cef.d95be3"
        ],
        "x": 1135,
        "y": 840,
        "wires": [
            [
                "3774d8bc.0cacb"
            ]
        ]
    },
    {
        "id": "989c661a.ff6dc8",
        "type": "mongodb out",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "update with create",
        "collection": "zwave-nodes",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1550,
        "y": 840,
        "wires": []
    },
    {
        "id": "c50ce92a.425bc",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "set ready to update",
        "func": "const $set = {$set: msg.payload};\nconst query = msg.query ? msg.query : {nodeid: msg.payload.nodeid};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1290,
        "y": 780,
        "wires": [
            [
                "fd572e33.74419"
            ]
        ]
    },
    {
        "id": "3774d8bc.0cacb",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "set ready to update",
        "func": "const $set = {$set: msg.payload};\nconst newMsg = {payload: $set, query: {nodeid: msg.payload.nodeid}};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1290,
        "y": 840,
        "wires": [
            [
                "989c661a.ff6dc8"
            ]
        ]
    },
    {
        "id": "7d3a717f.014d9",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "6768cdd2.12ab7c",
            "82cc3504.c1f368"
        ],
        "x": 235,
        "y": 1080,
        "wires": []
    },
    {
        "id": "e92b9183.e79788",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "remove node from db",
        "links": [
            "f887be80.ae7bf8",
            "288edf7f.d72758",
            "706467b2.a9a4f8",
            "aa3861bc.9b2d4"
        ],
        "x": 1135,
        "y": 900,
        "wires": [
            [
                "7530bc9a.b2cea4"
            ]
        ]
    },
    {
        "id": "ab8ae39e.6f9308",
        "type": "mongodb out",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "remove node",
        "collection": "zwave-nodes",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 1510,
        "y": 900,
        "wires": []
    },
    {
        "id": "7530bc9a.b2cea4",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "remove from db",
        "func": "if(msg.removeAll) {\n    msg.payload = {};\n} else if(msg.payload.nodeid != null) {\n    msg.payload = {nodeid: msg.payload.nodeid};\n} else {\n    return;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1280,
        "y": 900,
        "wires": [
            [
                "ab8ae39e.6f9308"
            ]
        ]
    },
    {
        "id": "f887be80.ae7bf8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "e92b9183.e79788"
        ],
        "x": 255,
        "y": 780,
        "wires": []
    },
    {
        "id": "288edf7f.d72758",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "e92b9183.e79788"
        ],
        "x": 475,
        "y": 420,
        "wires": []
    },
    {
        "id": "706467b2.a9a4f8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "e92b9183.e79788"
        ],
        "x": 555,
        "y": 320,
        "wires": []
    },
    {
        "id": "88b9f723.c66ac",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "set ready",
        "links": [
            "2f4ee6ab.e6b99a",
            "b7161ce7.5d30a8"
        ],
        "x": 1140,
        "y": 980,
        "wires": [
            [
                "d0b46be0.b162a"
            ]
        ]
    },
    {
        "id": "2f4ee6ab.e6b99a",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "88b9f723.c66ac"
        ],
        "x": 435,
        "y": 360,
        "wires": []
    },
    {
        "id": "b7161ce7.5d30a8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "88b9f723.c66ac"
        ],
        "x": 655,
        "y": 40,
        "wires": []
    },
    {
        "id": "34592a68.ac045e",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "6768cdd2.12ab7c",
            "82cc3504.c1f368"
        ],
        "x": 935,
        "y": 240,
        "wires": []
    },
    {
        "id": "fb00c0a.48d294",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "update value",
        "func": "msg.query = {\n        nodeid: msg.payload.nodeid,\n        values: { \n            $elemMatch:{\n                value_id: msg.payload.value.value_id\n            }\n        }\n};\n\nmsg.payload = {\n    'values.$.value': msg.payload.value.value\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 200,
        "wires": [
            [
                "2db35d73.983ca2"
            ]
        ]
    },
    {
        "id": "88263b2e.992b8",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "compile node",
        "func": "var obj = msg.payload;\n\nvar nodeId = 'node_' + obj.nodeid;\n\nvar nodeZ = context.get(nodeId);\nif(!nodeZ) {\n    nodeZ = {values:[]};\n}\n\nnodeZ.nodeid = obj.nodeid;\n\nif(obj.value) {\n    nodeZ.values.push(obj.value);\n}\n\nif(obj.nodeinfo) {\n    nodeZ.info = obj.nodeinfo;\n    node.send({payload: nodeZ});\n    context.set(nodeId, null);\n} else {\n    context.set(nodeId, nodeZ)\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 860,
        "y": 80,
        "wires": [
            [
                "26a92d3d.be7f0a"
            ]
        ]
    },
    {
        "id": "745bb339.087274",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "bca677d3.c0ceb"
        ],
        "x": 1795,
        "y": 20,
        "wires": []
    },
    {
        "id": "8369ccd4.cdde6",
        "type": "http request",
        "z": "a811a2d2.521d38",
        "name": "request work calendar",
        "method": "GET",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://data.gov.ru/api/json/dataset/7708660670-proizvcalendar/version/20151123T183036/content?access_token=YOUR_TOKEN_GOES_HERE",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "x": 380,
        "y": 900,
        "wires": [
            [
                "6c980029.184e3"
            ]
        ]
    },
    {
        "id": "6c980029.184e3",
        "type": "json",
        "z": "a811a2d2.521d38",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 570,
        "y": 900,
        "wires": [
            [
                "621424b1.7b005c"
            ]
        ]
    },
    {
        "id": "621424b1.7b005c",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "get this and next year",
        "func": "const thisYear = new Date().getFullYear();\n\nconst nextAndThisYear = msg.payload.filter(x=>{\n    return x[\"Год/Месяц\"] === thisYear.toString() || x[\"Год/Месяц\"] === (thisYear + 1).toString();\n})\nconst newMsg = {payload: nextAndThisYear};\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 900,
        "wires": [
            [
                "22d11886.3aebf"
            ]
        ]
    },
    {
        "id": "22d11886.3aebf",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "transform",
        "func": "const documents = [];\n\nmsg.payload.forEach(x=>{\n    const yearDocument = [];\n    \n    yearDocument[0] = x[\"Январь\"].split(',');\n    yearDocument[1] = x[\"Февраль\"].split(',');\n    yearDocument[2] = x[\"Март\"].split(',');\n    yearDocument[3] = x[\"Апрель\"].split(',');\n    yearDocument[4] = x[\"Май\"].split(',');\n    yearDocument[5] = x[\"Июнь\"].split(',');\n    yearDocument[6] = x[\"Июль\"].split(',');\n    yearDocument[7] = x[\"Август\"].split(',');\n    yearDocument[8] = x[\"Сентябрь\"].split(',');\n    yearDocument[9] = x[\"Октябрь\"].split(',');\n    yearDocument[10] = x[\"Ноябрь\"].split(',');\n    yearDocument[11] = x[\"Декабрь\"].split(',');\n    \n    documents.push(yearDocument);\n});\n\nmsg.payload = documents;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 900,
        "wires": [
            [
                "aae5e1c3.cf195"
            ]
        ]
    },
    {
        "id": "aae5e1c3.cf195",
        "type": "split",
        "z": "a811a2d2.521d38",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1210,
        "y": 900,
        "wires": [
            [
                "4a6b27d4.a96238"
            ]
        ]
    },
    {
        "id": "4a6b27d4.a96238",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "transform for db",
        "func": "const newMsg = {};\nconst thisYear = new Date().getFullYear();\n\nnewMsg.payload = {\n    year: msg.parts.index === 0 ? thisYear : thisYear + 1,\n    monthes: msg.payload\n}\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1380,
        "y": 900,
        "wires": [
            [
                "c15c8a26.0a871"
            ]
        ]
    },
    {
        "id": "c15c8a26.0a871",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "set ready to save",
        "func": "const $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {year:msg.payload.year}};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1590,
        "y": 900,
        "wires": [
            [
                "8e86471d.10ad1"
            ]
        ]
    },
    {
        "id": "8e86471d.10ad1",
        "type": "mongodb out",
        "z": "a811a2d2.521d38",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save to db",
        "collection": "work-calendar",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1790,
        "y": 900,
        "wires": []
    },
    {
        "id": "dcab36fd.cd0d38",
        "type": "function",
        "z": "b21069c1.94ff18",
        "name": "transform for db",
        "func": "msg.originalPayload = msg.payload ? msg.payload : {};\nconst thisYear = new Date().getFullYear();\n\nmsg.payload = {\n    year: thisYear\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 80,
        "wires": [
            [
                "c1279311.8fec98"
            ]
        ]
    },
    {
        "id": "c1279311.8fec98",
        "type": "mongodb in",
        "z": "b21069c1.94ff18",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get this year",
        "collection": "work-calendar",
        "operation": "find",
        "x": 410,
        "y": 80,
        "wires": [
            [
                "5d34bf68.a9e8"
            ]
        ]
    },
    {
        "id": "5d34bf68.a9e8",
        "type": "function",
        "z": "b21069c1.94ff18",
        "name": "check if weekend",
        "func": "const today = new Date();\nconst day = today.getDay();\nconst date = today.getDate();\nconst month = today.getMonth();\nconst year = today.getFullYear();\n\nconst thisYear = msg.payload[0];\n\nif(!thisYear) return;\n\nconst thisMonth = thisYear.monthes[month];\n\nconst isWeekend = (day === 6) || (day === 0);\n\n msg.payload = msg.originalPayload;\n\nif(isWeekend) {\n    const checkDay = date + '*';\n    if(thisMonth.some(x=>x===checkDay)) {\n        return [null, msg];\n    }\n}\n\n if(!thisMonth.some(x=>x===date.toString() || x === date + '+')) {\n     return [null, msg];\n }\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "x": 630,
        "y": 80,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "5061b92b.b8eab",
        "type": "cron scheduler",
        "z": "a811a2d2.521d38",
        "name": "",
        "schedule": "0 0 0 1 SEP *",
        "x": 160,
        "y": 900,
        "wires": [
            [
                "8369ccd4.cdde6"
            ]
        ]
    },
    {
        "id": "a5f15f6d.dd34f8",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "zwave out out",
        "links": [
            "5a278a31.08e13c",
            "85854dfa.f88b28"
        ],
        "x": 1375,
        "y": 700,
        "wires": []
    },
    {
        "id": "81ae198a.5d22",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get associations",
        "func": "msg.originalPayload = msg.payload;\nmsg.topic = 'getNumGroups';\nmsg.nodeid = msg.payload.nodeid;\nmsg.payload = {args: [msg.payload.nodeid]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 80,
        "wires": [
            [
                "223ecc12.68bbdc"
            ]
        ]
    },
    {
        "id": "223ecc12.68bbdc",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 1595,
        "y": 80,
        "wires": []
    },
    {
        "id": "5a278a31.08e13c",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "a5f15f6d.dd34f8"
        ],
        "x": 1375,
        "y": 240,
        "wires": [
            [
                "6e9a2d3c.5f51c4"
            ]
        ]
    },
    {
        "id": "42dbe973.45b5d",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "associations finish",
        "links": [
            "af289c4c.bca118"
        ],
        "x": 2055,
        "y": 120,
        "wires": []
    },
    {
        "id": "d1ccfab5.84cce8",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "process associations",
        "func": "if(!msg.payload.result) \n{\n    msg.payload = msg.originalPayload;\n    return [msg, null, null, null];\n}\n\n\nconst groupLabelMsg = {topic: 'getGroupLabel', originalPayload: msg.originalPayload, payload: []};\nconst associationsMsg =  {topic: 'getAssociations', originalPayload: msg.originalPayload, payload: []};\nconst maxAssociationsMsg =  {topic: 'getMaxAssociations', originalPayload: msg.originalPayload, payload: []};\n\nfor(let i = 1; i <= msg.payload.result; i++) {\n    groupLabelMsg.payload.push({args: [msg.payload.args[0], i]});\n    associationsMsg.payload.push({args: [msg.payload.args[0], i]});\n    maxAssociationsMsg.payload.push({args: [msg.payload.args[0], i]});\n}\n\n\n\nreturn [null, groupLabelMsg, associationsMsg, maxAssociationsMsg];",
        "outputs": 4,
        "noerr": 0,
        "x": 1800,
        "y": 240,
        "wires": [
            [
                "42dbe973.45b5d"
            ],
            [
                "231e56c0.47cf02"
            ],
            [
                "231e56c0.47cf02"
            ],
            [
                "231e56c0.47cf02"
            ]
        ]
    },
    {
        "id": "5392355b.ac6594",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "compile associations",
        "func": "const nodeid = msg.nodeid;\nlet originalPayload = context.get('associations_'+nodeid);\nlet topicsCount = context.get('topics_'+nodeid);\n\nif(!originalPayload) {\n    originalPayload = msg.originalPayload;\n    originalPayload.associations = [];\n}\n\nif(!topicsCount) {\n    topicsCount = 0;\n}\n\nswitch(msg.topic) {\n    case 'getGroupLabel':\n    {   \n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].name = msg.payload.result;\n        break;\n    }\n    case 'getAssociations': \n    {\n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].associations = msg.payload.result;\n        break;\n    }\n    case 'getMaxAssociations': \n    {\n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].max = msg.payload.result;\n        break;\n    }\n    default:\n    return;\n}\n\ncontext.set('associations_'+nodeid, originalPayload);\ncontext.set('topics_'+nodeid, topicsCount);\n\nif(topicsCount === msg.parts.count * 3) {\n    context.set('associations_'+nodeid, undefined);\n    context.set('topics_'+nodeid, undefined);\n    msg.payload = originalPayload;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1800,
        "y": 140,
        "wires": [
            [
                "42dbe973.45b5d"
            ]
        ]
    },
    {
        "id": "2035c52d.a9ea42",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 2195,
        "y": 240,
        "wires": []
    },
    {
        "id": "231e56c0.47cf02",
        "type": "split",
        "z": "7d373be5.bb59d4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2070,
        "y": 240,
        "wires": [
            [
                "2035c52d.a9ea42"
            ]
        ]
    },
    {
        "id": "af289c4c.bca118",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "42dbe973.45b5d"
        ],
        "x": 1635,
        "y": 40,
        "wires": [
            [
                "78e8c927.60be58",
                "745bb339.087274"
            ]
        ]
    },
    {
        "id": "6e9a2d3c.5f51c4",
        "type": "switch",
        "z": "7d373be5.bb59d4",
        "name": "switch association topics",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getGroupLabel",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getAssociations",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getMaxAssociations",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getNumGroups",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1550,
        "y": 220,
        "wires": [
            [
                "5392355b.ac6594"
            ],
            [
                "5392355b.ac6594"
            ],
            [
                "5392355b.ac6594"
            ],
            [
                "d1ccfab5.84cce8"
            ]
        ]
    },
    {
        "id": "fa7d9ca6.cb677",
        "type": "telegram sender",
        "z": "ca5dcdbd.466ec",
        "name": "Send message",
        "bot": "95efe3a3.9ad27",
        "x": 920,
        "y": 140,
        "wires": [
            [
                "2cc9941b.10595c"
            ]
        ]
    },
    {
        "id": "2db35d73.983ca2",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "6768cdd2.12ab7c",
            "82cc3504.c1f368"
        ],
        "x": 855,
        "y": 200,
        "wires": []
    },
    {
        "id": "26a92d3d.be7f0a",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "check db",
        "func": "msg.originalPayload = msg.payload;\nmsg.payload = {nodeid: msg.originalPayload.nodeid};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 80,
        "wires": [
            [
                "543a9288.9fee7c"
            ]
        ]
    },
    {
        "id": "543a9288.9fee7c",
        "type": "mongodb in",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find in db",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 1160,
        "y": 80,
        "wires": [
            [
                "9081cd0.47548b"
            ]
        ]
    },
    {
        "id": "9081cd0.47548b",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "filter if exists",
        "func": "if(msg.payload.length > 0 && msg.payload[0]) return;\n\nmsg.payload = msg.originalPayload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 80,
        "wires": [
            [
                "81ae198a.5d22"
            ]
        ]
    },
    {
        "id": "6e9bc0a7.6b99e8",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "name changed",
        "func": "const newMsg = {};\nnewMsg.topic = '/zwave/namechange/response';\nnewMsg.payload = msg.payload;\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 1120,
        "wires": [
            [
                "1de251d8.bc9a86"
            ]
        ]
    },
    {
        "id": "1de251d8.bc9a86",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 495,
        "y": 1120,
        "wires": []
    },
    {
        "id": "1c06f6c4.c6add1",
        "type": "telegram event",
        "z": "ca5dcdbd.466ec",
        "name": "Callback",
        "bot": "95efe3a3.9ad27",
        "event": "callback_query",
        "autoanswer": false,
        "x": 900,
        "y": 200,
        "wires": [
            [
                "1e49b59a.72a71a"
            ]
        ]
    },
    {
        "id": "eaaecf9a.63f33",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "transform",
        "func": "const content = msg.cachedPayload.content;\nconst incomeOpts =  msg.cachedPayload.telegramOpts;\n\ndelete msg.cachedPayload.content;\ndelete msg.cachedPayload.telegramOpts;\n\nconst newPayload = {};\n\nconst opts = incomeOpts ? incomeOpts : {\n    reply_markup: JSON.stringify({\n        \"inline_keyboard\": [[{\n            \"text\": \"Ok\",\n            \"callback_data\": 'Ok'\n        },\n        {\n            \"text\": \"Cancel\",\n            \"callback_data\": 'Cancel'\n        }]]\n    })\n}\n\n\nnewPayload.type = 'message';\nnewPayload.chatId = 'chat_id';\nnewPayload.content = content;\nnewPayload.options = opts;\n\nmsg.payload = newPayload;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 180,
        "wires": [
            [
                "fa7d9ca6.cb677"
            ]
        ]
    },
    {
        "id": "2cc9941b.10595c",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "save msg id",
        "func": "let msgId = flow.get('msgId');\nlet originalMsg = flow.get('original');\n\nmsgId = msg.payload.sentMessageId;\noriginalMsg = msg.cachedPayload;\n\nflow.set('msgId', msgId);\nflow.set('original', originalMsg);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 140,
        "wires": [
            [
                "e484cb33.69b4e"
            ]
        ]
    },
    {
        "id": "1e49b59a.72a71a",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "check callback",
        "func": "const msgId = flow.get('msgId');\nif(msgId !== msg.payload.messageId) return;\n\nconst originalMsg = flow.get('original');\n\nmsg.cachedPayload = originalMsg;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 200,
        "wires": [
            [
                "e889b4b6.830838",
                "69a0e286.635c3c",
                "e375e8ae.86b3c8"
            ]
        ]
    },
    {
        "id": "e484cb33.69b4e",
        "type": "stoptimer",
        "z": "ca5dcdbd.466ec",
        "duration": "4",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "delay",
        "x": 1550,
        "y": 140,
        "wires": [
            [
                "69a0e286.635c3c",
                "d2446acb.576c48"
            ],
            []
        ]
    },
    {
        "id": "e889b4b6.830838",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "cancel delay",
        "func": "const newMsg = {payload: 'stop'};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1330,
        "y": 200,
        "wires": [
            [
                "e484cb33.69b4e"
            ]
        ]
    },
    {
        "id": "69a0e286.635c3c",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "update msg",
        "func": "const newMsg = {payload: {}};\nnewMsg.payload.type = 'editMessageText';\nconst messageId =  msg.payload.sentMessageId ?  msg.payload.sentMessageId :  msg.payload.messageId;\nconst isCallbackMsg = !msg.payload.sentMessageId;\nlet contentText = msg.payload.sentMessageId ? msg.payload.content.text : msg.originalMessage.message.text;\n\ncontentText = `${contentText} - ${isCallbackMsg && msg.payload.content === 'Cancel' ? 'Отменено' : 'Выполнено'}`;\n\nnewMsg.payload.chatId = 'chat_id';\nnewMsg.payload.content = contentText;\n\nnewMsg.payload.options = {\n    chat_id : newMsg.payload.chatId,\n    message_id : messageId\n};  \n\nflow.set('msgId', undefined);\nflow.set('original', undefined);\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1410,
        "y": 80,
        "wires": [
            [
                "1933d013.e1f178"
            ]
        ]
    },
    {
        "id": "1933d013.e1f178",
        "type": "telegram sender",
        "z": "ca5dcdbd.466ec",
        "name": "update",
        "bot": "95efe3a3.9ad27",
        "x": 1660,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "e375e8ae.86b3c8",
        "type": "switch",
        "z": "ca5dcdbd.466ec",
        "name": "select",
        "property": "payload.content",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Ok",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Cancel",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1310,
        "y": 260,
        "wires": [
            [
                "d2446acb.576c48"
            ],
            [
                "330c13f3.7e5744"
            ],
            []
        ]
    },
    {
        "id": "d2446acb.576c48",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "Ok result",
        "func": "msg.payload = msg.cachedPayload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "330c13f3.7e5744",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "Cancel result",
        "func": "msg.payload = msg.cachedPayload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1530,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "bbb18d6e.4a40e8",
        "type": "cron scheduler",
        "z": "f0ffdbb3.6e78b",
        "name": "night on",
        "schedule": "0 5 23 * * *",
        "x": 360,
        "y": 120,
        "wires": [
            [
                "2d4e441.ed95a3c"
            ]
        ]
    },
    {
        "id": "a6521cc5.37dfe8",
        "type": "mqtt out dynamic",
        "z": "f0ffdbb3.6e78b",
        "name": "set temp",
        "topic": "/ventilation/settemperature/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 220,
        "y": 840,
        "wires": []
    },
    {
        "id": "b095417d.3e2a68",
        "type": "mqtt out dynamic",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan",
        "topic": "/ventilation/setfanspeed/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 210,
        "y": 900,
        "wires": []
    },
    {
        "id": "6a46d231.96d4ec",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan speed",
        "func": "return {\n    payload: 30\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1400,
        "y": 120,
        "wires": [
            [
                "76b628db.419d3"
            ]
        ]
    },
    {
        "id": "8279f0a.7d2a51",
        "type": "cron scheduler",
        "z": "f0ffdbb3.6e78b",
        "name": "normal mode",
        "schedule": "0 55 6 * * *",
        "x": 870,
        "y": 300,
        "wires": [
            [
                "31ed2d2a.511d32"
            ]
        ]
    },
    {
        "id": "76b628db.419d3",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "25cbd97a.b4528e"
        ],
        "x": 1555,
        "y": 120,
        "wires": []
    },
    {
        "id": "2ecf0fc.5ff40f",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "temp",
        "links": [
            "ca56910d.9de1a",
            "5dfd907.be78a7",
            "33989e98.a04d3a",
            "6d67075b.8367e",
            "1de16f1a.7ad481"
        ],
        "x": 100,
        "y": 840,
        "wires": [
            [
                "a6521cc5.37dfe8"
            ]
        ]
    },
    {
        "id": "20e2ba10.720b96",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "fan",
        "links": [
            "e2ebb84f.bd6d3",
            "ee9e6fa6.0512c8"
        ],
        "x": 100,
        "y": 900,
        "wires": [
            [
                "b095417d.3e2a68"
            ]
        ]
    },
    {
        "id": "a3a68845.f6549",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan speed",
        "func": "return {\n    payload: 20\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1680,
        "y": 300,
        "wires": [
            [
                "bbe6488b.7cf158"
            ]
        ]
    },
    {
        "id": "bbe6488b.7cf158",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "25cbd97a.b4528e"
        ],
        "x": 1815,
        "y": 300,
        "wires": []
    },
    {
        "id": "3aaa352e.bc70fa",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan speed",
        "func": "return {\n    payload: 10\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1280,
        "y": 400,
        "wires": [
            [
                "41947528.2aa4ec"
            ]
        ]
    },
    {
        "id": "41947528.2aa4ec",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "25cbd97a.b4528e"
        ],
        "x": 1395,
        "y": 400,
        "wires": []
    },
    {
        "id": "f9625549.00c1e8",
        "type": "cron scheduler",
        "z": "d849a1af.eac2a8",
        "name": "night on",
        "schedule": "0 0 23 * * *",
        "x": 140,
        "y": 120,
        "wires": [
            [
                "584057eb.7ca47"
            ]
        ]
    },
    {
        "id": "25dd4a4e.663f36",
        "type": "mqtt out dynamic",
        "z": "d849a1af.eac2a8",
        "name": "set temp",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 960,
        "y": 40,
        "wires": []
    },
    {
        "id": "584057eb.7ca47",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "disable",
        "func": "const value = {\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nmsg.payload = [13, 18, 23].map(x=> \n({value: {...value, node_id: x}}));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 120,
        "wires": [
            [
                "34394166.6852ae"
            ]
        ]
    },
    {
        "id": "7b0e3472.3d2594",
        "type": "cron scheduler",
        "z": "d849a1af.eac2a8",
        "name": "normal mode (weekday)",
        "schedule": "0 30 6 * * *",
        "x": 190,
        "y": 420,
        "wires": [
            [
                "12571d66.97bba3"
            ]
        ]
    },
    {
        "id": "2bf814c2.6a22a4",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "dbd4ae03.f94db",
            "c0382aa6.c634b"
        ],
        "x": 875,
        "y": 180,
        "wires": []
    },
    {
        "id": "dbd4ae03.f94db",
        "type": "link in",
        "z": "d849a1af.eac2a8",
        "name": "temp",
        "links": [
            "2bf814c2.6a22a4",
            "54198a37.e521ec",
            "63b0ecbd.d16a54",
            "6d67075b.8367e",
            "154382e4.e646fd",
            "d6ce6b98.ff2558",
            "90ed1e6e.3d1fb8",
            "f4a7fe6a.7b58c",
            "7d39247a.3785bc"
        ],
        "x": 840,
        "y": 40,
        "wires": [
            [
                "25dd4a4e.663f36"
            ]
        ]
    },
    {
        "id": "12571d66.97bba3",
        "type": "subflow:b21069c1.94ff18",
        "z": "d849a1af.eac2a8",
        "name": "",
        "x": 410,
        "y": 420,
        "wires": [
            [],
            [
                "354fa502.49b3ba"
            ]
        ]
    },
    {
        "id": "34394166.6852ae",
        "type": "split",
        "z": "d849a1af.eac2a8",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 660,
        "y": 120,
        "wires": [
            [
                "f7ef839b.957768"
            ]
        ]
    },
    {
        "id": "c8b81173.6c336",
        "type": "cron scheduler",
        "z": "d849a1af.eac2a8",
        "name": "normal mode (weekend)",
        "schedule": "0 30 8 * * *",
        "x": 190,
        "y": 480,
        "wires": [
            [
                "52f59893.f5c44"
            ]
        ]
    },
    {
        "id": "52f59893.f5c44",
        "type": "subflow:b21069c1.94ff18",
        "z": "d849a1af.eac2a8",
        "name": "",
        "x": 410,
        "y": 480,
        "wires": [
            [
                "354fa502.49b3ba"
            ],
            []
        ]
    },
    {
        "id": "308f38ea.e2b8c8",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "enable",
        "func": "const value = {\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Energy Heat'\n    };\n\nmsg.payload = [13, 18, 23].map(x=> \n({value: {...value, node_id: x}}));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 400,
        "wires": [
            [
                "42c852de.e04e7c"
            ]
        ]
    },
    {
        "id": "154382e4.e646fd",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "dbd4ae03.f94db",
            "c0382aa6.c634b"
        ],
        "x": 1435,
        "y": 400,
        "wires": []
    },
    {
        "id": "42c852de.e04e7c",
        "type": "split",
        "z": "d849a1af.eac2a8",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1150,
        "y": 400,
        "wires": [
            [
                "bd99b157.5a1278"
            ]
        ]
    },
    {
        "id": "3b6af9b6.b93c0e",
        "type": "mqtt out dynamic",
        "z": "db61ef7a.7e00d8",
        "name": "set position",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1330,
        "y": 80,
        "wires": []
    },
    {
        "id": "24024b7d.54181c",
        "type": "link in",
        "z": "db61ef7a.7e00d8",
        "name": "position",
        "links": [
            "aa97fab6.89f238",
            "bd28de78.992bb",
            "f575873e.765898",
            "7435aeb9.18f5",
            "65af83dc.349db4",
            "21afad17.e58f2a",
            "88ca2d04.6b1a18",
            "3f0b4999.8901b6",
            "d9503213.4c7f58",
            "d802fd19.de2c5",
            "9a66e68f.c6802",
            "177311de.a9acbe",
            "104ae36d.657df5",
            "94a2291.24efcd8",
            "676b4d6.fa7e334",
            "5f21fc7c.f9cbac",
            "abaf04c6.d83b18",
            "87038291.bad8a8",
            "ae9d158.c9552e8",
            "e17b3df1.e8b0b"
        ],
        "x": 1175,
        "y": 80,
        "wires": [
            [
                "3b6af9b6.b93c0e"
            ]
        ]
    },
    {
        "id": "d03d4428.d869a",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "close all",
        "func": "const value = {\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 0\n    };\n\nmsg.payload = [2, 11, 25].map(x=> \n({value: {...value, node_id: x}}));\n\nmsg.topic = undefined;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 60,
        "wires": [
            [
                "6dac52df.6cca54"
            ]
        ]
    },
    {
        "id": "6dac52df.6cca54",
        "type": "split",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 700,
        "y": 60,
        "wires": [
            [
                "aa97fab6.89f238"
            ]
        ]
    },
    {
        "id": "aa97fab6.89f238",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 835,
        "y": 60,
        "wires": []
    },
    {
        "id": "2ba22aef.2ac9de",
        "type": "subflow:b21069c1.94ff18",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "x": 270,
        "y": 240,
        "wires": [
            [],
            [
                "3ceda7ca.16b328"
            ]
        ]
    },
    {
        "id": "59f08601.47cba",
        "type": "cron scheduler",
        "z": "db61ef7a.7e00d8",
        "name": "weekday vika",
        "schedule": "0 50 6 * * *",
        "x": 100,
        "y": 240,
        "wires": [
            [
                "2ba22aef.2ac9de"
            ]
        ]
    },
    {
        "id": "a4585a5c.a462c8",
        "type": "subflow:ca5dcdbd.466ec",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 280,
        "wires": [
            [
                "bd28de78.992bb",
                "3ff232b7.5decf6"
            ],
            [],
            [
                "6c572a59.32d58c"
            ]
        ]
    },
    {
        "id": "48fe7fff.57ff58",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "set message",
        "func": "msg.payload.content = 'Поднять шторы?';\nmsg.payload.telegramOpts = {\n    reply_markup: JSON.stringify({\n        \"inline_keyboard\": [[{\n            \"text\": \"Открыть\",\n            \"callback_data\": 'Ok'\n        },\n        {\n            \"text\": \"Отмена\",\n            \"callback_data\": 'Cancel'\n        }], \n        [{\n            \"text\": \"Отложить на 30мин\",\n            \"callback_data\": 'Postpone'\n        }]]\n    })\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1510,
        "y": 280,
        "wires": [
            [
                "a4585a5c.a462c8"
            ]
        ]
    },
    {
        "id": "bd28de78.992bb",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 1895,
        "y": 220,
        "wires": []
    },
    {
        "id": "f575873e.765898",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 1495,
        "y": 360,
        "wires": []
    },
    {
        "id": "b196013.8bdcd",
        "type": "cron scheduler",
        "z": "db61ef7a.7e00d8",
        "name": "weekend",
        "schedule": "0 0 11 * * *",
        "x": 100,
        "y": 360,
        "wires": [
            [
                "b23d6c37.60407"
            ]
        ]
    },
    {
        "id": "b23d6c37.60407",
        "type": "subflow:b21069c1.94ff18",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "x": 290,
        "y": 360,
        "wires": [
            [
                "8151b9f0.adcad"
            ],
            []
        ]
    },
    {
        "id": "6c572a59.32d58c",
        "type": "delay",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "pauseType": "delay",
        "timeout": "30",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1910,
        "y": 280,
        "wires": [
            [
                "48fe7fff.57ff58"
            ]
        ]
    },
    {
        "id": "670357ab.50305",
        "type": "mqtt in dynamic",
        "z": "ed3957ea.447518",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "get zwave params",
        "broker": "7c5f5dec.00cb4c",
        "x": 160,
        "y": 360,
        "wires": [
            [
                "e8d6ceb6.4ff26"
            ]
        ]
    },
    {
        "id": "e8d6ceb6.4ff26",
        "type": "switch",
        "z": "ed3957ea.447518",
        "name": "is enter sensor?",
        "property": "payload.node_id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "36",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 400,
        "y": 340,
        "wires": [
            [
                "bba3cc49.9f7a68"
            ],
            [
                "8baeef4a.652b9"
            ]
        ]
    },
    {
        "id": "8baeef4a.652b9",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "is motion?",
        "func": "if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 10) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 420,
        "wires": [
            [
                "ce0285b1.7fcd7"
            ]
        ]
    },
    {
        "id": "ee689204.2ffbe",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "save door",
        "func": "let data = global.get('door');\n\nif(data == null) {\n    data = {};\n}\n\n\ndata.value = msg.payload.value;\n\nconst now = new Date();\n\nif(data.value) {\n    data.lastOpenDate = now;\n} else {\n     data.lastCloseDate = now;\n}\n\ndata.statusChanged = now;\n\nglobal.set('door', data);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 360,
        "wires": [
            [
                "ee341a48.de7bc"
            ]
        ]
    },
    {
        "id": "bba3cc49.9f7a68",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "is enter?",
        "func": "if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 360,
        "wires": [
            [
                "ee689204.2ffbe"
            ]
        ]
    },
    {
        "id": "ce0285b1.7fcd7",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "save motion",
        "func": "const id = `motion_${msg.payload.node_id}`;\nlet data = global.get(id);\n\nif(!data) {\n    data = {};\n}\n\nconst now = new Date();\n\nif(msg.payload.value === 8) {\n    data.lastMotion = now;\n}\n\ndata.lastChange = now;\ndata.value = msg.payload.value === 8;\n\nglobal.set(id, data);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 420,
        "wires": [
            [
                "ee341a48.de7bc"
            ]
        ]
    },
    {
        "id": "ee341a48.de7bc",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "save presence and report",
        "func": "let presence = global.get('presence');\nconst vacation = global.get('vacation');\n\nconst ble = flow.get('BLE');\nconst doorSensor = global.get('door');\nconst motionSensors = [15, 29, 31, 33, 47, 48]\n        .map(x=>global.get(`motion_${x}`)).filter(x=>x != null);\n\nif(!presence && (ble || (doorSensor && doorSensor.value) || motionSensors.some(x=>x.value))) {\n    global.set('presence', true);\n    global.set('vacation', false);\n    flow.set('awayPending', false);\n    \n    return [{payload: {presence: true}}, null, null];\n}\n\nconst pending = flow.get('awayPending');\nif(pending && presence)\n{\n    flow.set('awayPending', false);\n    return [null, null, {payload: 'stop'}];\n}\n\n\nif(!pending && doorSensor && !vacation && presence && !ble && motionSensors.every(x=>!x.value)) {\n    const last = motionSensors.sort((a,b) => b.lastMotion - a.lastMotion)[0];\n    const doorClosedPeriod = doorSensor.lastCloseDate - doorSensor.lastOpenDate;\n    if(last.lastMotion <= doorSensor.lastCloseDate && doorClosedPeriod <= (60000 * 5)) {\n            flow.set('awayPending', true);\n            return [null, {payload: {presence: false}}, null];\n    }\n}\n\nreturn;",
        "outputs": 3,
        "noerr": 0,
        "x": 1530,
        "y": 300,
        "wires": [
            [
                "b21cb511.259fc8",
                "22ede951.0ff406"
            ],
            [
                "bfecb15d.cd9c78"
            ],
            [
                "22ede951.0ff406"
            ]
        ]
    },
    {
        "id": "682993d4.ccf554",
        "type": "subflow:ca5dcdbd.466ec",
        "z": "ed3957ea.447518",
        "name": "",
        "env": [],
        "x": 2030,
        "y": 380,
        "wires": [
            [
                "14729ac3.813735"
            ],
            [],
            []
        ]
    },
    {
        "id": "14729ac3.813735",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "all out",
        "func": "global.set('presence', false);\nflow.set('awayPending', false);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2290,
        "y": 360,
        "wires": [
            [
                "b21cb511.259fc8"
            ]
        ]
    },
    {
        "id": "b21cb511.259fc8",
        "type": "mqtt out dynamic",
        "z": "ed3957ea.447518",
        "name": "presence",
        "topic": "/system/presence",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 2480,
        "y": 300,
        "wires": []
    },
    {
        "id": "bfecb15d.cd9c78",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "set message",
        "func": "msg.payload.content = 'Похоже я остался один. Перехожу в режим \"Вне дома\"?';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1700,
        "y": 380,
        "wires": [
            [
                "307c123c.f4c466"
            ]
        ]
    },
    {
        "id": "85bdee81.3f0438",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "cancel msgs",
        "func": "const newMsg = {payload: {}};\n\nconst msgId = flow.get('msgId');\n\nflow.set('msgId', undefined);\nflow.set('original', undefined);\n\nif(msgId) {\n    const payload = {};\n    payload.type = 'deleteMessage';\n\n    payload.chatId = 'chat_id';\n    payload.content = msgId;\n\n    payload.options = {\n        chat_id : payload.chatId,\n        message_id : msgId\n    }; \n        \n    newMsg.payload = payload;\n    \n    return newMsg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1410,
        "y": 40,
        "wires": [
            [
                "1933d013.e1f178"
            ]
        ]
    },
    {
        "id": "158261d9.4db52e",
        "type": "switch",
        "z": "ca5dcdbd.466ec",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "stop",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 170,
        "y": 60,
        "wires": [
            [
                "85bdee81.3f0438",
                "e889b4b6.830838"
            ],
            [
                "ef659726.ce1b08"
            ]
        ]
    },
    {
        "id": "50a7e4a7.15003c",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "no one home",
        "func": "if(msg.payload.presence === false || msg.payload.vacation) {\n    return {payload:{}};\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 60,
        "wires": [
            [
                "584057eb.7ca47"
            ]
        ]
    },
    {
        "id": "6e00b629.c36a88",
        "type": "mqtt in dynamic",
        "z": "d849a1af.eac2a8",
        "topic": "/system/presence",
        "qos": "1",
        "name": "presence event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1280,
        "y": 120,
        "wires": [
            [
                "8999ac39.24b5"
            ]
        ]
    },
    {
        "id": "8999ac39.24b5",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "presence in",
        "links": [
            "edad228a.aa9de8",
            "a3173d3f.7d8318"
        ],
        "x": 1435,
        "y": 120,
        "wires": []
    },
    {
        "id": "edad228a.aa9de8",
        "type": "link in",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "8999ac39.24b5"
        ],
        "x": 160,
        "y": 60,
        "wires": [
            [
                "50a7e4a7.15003c"
            ]
        ]
    },
    {
        "id": "470e4795.c94db8",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "some one home",
        "func": "if(msg.payload.presence) {\n    return {payload:{}};\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 340,
        "wires": [
            [
                "939fdebf.ebb37"
            ]
        ]
    },
    {
        "id": "a3173d3f.7d8318",
        "type": "link in",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "8999ac39.24b5"
        ],
        "x": 90,
        "y": 340,
        "wires": [
            [
                "470e4795.c94db8"
            ]
        ]
    },
    {
        "id": "939fdebf.ebb37",
        "type": "subflow:b21069c1.94ff18",
        "z": "d849a1af.eac2a8",
        "name": "",
        "x": 410,
        "y": 340,
        "wires": [
            [
                "6f333f42.8fb308"
            ],
            [
                "677433c2.69108c"
            ]
        ]
    },
    {
        "id": "4eed4f34.1bcc08",
        "type": "mqtt in dynamic",
        "z": "f0ffdbb3.6e78b",
        "topic": "/system/presence",
        "qos": "1",
        "name": "presence event",
        "broker": "7c5f5dec.00cb4c",
        "x": 160,
        "y": 980,
        "wires": [
            [
                "5c0fdbb0.6000a4"
            ]
        ]
    },
    {
        "id": "5c0fdbb0.6000a4",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "presence in",
        "links": [
            "90d9da5b.d9e8e8",
            "65ed06e3.052908",
            "e34d343b.1892d8"
        ],
        "x": 315,
        "y": 980,
        "wires": []
    },
    {
        "id": "b6059720.4f74d8",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "no one home",
        "func": "if(msg.payload.presence === false) {\n    return {payload:{}};\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 400,
        "wires": [
            [
                "9c1596aa.10fe58"
            ]
        ]
    },
    {
        "id": "90d9da5b.d9e8e8",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "5c0fdbb0.6000a4"
        ],
        "x": 95,
        "y": 400,
        "wires": [
            [
                "b6059720.4f74d8"
            ]
        ]
    },
    {
        "id": "2c460791.5d7c9",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "some one home",
        "func": "if(msg.payload.presence) {\n    return {payload:{}};\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 180,
        "y": 220,
        "wires": [
            [
                "58749d0a.5c05b4"
            ]
        ]
    },
    {
        "id": "65ed06e3.052908",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "5c0fdbb0.6000a4"
        ],
        "x": 50,
        "y": 220,
        "wires": [
            [
                "2c460791.5d7c9"
            ]
        ]
    },
    {
        "id": "2d4e441.ed95a3c",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 120,
        "wires": [
            [
                "6a46d231.96d4ec"
            ]
        ]
    },
    {
        "id": "31ed2d2a.511d32",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return [msg, null];\n}\n\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1050,
        "y": 300,
        "wires": [
            [
                "a3a68845.f6549"
            ],
            [
                "c6a278dc.742928"
            ]
        ]
    },
    {
        "id": "8bfe42f7.10f2c8",
        "type": "time-range-switch",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "lat": "",
        "lon": "",
        "startTime": "23:05",
        "endTime": "06:55",
        "startOffset": 0,
        "endOffset": 0,
        "x": 1000,
        "y": 220,
        "wires": [
            [
                "6a46d231.96d4ec"
            ],
            [
                "a3a68845.f6549"
            ]
        ]
    },
    {
        "id": "6f333f42.8fb308",
        "type": "time-range-switch",
        "z": "d849a1af.eac2a8",
        "name": "",
        "lat": "",
        "lon": "",
        "startTime": "09:30",
        "endTime": "23:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 640,
        "y": 300,
        "wires": [
            [
                "308f38ea.e2b8c8"
            ],
            []
        ]
    },
    {
        "id": "677433c2.69108c",
        "type": "time-range-switch",
        "z": "d849a1af.eac2a8",
        "name": "",
        "lat": "",
        "lon": "",
        "startTime": "06:30",
        "endTime": "23:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 640,
        "y": 360,
        "wires": [
            [
                "308f38ea.e2b8c8"
            ],
            []
        ]
    },
    {
        "id": "9832d2f3.b34b68",
        "type": "telegram command",
        "z": "ed3957ea.447518",
        "name": "/away",
        "command": "/away@YOUR_BOT",
        "bot": "95efe3a3.9ad27",
        "strict": false,
        "x": 1950,
        "y": 500,
        "wires": [
            [
                "4f6d2472.22538c"
            ],
            []
        ]
    },
    {
        "id": "4f6d2472.22538c",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "transform away",
        "func": "global.set('vacation', false);\nreturn {payload: {\n    presence: false\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 2140,
        "y": 440,
        "wires": [
            [
                "14729ac3.813735",
                "f4c2304b.dcbf48"
            ]
        ]
    },
    {
        "id": "3ceda7ca.16b328",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 470,
        "y": 240,
        "wires": [
            [
                "27f58d31.4d21fa"
            ]
        ]
    },
    {
        "id": "354fa502.49b3ba",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 440,
        "wires": [
            [
                "308f38ea.e2b8c8"
            ]
        ]
    },
    {
        "id": "a2fab603.9cb1b",
        "type": "cron scheduler",
        "z": "d849a1af.eac2a8",
        "name": "bathroom (weekday)",
        "schedule": "0 30 8 * * *",
        "x": 180,
        "y": 200,
        "wires": [
            [
                "eae23178.234ae8"
            ]
        ]
    },
    {
        "id": "eae23178.234ae8",
        "type": "subflow:b21069c1.94ff18",
        "z": "d849a1af.eac2a8",
        "name": "",
        "x": 390,
        "y": 200,
        "wires": [
            [],
            [
                "4a9b406c.d909e"
            ]
        ]
    },
    {
        "id": "4a9b406c.d909e",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "disable",
        "func": "const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nmsg.payload = {value: value};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 560,
        "y": 200,
        "wires": [
            [
                "f7ef839b.957768"
            ]
        ]
    },
    {
        "id": "1f8d9bac.0cd47c",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "cancel msgs",
        "func": "const msgId = flow.get('msgId');\n\nif(msgId) {\n    const payload = {};\n    payload.type = 'deleteMessage';\n\n    payload.chatId = 'chat_id';\n    payload.content = msgId;\n\n    payload.options = {\n        chat_id : payload.chatId,\n        message_id : msgId\n    }; \n        \n    msg.payload = payload;\n   \n    \n    flow.set('msgId', undefined);\n    flow.set('original', undefined);\n    \n     return [msg, null];\n}\n\n\n\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 350,
        "y": 140,
        "wires": [
            [
                "9a017bf6.1aa2c8"
            ],
            [
                "eaaecf9a.63f33"
            ]
        ]
    },
    {
        "id": "9a017bf6.1aa2c8",
        "type": "telegram sender",
        "z": "ca5dcdbd.466ec",
        "name": "remove",
        "bot": "95efe3a3.9ad27",
        "x": 520,
        "y": 120,
        "wires": [
            [
                "eaaecf9a.63f33"
            ]
        ]
    },
    {
        "id": "ef659726.ce1b08",
        "type": "function",
        "z": "ca5dcdbd.466ec",
        "name": "save payload",
        "func": "msg.cachedPayload = msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 140,
        "y": 140,
        "wires": [
            [
                "1f8d9bac.0cd47c"
            ]
        ]
    },
    {
        "id": "5e068c7f.b76f24",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "check zwave ready",
        "func": "if(flow.get('ready')) {\n   return [msg, null]; \n}\n\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 690,
        "y": 1180,
        "wires": [
            [
                "16dd1768.2be309"
            ],
            [
                "4050a07c.3d2c7"
            ]
        ]
    },
    {
        "id": "4050a07c.3d2c7",
        "type": "delay",
        "z": "7d373be5.bb59d4",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 920,
        "y": 1180,
        "wires": [
            [
                "5e068c7f.b76f24"
            ]
        ]
    },
    {
        "id": "22ede951.0ff406",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "stop confirm",
        "func": "msg.payload = 'stop';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1770,
        "y": 260,
        "wires": [
            [
                "682993d4.ccf554",
                "307c123c.f4c466"
            ]
        ]
    },
    {
        "id": "7cf8a62b.2455b",
        "type": "cron scheduler",
        "z": "ed3957ea.447518",
        "name": "every 24 h",
        "schedule": "0 0 0/24 * * *",
        "x": 110,
        "y": 560,
        "wires": [
            [
                "d46811a8.7bfc78"
            ]
        ]
    },
    {
        "id": "d46811a8.7bfc78",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "away or vacation",
        "func": "const presence = global.get('presence');\n\nconst motionSensors = [15, 16, 19, 29, 31, 33]\n        .map(x=>flow.get(`motion_${x}`)).filter(x=>x != null);\n\nconst last = motionSensors.sort((a,b) => a.lastMotion - b.lastMotion)[0];\n\nconst now = new Date();\n\nif((now - last) >= 86400000) {\n    if(presence) {\n        return [{},null];\n    } else {\n        return [null, {}];\n    }\n}\n",
        "outputs": 2,
        "noerr": 0,
        "x": 310,
        "y": 560,
        "wires": [
            [
                "baadde18.bb684"
            ],
            [
                "f20a4a79.5d8418"
            ]
        ]
    },
    {
        "id": "ac186129.bc8bf",
        "type": "link in",
        "z": "ed3957ea.447518",
        "name": "presence",
        "links": [
            "baadde18.bb684"
        ],
        "x": 1535,
        "y": 420,
        "wires": [
            [
                "bfecb15d.cd9c78"
            ]
        ]
    },
    {
        "id": "baadde18.bb684",
        "type": "link out",
        "z": "ed3957ea.447518",
        "name": "",
        "links": [
            "ac186129.bc8bf"
        ],
        "x": 455,
        "y": 520,
        "wires": []
    },
    {
        "id": "f20a4a79.5d8418",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "vacation",
        "func": "return {\n    payload: {\n        vacation: true,\n        content: 'Похоже вы в отпуске, ухожу в глубокий сон.'\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 600,
        "wires": [
            [
                "428b5150.8de9b"
            ]
        ]
    },
    {
        "id": "428b5150.8de9b",
        "type": "subflow:ca5dcdbd.466ec",
        "z": "ed3957ea.447518",
        "name": "",
        "env": [],
        "x": 690,
        "y": 600,
        "wires": [
            [
                "474655fa.eb1f9c"
            ],
            [],
            []
        ]
    },
    {
        "id": "89d1102f.c6a72",
        "type": "mqtt out dynamic",
        "z": "ed3957ea.447518",
        "name": "vacation",
        "topic": "/system/vacation",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1080,
        "y": 580,
        "wires": []
    },
    {
        "id": "7cc37be0.f277fc",
        "type": "telegram command",
        "z": "ed3957ea.447518",
        "name": "/vacation",
        "command": "/vacation@YOUR_BOT",
        "bot": "95efe3a3.9ad27",
        "strict": false,
        "x": 420,
        "y": 700,
        "wires": [
            [
                "d8b73680.18f4b"
            ],
            []
        ]
    },
    {
        "id": "d8b73680.18f4b",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "transform vacation",
        "func": "return {payload: {\n    vacation: true\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 700,
        "wires": [
            [
                "474655fa.eb1f9c"
            ]
        ]
    },
    {
        "id": "cb7d01b7.72efd8",
        "type": "mqtt in dynamic",
        "z": "d849a1af.eac2a8",
        "topic": "/system/vacation",
        "qos": "1",
        "name": "vacation event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1280,
        "y": 180,
        "wires": [
            [
                "8999ac39.24b5"
            ]
        ]
    },
    {
        "id": "3063a303.e35fe4",
        "type": "mqtt in dynamic",
        "z": "f0ffdbb3.6e78b",
        "topic": "/system/vacation",
        "qos": "1",
        "name": "vacation event",
        "broker": "7c5f5dec.00cb4c",
        "x": 160,
        "y": 1040,
        "wires": [
            [
                "5c0fdbb0.6000a4"
            ]
        ]
    },
    {
        "id": "474655fa.eb1f9c",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "set out",
        "func": "global.set('vacation', true);\nglobal.set('presence', false);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 900,
        "y": 600,
        "wires": [
            [
                "89d1102f.c6a72"
            ]
        ]
    },
    {
        "id": "a521e1ba.1b9808",
        "type": "mqtt in dynamic",
        "z": "db61ef7a.7e00d8",
        "topic": "/system/vacation",
        "qos": "1",
        "name": "vacation event",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 120,
        "wires": [
            [
                "966e0ada.3ac61"
            ]
        ]
    },
    {
        "id": "5bfe614e.115c9",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check night",
        "func": "if(msg.payload.night === false) return;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 60,
        "wires": [
            [
                "d03d4428.d869a"
            ]
        ]
    },
    {
        "id": "966e0ada.3ac61",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check vacation",
        "func": "if(!msg.payload.vacation) return;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 120,
        "wires": [
            [
                "d03d4428.d869a"
            ]
        ]
    },
    {
        "id": "e34d343b.1892d8",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "5c0fdbb0.6000a4"
        ],
        "x": 1175,
        "y": 560,
        "wires": [
            [
                "b6f546b7.af881"
            ]
        ]
    },
    {
        "id": "b6f546b7.af881",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "check vacation",
        "func": "if(msg.payload.vacation) {\n    return {\n        payload: {\n            value: 0\n        }\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1300,
        "y": 560,
        "wires": [
            [
                "e6bfa343.663fc"
            ]
        ]
    },
    {
        "id": "e6bfa343.663fc",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "a55e56f1.d3b8e8"
        ],
        "x": 1415,
        "y": 560,
        "wires": []
    },
    {
        "id": "a55e56f1.d3b8e8",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "power",
        "links": [
            "e6bfa343.663fc",
            "17c2d313.fa180d",
            "dd38b58.eba07c8",
            "6c184dc7.f0cd5c"
        ],
        "x": 95,
        "y": 780,
        "wires": [
            [
                "61e36d50.ec266c"
            ]
        ]
    },
    {
        "id": "61e36d50.ec266c",
        "type": "mqtt out dynamic",
        "z": "f0ffdbb3.6e78b",
        "name": "power",
        "topic": "/ventilation/setpower/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 205,
        "y": 780,
        "wires": []
    },
    {
        "id": "3ec777d9.83a33",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open vika",
        "func": "const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 200,
        "wires": [
            [
                "7435aeb9.18f5",
                "c169c1a.67fd24"
            ]
        ]
    },
    {
        "id": "b1fdf586.9d0eb8",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open livingroom",
        "func": "const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 280,
        "wires": [
            [
                "48fe7fff.57ff58"
            ]
        ]
    },
    {
        "id": "63950635.bacf78",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open kitchen",
        "func": "const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 360,
        "wires": [
            [
                "f575873e.765898"
            ]
        ]
    },
    {
        "id": "7435aeb9.18f5",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 1415,
        "y": 200,
        "wires": []
    },
    {
        "id": "27f58d31.4d21fa",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "vika override",
        "func": "if(!flow.get('vika_override'))\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 260,
        "wires": [
            [
                "99d5d340.b76878"
            ]
        ]
    },
    {
        "id": "e5e24dbc.9db6d8",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "living room override",
        "func": "if(!flow.get('livingroom_override'))\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 300,
        "wires": [
            [
                "83f1dbe.19919a8"
            ]
        ]
    },
    {
        "id": "3525eac3.d555be",
        "type": "telegram receiver",
        "z": "db61ef7a.7e00d8",
        "name": "all msgs",
        "bot": "95efe3a3.9ad27",
        "saveDataDir": "",
        "x": 100,
        "y": 500,
        "wires": [
            [
                "f1ce8d95.d89e6"
            ],
            []
        ]
    },
    {
        "id": "f1ce8d95.d89e6",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "parse message",
        "func": "const text = msg.payload.content.toLowerCase();\nif(text.startsWith('вика шторы')) {\n    const match = text.match(/(\\d{1,2}(:| )\\d{1,2})/);\n    if(match && match.length > 1) {\n        return [{payload: {\n            time: match[1]\n        }}, null];\n    }\n}\n\nif(text.startsWith('зал шторы')) {\n    const match = text.match(/(\\d{1,2}(:| )\\d{1,2})/);\n    if(match && match.length > 1) {\n        return [null, {payload: {\n            time: match[1]\n        }}];\n    }\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 280,
        "y": 500,
        "wires": [
            [
                "5c1607f7.84d0b"
            ],
            [
                "fc6f9bd8.8c82d"
            ]
        ]
    },
    {
        "id": "5c1607f7.84d0b",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "parse time",
        "func": "const split = msg.payload.time.split(/(:| )/).filter(x=>!Number.isNaN(Number(x))).map(x=>Number(x));\n\nif(split[0] < 0 || split[0] > 23) return;\nif(split[1] < 0 || split[1] > 59) return;\n\nflow.set('vika_override', true);\n\nreturn {\n    payload: {\n        schedule: `0 ${split[1]} ${split[0]} * * *`\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 470,
        "y": 460,
        "wires": [
            [
                "b607f737.84e678",
                "9db74a7d.59574"
            ]
        ]
    },
    {
        "id": "b607f737.84e678",
        "type": "cron scheduler",
        "z": "db61ef7a.7e00d8",
        "name": "vika scheduler",
        "schedule": "",
        "x": 680,
        "y": 460,
        "wires": [
            [
                "464a0332.2bfe5c",
                "99d5d340.b76878"
            ]
        ]
    },
    {
        "id": "464a0332.2bfe5c",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "cancel",
        "func": "flow.set('vika_override', false);\n\nreturn {\n    payload: {\n        cancel: true\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 460,
        "wires": [
            [
                "b607f737.84e678"
            ]
        ]
    },
    {
        "id": "fc6f9bd8.8c82d",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "parse time",
        "func": "const split = msg.payload.time.split(/(:| )/).filter(x=>!Number.isNaN(Number(x))).map(x=>Number(x));\n\nif(split[0] < 0 || split[0] > 23) return;\nif(split[1] < 0 || split[1] > 59) return;\n\nflow.set('livingroom_override', true);\n\nreturn {\n    payload: {\n        schedule: `0 ${split[1]} ${split[0]} * * *`\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 470,
        "y": 540,
        "wires": [
            [
                "343fc4e6.6f1fbc",
                "9db74a7d.59574"
            ]
        ]
    },
    {
        "id": "343fc4e6.6f1fbc",
        "type": "cron scheduler",
        "z": "db61ef7a.7e00d8",
        "name": "living room scheduler",
        "schedule": "",
        "x": 700,
        "y": 540,
        "wires": [
            [
                "1657fc2c.0e9ad4",
                "83f1dbe.19919a8"
            ]
        ]
    },
    {
        "id": "1657fc2c.0e9ad4",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "cancel",
        "func": "flow.set('livingroom_override', false);\n\nreturn {\n    payload: {\n        cancel: true\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 910,
        "y": 540,
        "wires": [
            [
                "343fc4e6.6f1fbc"
            ]
        ]
    },
    {
        "id": "92460e42.4b5ae",
        "type": "telegram sender",
        "z": "5b528460.e43bb4",
        "name": "msg",
        "bot": "95efe3a3.9ad27",
        "x": 340,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6857b825.816f88",
        "type": "function",
        "z": "5b528460.e43bb4",
        "name": "msg",
        "func": "const content = msg.payload.content;\n\nconst newPayload = {};\n\nnewPayload.type = 'message';\nnewPayload.chatId = 'chat_id';\nnewPayload.content = content;\n\nmsg.payload = newPayload;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 170,
        "y": 80,
        "wires": [
            [
                "92460e42.4b5ae"
            ]
        ]
    },
    {
        "id": "f84c8719.2acba8",
        "type": "subflow:5b528460.e43bb4",
        "z": "db61ef7a.7e00d8",
        "x": 890,
        "y": 640,
        "wires": []
    },
    {
        "id": "9db74a7d.59574",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "telegram transform",
        "func": "return {\n    payload: {\n        content: 'Действие подтверждено'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 640,
        "wires": [
            [
                "f84c8719.2acba8"
            ]
        ]
    },
    {
        "id": "1499e0d0.9fae07",
        "type": "function",
        "z": "ecf602b6.267b58",
        "name": "get ventilation",
        "func": "return {\n    payload: {\n        id: 1\n    },\n    cachedPayload: msg.payload\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 80,
        "wires": [
            [
                "362e4bc8.d8a824"
            ]
        ]
    },
    {
        "id": "362e4bc8.d8a824",
        "type": "mongodb in",
        "z": "ecf602b6.267b58",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find",
        "collection": "ventilation",
        "operation": "find",
        "x": 350,
        "y": 80,
        "wires": [
            [
                "a896c336.e48ac8"
            ]
        ]
    },
    {
        "id": "a896c336.e48ac8",
        "type": "function",
        "z": "ecf602b6.267b58",
        "name": "vent result",
        "func": "msg.payload = msg.payload[0];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "58749d0a.5c05b4",
        "type": "subflow:ecf602b6.267b58",
        "z": "f0ffdbb3.6e78b",
        "x": 400,
        "y": 220,
        "wires": [
            [
                "d1b7900d.3059a"
            ]
        ]
    },
    {
        "id": "d1b7900d.3059a",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "is enabled",
        "func": "if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];",
        "outputs": 2,
        "noerr": 0,
        "x": 630,
        "y": 220,
        "wires": [
            [
                "8bfe42f7.10f2c8"
            ],
            [
                "f5906360.3673f8"
            ]
        ]
    },
    {
        "id": "f5906360.3673f8",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "power on",
        "func": " return {\n        payload: {\n            value: 1\n        }\n    }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 620,
        "y": 280,
        "wires": [
            [
                "17c2d313.fa180d",
                "33af44da.921c94"
            ]
        ]
    },
    {
        "id": "17c2d313.fa180d",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "a55e56f1.d3b8e8"
        ],
        "x": 755,
        "y": 260,
        "wires": []
    },
    {
        "id": "33af44da.921c94",
        "type": "delay",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 620,
        "y": 340,
        "wires": [
            [
                "8bfe42f7.10f2c8"
            ]
        ]
    },
    {
        "id": "8a553660.f401c",
        "type": "delay",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 680,
        "y": 520,
        "wires": [
            [
                "3aaa352e.bc70fa"
            ]
        ]
    },
    {
        "id": "c4f0652e.9ed27",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "power on",
        "func": " return {\n        payload: {\n            value: 1\n        }\n    }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 460,
        "wires": [
            [
                "dd38b58.eba07c8",
                "8a553660.f401c"
            ]
        ]
    },
    {
        "id": "dd38b58.eba07c8",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "a55e56f1.d3b8e8"
        ],
        "x": 815,
        "y": 440,
        "wires": []
    },
    {
        "id": "bdee498b.0eaf2",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "is enabled",
        "func": "if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];",
        "outputs": 2,
        "noerr": 0,
        "x": 690,
        "y": 400,
        "wires": [
            [
                "3aaa352e.bc70fa"
            ],
            [
                "c4f0652e.9ed27"
            ]
        ]
    },
    {
        "id": "9c1596aa.10fe58",
        "type": "subflow:ecf602b6.267b58",
        "z": "f0ffdbb3.6e78b",
        "x": 460,
        "y": 400,
        "wires": [
            [
                "bdee498b.0eaf2"
            ]
        ]
    },
    {
        "id": "25cbd97a.b4528e",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan speed",
        "links": [
            "76b628db.419d3",
            "bbe6488b.7cf158",
            "41947528.2aa4ec",
            "d6cf47e4.bace18"
        ],
        "x": 1080,
        "y": 780,
        "wires": [
            [
                "44156f49.4bab4"
            ]
        ]
    },
    {
        "id": "44156f49.4bab4",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set fan speed",
        "func": "return {\n    payload: {\n        value: msg.payload\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1200,
        "y": 780,
        "wires": [
            [
                "e28acd34.b49ad",
                "ee9e6fa6.0512c8"
            ]
        ]
    },
    {
        "id": "e28acd34.b49ad",
        "type": "switch",
        "z": "f0ffdbb3.6e78b",
        "name": "select temperature",
        "property": "payload.value",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "30",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "20",
                "vt": "str"
            },
            {
                "t": "lt",
                "v": "20",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1430,
        "y": 780,
        "wires": [
            [
                "311ae829.aea86"
            ],
            [
                "11900476.40e50c"
            ],
            [
                "f4593128.7f3098"
            ]
        ]
    },
    {
        "id": "ee9e6fa6.0512c8",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "20e2ba10.720b96"
        ],
        "x": 1275,
        "y": 840,
        "wires": []
    },
    {
        "id": "311ae829.aea86",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set temperature",
        "func": "msg.payload = {};\nmsg.payload.value = 12;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1640,
        "y": 740,
        "wires": [
            [
                "1de16f1a.7ad481"
            ]
        ]
    },
    {
        "id": "11900476.40e50c",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set temperature",
        "func": "msg.payload = {};\nmsg.payload.value = 10;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1640,
        "y": 780,
        "wires": [
            [
                "1de16f1a.7ad481"
            ]
        ]
    },
    {
        "id": "f4593128.7f3098",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set temperature",
        "func": "msg.payload = {};\nmsg.payload.value = 5;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1640,
        "y": 820,
        "wires": [
            [
                "1de16f1a.7ad481"
            ]
        ]
    },
    {
        "id": "1de16f1a.7ad481",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "2ecf0fc.5ff40f"
        ],
        "x": 1795,
        "y": 780,
        "wires": []
    },
    {
        "id": "cd77ef2c.9e3268",
        "type": "function",
        "z": "60924caf.ca9954",
        "name": "consumption",
        "func": "const newMsg = {\n    measurement: 'ventilation',\n    payload: []\n};\n\nconst field = {value: msg.payload.value};\nconst tag = {};\n\nif(msg.topic === 'fan consumption') {\n    tag.type = 'fan';\n} else {\n    tag.type = 'ten';\n}\n\nnewMsg.payload[0] = field;\nnewMsg.payload[1] = tag;\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "3ee11684.cdf66a",
        "type": "influxdb out",
        "z": "60924caf.ca9954",
        "influxdb": "aeffd74.491f0a8",
        "name": "save to influx",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "x": 1910,
        "y": 560,
        "wires": []
    },
    {
        "id": "9aded83c.945358",
        "type": "mqtt in dynamic",
        "z": "4bd1c1bf.4f0b7",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "value changed",
        "broker": "7c5f5dec.00cb4c",
        "x": 140,
        "y": 340,
        "wires": [
            [
                "f9ae7701.b383a"
            ]
        ]
    },
    {
        "id": "f9ae7701.b383a",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "is sensors?",
        "func": "if([15,46,29,31,33].some(x=>msg.payload.node_id === x))\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 260,
        "wires": [
            [
                "41f148ef.e75548",
                "7863e2b3.04fb14",
                "c1ae7a12.946e98"
            ]
        ]
    },
    {
        "id": "41f148ef.e75548",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "is temperature?",
        "func": "if(msg.payload.value_id === `${msg.payload.node_id}-49-1-1`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'temperature'\n            }\n        }\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 160,
        "wires": [
            [
                "e03d5fcc.89847"
            ]
        ]
    },
    {
        "id": "c90cf56d.066d88",
        "type": "influxdb out",
        "z": "4bd1c1bf.4f0b7",
        "influxdb": "aeffd74.491f0a8",
        "name": "save influx",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "x": 1210,
        "y": 200,
        "wires": []
    },
    {
        "id": "fce6816e.27bdf",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "add measurement",
        "func": "const tags = msg.payload.tags;\nmsg.measurement = 'sensors';\nmsg.payload = [{\n            value: Number(msg.payload.value)\n        }];\n        \n        msg.payload[1] = tags;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 200,
        "wires": [
            [
                "c90cf56d.066d88"
            ]
        ]
    },
    {
        "id": "7863e2b3.04fb14",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "is humidity?",
        "func": "if(msg.payload.value_id === `${msg.payload.node_id}-49-1-5`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'humidity'\n            }\n        }\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 200,
        "wires": [
            [
                "e03d5fcc.89847"
            ]
        ]
    },
    {
        "id": "c1ae7a12.946e98",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "is luminance?",
        "func": "if(msg.payload.value_id === `${msg.payload.node_id}-49-1-3`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'luminance'\n            }\n        }\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 240,
        "wires": [
            [
                "e03d5fcc.89847"
            ]
        ]
    },
    {
        "id": "e03d5fcc.89847",
        "type": "function",
        "z": "4bd1c1bf.4f0b7",
        "name": "place type",
        "func": "const nodeid = msg.payload.nodeid;\n\nif(nodeid === 15) {\n    msg.payload.tags.place = 'hall';\n}\n\nif(nodeid === 46) {\n    msg.payload.tags.place = 'bathroom';\n}\n\nif(nodeid === 29) {\n    msg.payload.tags.place = 'kitchen';\n}\n\nif(nodeid === 31) {\n    msg.payload.tags.place = 'living';\n}\n\nif(nodeid === 33) {\n    msg.payload.tags.place = 'vika';\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 200,
        "wires": [
            [
                "fce6816e.27bdf"
            ]
        ]
    },
    {
        "id": "56275f31.6e54d",
        "type": "mongodb in",
        "z": "b02e364.3dde7c8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find in db",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 340,
        "y": 80,
        "wires": [
            [
                "ac66d901.7bb75"
            ]
        ]
    },
    {
        "id": "68745c5d.b9dac4",
        "type": "function",
        "z": "b02e364.3dde7c8",
        "name": "check db",
        "func": "msg.payload = {nodeid: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 200,
        "y": 80,
        "wires": [
            [
                "56275f31.6e54d"
            ]
        ]
    },
    {
        "id": "ac66d901.7bb75",
        "type": "function",
        "z": "b02e364.3dde7c8",
        "name": "check should up",
        "func": "if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-38-1-0`);\n    if(value != null && value.value === 0) {\n        return [msg, null];\n    }\n}\n\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 500,
        "y": 80,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "33c01b15.9a211c",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "x": 1120,
        "y": 300,
        "wires": [
            [
                "b1fdf586.9d0eb8"
            ],
            [
                "a85748cf.d8682"
            ]
        ]
    },
    {
        "id": "83f1dbe.19919a8",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check living",
        "func": "return {\n    payload: 11\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 930,
        "y": 300,
        "wires": [
            [
                "33c01b15.9a211c"
            ]
        ]
    },
    {
        "id": "1f2e633e.6a1305",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "x": 1160,
        "y": 340,
        "wires": [
            [
                "63950635.bacf78"
            ],
            []
        ]
    },
    {
        "id": "efd47e20.e03908",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check kitchen",
        "func": "return {\n    payload: 25\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 940,
        "y": 360,
        "wires": [
            [
                "1f2e633e.6a1305"
            ]
        ]
    },
    {
        "id": "36d4fb29.e86034",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "env": [],
        "x": 1120,
        "y": 260,
        "wires": [
            [
                "3ec777d9.83a33"
            ],
            [
                "e62cb442.e539e"
            ]
        ]
    },
    {
        "id": "99d5d340.b76878",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check vika",
        "func": "return {\n    payload: 2\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 260,
        "wires": [
            [
                "36d4fb29.e86034"
            ]
        ]
    },
    {
        "id": "6c184dc7.f0cd5c",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "a55e56f1.d3b8e8"
        ],
        "x": 1775,
        "y": 340,
        "wires": []
    },
    {
        "id": "3215c017.f99758",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "power off",
        "func": " return {\n        payload: {\n            value: 0\n        }\n    }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 340,
        "wires": [
            [
                "6c184dc7.f0cd5c"
            ]
        ]
    },
    {
        "id": "ec87e786.61afd",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "is enabled",
        "func": "if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];",
        "outputs": 2,
        "noerr": 0,
        "x": 1510,
        "y": 340,
        "wires": [
            [],
            [
                "3215c017.f99758"
            ]
        ]
    },
    {
        "id": "c6a278dc.742928",
        "type": "subflow:ecf602b6.267b58",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "env": [],
        "x": 1280,
        "y": 340,
        "wires": [
            [
                "ec87e786.61afd"
            ]
        ]
    },
    {
        "id": "ff2313df.64ff08",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "c77121a0.284ee"
        ],
        "x": 540,
        "y": 100,
        "wires": []
    },
    {
        "id": "c77121a0.284ee",
        "type": "link in",
        "z": "7d373be5.bb59d4",
        "name": "enable pooling",
        "links": [
            "ff2313df.64ff08"
        ],
        "x": 55,
        "y": 1360,
        "wires": [
            [
                "b9336183.e038d"
            ]
        ]
    },
    {
        "id": "b9336183.e038d",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get all nodes",
        "func": "return {\n    payload: {}\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 1360,
        "wires": [
            [
                "255ec177.460536"
            ]
        ]
    },
    {
        "id": "255ec177.460536",
        "type": "mongodb in",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get nodes",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 340,
        "y": 1360,
        "wires": [
            [
                "abfcbf93.cbd4f8"
            ]
        ]
    },
    {
        "id": "abfcbf93.cbd4f8",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "filter 38  and 37",
        "func": "let values = msg.payload\n.map(x=>x.values.filter(x=>(x.class_id === 38 || x.class_id === 37) && x.index === 0));\n\nvalues = [].concat.apply([], values);\n\nreturn{\n    payload: values\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 1360,
        "wires": [
            [
                "c3634274.747f2"
            ]
        ]
    },
    {
        "id": "c3634274.747f2",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "create pooling",
        "func": "msg.payload.forEach(x=>{\n   const newMsg = {};\n   newMsg.topic = 'enablePoll';\n   newMsg.payload = {\n       args: [x, 1]\n   }\n   \n   node.send(newMsg);\n});",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 1360,
        "wires": [
            [
                "54f411a6.976e28"
            ]
        ]
    },
    {
        "id": "54f411a6.976e28",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 875,
        "y": 1360,
        "wires": []
    },
    {
        "id": "db923d32.44d2a",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/addassociation/request",
        "qos": "1",
        "name": "add association in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 1520,
        "wires": [
            [
                "5b35f3a5.3ec424"
            ]
        ]
    },
    {
        "id": "5b35f3a5.3ec424",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform",
        "func": "const payload = msg.payload;\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\nreturn {\n    topic: 'addAssociation',\n    payload: {\n        args: args\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 300,
        "y": 1520,
        "wires": [
            [
                "17a80c99.121fe3",
                "d175f558.6dcf1"
            ]
        ]
    },
    {
        "id": "17a80c99.121fe3",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 415,
        "y": 1520,
        "wires": []
    },
    {
        "id": "cfa132e.31ba7d",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get associations",
        "func": "msg.topic = 'getAssociations';\nmsg.payload = {args: [msg.payload.args[0], msg.payload.args[1]]};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 620,
        "y": 1620,
        "wires": [
            [
                "2dec16b0.1be6ea"
            ]
        ]
    },
    {
        "id": "d175f558.6dcf1",
        "type": "delay",
        "z": "7d373be5.bb59d4",
        "name": "",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 430,
        "y": 1620,
        "wires": [
            [
                "cfa132e.31ba7d"
            ]
        ]
    },
    {
        "id": "2dec16b0.1be6ea",
        "type": "zwave-out",
        "z": "7d373be5.bb59d4",
        "name": "zwave out",
        "controller": "",
        "x": 800,
        "y": 1620,
        "wires": [
            [
                "2a357c1f.23c6f4",
                "759d5245.d4627c"
            ]
        ]
    },
    {
        "id": "2a357c1f.23c6f4",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform to db",
        "func": "msg.query = {\n        nodeid: msg.payload.args[0],\n};\n\nconst result = msg.payload.result;\nconst name = `associations.${msg.payload.args[1] - 1}.associations`;\n\nmsg.payload = {};\nmsg.payload[name] = result;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 1620,
        "wires": [
            [
                "3f88a0e7.d77828"
            ]
        ]
    },
    {
        "id": "759d5245.d4627c",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform to ui",
        "func": "return {\n    topic: '/zwave/associationsupdate/response',\n    payload: {\n        nodeid: msg.payload.args[0],\n        group: msg.payload.args[1] - 1,\n        targetids: msg.payload.result\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 1660,
        "wires": [
            [
                "de7855d8.3abf98"
            ]
        ]
    },
    {
        "id": "de7855d8.3abf98",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 1155,
        "y": 1660,
        "wires": []
    },
    {
        "id": "3f88a0e7.d77828",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "6768cdd2.12ab7c",
            "82cc3504.c1f368"
        ],
        "x": 1155,
        "y": 1620,
        "wires": []
    },
    {
        "id": "6b9dbb8e.2af09c",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "b399d578.a03cc8"
        ],
        "x": 435,
        "y": 1740,
        "wires": []
    },
    {
        "id": "9d019768.877d5",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform",
        "func": "const payload = msg.payload;\n\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\nreturn {\n    topic: 'removeAssociation',\n    payload: {\n        args: args\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 1740,
        "wires": [
            [
                "6b9dbb8e.2af09c",
                "d175f558.6dcf1"
            ]
        ]
    },
    {
        "id": "6e24c140.9dd4d",
        "type": "mqtt in dynamic",
        "z": "7d373be5.bb59d4",
        "topic": "/zwave/removeassociation/request",
        "qos": "1",
        "name": "remove association in",
        "broker": "7c5f5dec.00cb4c",
        "x": 130,
        "y": 1740,
        "wires": [
            [
                "9d019768.877d5"
            ]
        ]
    },
    {
        "id": "393d264e.8f13f2",
        "type": "telegram command",
        "z": "ed3957ea.447518",
        "name": "/warmup",
        "command": "/warmup@YOUR_BOT",
        "bot": "95efe3a3.9ad27",
        "strict": false,
        "x": 370,
        "y": 900,
        "wires": [
            [
                "a82c666f.5f7c98",
                "71d05c90.56264c"
            ],
            []
        ]
    },
    {
        "id": "a82c666f.5f7c98",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "transform warmup",
        "func": "return {payload: {\n    warmup: true\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 900,
        "wires": [
            [
                "54560d6.0f8d174"
            ]
        ]
    },
    {
        "id": "54560d6.0f8d174",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "set out",
        "func": "global.set('vacation', false);\nglobal.set('presence', false);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 900,
        "wires": [
            [
                "53900bb3.e8c904"
            ]
        ]
    },
    {
        "id": "53900bb3.e8c904",
        "type": "mqtt out dynamic",
        "z": "ed3957ea.447518",
        "name": "warmup",
        "topic": "/system/warmup",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 980,
        "y": 900,
        "wires": []
    },
    {
        "id": "e44b402a.d641e",
        "type": "mqtt in dynamic",
        "z": "db61ef7a.7e00d8",
        "topic": "/system/warmup",
        "qos": "1",
        "name": "warmup in",
        "broker": "7c5f5dec.00cb4c",
        "x": 260,
        "y": 980,
        "wires": [
            [
                "b2d6dce.b661aa"
            ]
        ]
    },
    {
        "id": "79313270.2842b4",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open kitchen",
        "func": "const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 1020,
        "wires": [
            [
                "88ca2d04.6b1a18"
            ]
        ]
    },
    {
        "id": "92d1d249.e3578",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open livingroom",
        "func": "const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 980,
        "wires": [
            [
                "21afad17.e58f2a"
            ]
        ]
    },
    {
        "id": "c256321b.5a9f78",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open vika",
        "func": "const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 940,
        "wires": [
            [
                "65af83dc.349db4"
            ]
        ]
    },
    {
        "id": "b2d6dce.b661aa",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "is day",
        "func": "flow.set('vika_override', false);\nflow.set('livingroom_override', false);\n\nif(!global.get('isNight'))\n    return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 980,
        "wires": [
            [
                "c256321b.5a9f78",
                "92d1d249.e3578",
                "79313270.2842b4"
            ]
        ]
    },
    {
        "id": "65af83dc.349db4",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 815,
        "y": 940,
        "wires": []
    },
    {
        "id": "21afad17.e58f2a",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 815,
        "y": 980,
        "wires": []
    },
    {
        "id": "88ca2d04.6b1a18",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 815,
        "y": 1020,
        "wires": []
    },
    {
        "id": "f1076f15.f817",
        "type": "mqtt in dynamic",
        "z": "f0ffdbb3.6e78b",
        "topic": "/system/warmup",
        "qos": "1",
        "name": "warmup in",
        "broker": "7c5f5dec.00cb4c",
        "x": 150,
        "y": 1100,
        "wires": [
            [
                "5cc60586.f81c64"
            ]
        ]
    },
    {
        "id": "e5fbf048.e7d868",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "warmup",
        "links": [
            "5cc60586.f81c64"
        ],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "58749d0a.5c05b4"
            ]
        ]
    },
    {
        "id": "5cc60586.f81c64",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "e5fbf048.e7d868"
        ],
        "x": 275,
        "y": 1100,
        "wires": []
    },
    {
        "id": "99232164.c15678",
        "type": "mqtt in dynamic",
        "z": "d849a1af.eac2a8",
        "topic": "/system/warmup",
        "qos": "1",
        "name": "warmup in",
        "broker": "7c5f5dec.00cb4c",
        "x": 1270,
        "y": 240,
        "wires": [
            [
                "75e7e0b8.eb40d8"
            ]
        ]
    },
    {
        "id": "75e7e0b8.eb40d8",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "2fbaca87.63f4b6"
        ],
        "x": 1395,
        "y": 240,
        "wires": []
    },
    {
        "id": "2fbaca87.63f4b6",
        "type": "link in",
        "z": "d849a1af.eac2a8",
        "name": "warmup",
        "links": [
            "75e7e0b8.eb40d8"
        ],
        "x": 295,
        "y": 280,
        "wires": [
            [
                "939fdebf.ebb37"
            ]
        ]
    },
    {
        "id": "5eccf36a.64721c",
        "type": "subflow:5b528460.e43bb4",
        "z": "ed3957ea.447518",
        "name": "",
        "x": 840,
        "y": 1000,
        "wires": []
    },
    {
        "id": "71d05c90.56264c",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "telegram transform",
        "func": "return {\n    payload: {\n        content: 'Начинаю прогрев'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 1000,
        "wires": [
            [
                "5eccf36a.64721c"
            ]
        ]
    },
    {
        "id": "6291e6f7.3fd158",
        "type": "mqtt in dynamic",
        "z": "630512a0.49d8d4",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "get zwave params",
        "broker": "7c5f5dec.00cb4c",
        "x": 150,
        "y": 80,
        "wires": [
            [
                "a1a43af4.1bc8d"
            ]
        ]
    },
    {
        "id": "ab7c09a9.1b0e7",
        "type": "switch",
        "z": "630512a0.49d8d4",
        "name": "switch sensors",
        "property": "payload.node_id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "37",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "38",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "40",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 600,
        "y": 80,
        "wires": [
            [
                "14f7589.92ed527"
            ],
            [
                "32eeb2ce.1c6136"
            ],
            [
                "509eb3a4.4b498c"
            ]
        ]
    },
    {
        "id": "bd6cd584.636428",
        "type": "cron scheduler",
        "z": "630512a0.49d8d4",
        "name": "check up time",
        "schedule": "0 0 4 1/14 * *",
        "x": 140,
        "y": 360,
        "wires": [
            [
                "1a48e53e.e1bcc3"
            ]
        ]
    },
    {
        "id": "c95f88d0.11ef28",
        "type": "mqtt out dynamic",
        "z": "630512a0.49d8d4",
        "name": "set zwave out",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1660,
        "y": 60,
        "wires": []
    },
    {
        "id": "ce4eb07c.716248",
        "type": "link in",
        "z": "630512a0.49d8d4",
        "name": "zwave out",
        "links": [
            "9f4b17fa.947dd",
            "77494c1a.e57254"
        ],
        "x": 1520,
        "y": 60,
        "wires": [
            [
                "c95f88d0.11ef28"
            ]
        ]
    },
    {
        "id": "ac903912.2e7d28",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "close valve",
        "func": "const value = {\n        node_id: 20,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 360,
        "wires": [
            [
                "9f4b17fa.947dd"
            ]
        ]
    },
    {
        "id": "9f4b17fa.947dd",
        "type": "link out",
        "z": "630512a0.49d8d4",
        "name": "",
        "links": [
            "ce4eb07c.716248"
        ],
        "x": 935,
        "y": 360,
        "wires": []
    },
    {
        "id": "6d0a0e2a.e98e",
        "type": "delay",
        "z": "630512a0.49d8d4",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 800,
        "y": 420,
        "wires": [
            [
                "f9840c0e.5fdaa8"
            ]
        ]
    },
    {
        "id": "f9840c0e.5fdaa8",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "open valve",
        "func": "const value = {\n        node_id: 20,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 420,
        "wires": [
            [
                "77494c1a.e57254"
            ]
        ]
    },
    {
        "id": "77494c1a.e57254",
        "type": "link out",
        "z": "630512a0.49d8d4",
        "name": "",
        "links": [
            "ce4eb07c.716248"
        ],
        "x": 1075,
        "y": 420,
        "wires": []
    },
    {
        "id": "7c30ba51.fa6f24",
        "type": "subflow:5b528460.e43bb4",
        "z": "630512a0.49d8d4",
        "name": "",
        "x": 1660,
        "y": 160,
        "wires": []
    },
    {
        "id": "14f7589.92ed527",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "telegram transform (bath)",
        "func": "return {\n    payload: {\n        content: 'Протечка под раковинной в ванной'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 60,
        "wires": [
            [
                "16f80b4a.f2487d"
            ]
        ]
    },
    {
        "id": "5cda4025.41c79",
        "type": "link in",
        "z": "630512a0.49d8d4",
        "name": "send msg",
        "links": [
            "16f80b4a.f2487d",
            "5d880e52.44fc78",
            "cdb485a8.0abe4"
        ],
        "x": 1535,
        "y": 160,
        "wires": [
            [
                "7c30ba51.fa6f24"
            ]
        ]
    },
    {
        "id": "a1a43af4.1bc8d",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "check leak signal",
        "func": "if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value === true) {\n    return msg;\n}\n\nreturn;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 80,
        "wires": [
            [
                "ab7c09a9.1b0e7"
            ]
        ]
    },
    {
        "id": "32eeb2ce.1c6136",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "telegram transform (kitchen)",
        "func": "return {\n    payload: {\n        content: 'Протечка под раковинной в кухне'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 100,
        "wires": [
            [
                "5d880e52.44fc78"
            ]
        ]
    },
    {
        "id": "16f80b4a.f2487d",
        "type": "link out",
        "z": "630512a0.49d8d4",
        "name": "",
        "links": [
            "5cda4025.41c79"
        ],
        "x": 1000,
        "y": 60,
        "wires": []
    },
    {
        "id": "5d880e52.44fc78",
        "type": "link out",
        "z": "630512a0.49d8d4",
        "name": "",
        "links": [
            "5cda4025.41c79"
        ],
        "x": 1015,
        "y": 100,
        "wires": []
    },
    {
        "id": "edfc4dc1.7f8078",
        "type": "json",
        "z": "5dede675.638c1",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 600,
        "y": 300,
        "wires": [
            [
                "f5f9ecc3.05075"
            ]
        ]
    },
    {
        "id": "bad58d01.2dcf6",
        "type": "inject",
        "z": "5dede675.638c1",
        "name": "request weather",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "900",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 190,
        "y": 300,
        "wires": [
            [
                "2d69bd73.69945a"
            ]
        ]
    },
    {
        "id": "2d69bd73.69945a",
        "type": "http request",
        "z": "5dede675.638c1",
        "name": "get weather",
        "method": "GET",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://api.darksky.net/forecast/YOUR_TOKEN/55.755825,37.617298?exclude=minutely,alerts,flags&units=si",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "basic",
        "x": 390,
        "y": 300,
        "wires": [
            [
                "edfc4dc1.7f8078"
            ]
        ]
    },
    {
        "id": "f5f9ecc3.05075",
        "type": "function",
        "z": "5dede675.638c1",
        "name": "prepare object",
        "func": "const newMsg = {};\nnewMsg.payload = msg.payload;\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 300,
        "wires": [
            [
                "23805d23.b3bc02",
                "6d9f9c61.d1ec64",
                "22a2d167.b7ec06"
            ]
        ]
    },
    {
        "id": "23805d23.b3bc02",
        "type": "function",
        "z": "5dede675.638c1",
        "name": "set ready to save",
        "func": "msg.payload.id = 1;\nconst $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {id:msg.payload.id}};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 300,
        "wires": [
            [
                "8d5860e4.417c1"
            ]
        ]
    },
    {
        "id": "8d5860e4.417c1",
        "type": "mongodb out",
        "z": "5dede675.638c1",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save to db",
        "collection": "weather",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1190,
        "y": 300,
        "wires": []
    },
    {
        "id": "dd241ced.d115a",
        "type": "mqtt out dynamic",
        "z": "5dede675.638c1",
        "name": "weather out",
        "topic": "/weather/response",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1740,
        "y": 140,
        "wires": []
    },
    {
        "id": "c3405748.ee9d4",
        "type": "link in",
        "z": "5dede675.638c1",
        "name": "weatre out",
        "links": [
            "6d9f9c61.d1ec64",
            "939e9f94.1da76"
        ],
        "x": 1615,
        "y": 140,
        "wires": [
            [
                "dd241ced.d115a"
            ]
        ]
    },
    {
        "id": "6d9f9c61.d1ec64",
        "type": "link out",
        "z": "5dede675.638c1",
        "name": "",
        "links": [
            "c3405748.ee9d4"
        ],
        "x": 935,
        "y": 360,
        "wires": []
    },
    {
        "id": "4dfedaec.23ad6c",
        "type": "mqtt in dynamic",
        "z": "5dede675.638c1",
        "topic": "/weather/request",
        "qos": "1",
        "name": "weather request",
        "broker": "7c5f5dec.00cb4c",
        "x": 190,
        "y": 540,
        "wires": [
            [
                "d2856375.eddf78"
            ]
        ]
    },
    {
        "id": "d2856375.eddf78",
        "type": "function",
        "z": "5dede675.638c1",
        "name": "request weather from db",
        "func": "msg.payload = {id: 1};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 540,
        "wires": [
            [
                "d7961b7.7f32168"
            ]
        ]
    },
    {
        "id": "d7961b7.7f32168",
        "type": "mongodb in",
        "z": "5dede675.638c1",
        "mongodb": "3bb6209c.4b0d08",
        "name": "weather find",
        "collection": "weather",
        "operation": "find",
        "x": 650,
        "y": 540,
        "wires": [
            [
                "73eb2b6f.c79e44"
            ]
        ]
    },
    {
        "id": "73eb2b6f.c79e44",
        "type": "function",
        "z": "5dede675.638c1",
        "name": "set payload",
        "func": "msg.payload = msg.payload[0];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 540,
        "wires": [
            [
                "939e9f94.1da76"
            ]
        ]
    },
    {
        "id": "939e9f94.1da76",
        "type": "link out",
        "z": "5dede675.638c1",
        "name": "",
        "links": [
            "c3405748.ee9d4"
        ],
        "x": 975,
        "y": 540,
        "wires": []
    },
    {
        "id": "e8b61997.5bc38",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "6768cdd2.12ab7c",
            "82cc3504.c1f368"
        ],
        "x": 655,
        "y": 1240,
        "wires": []
    },
    {
        "id": "7cd6d82e.c6026",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "update value",
        "func": "const payload = msg.payload;\nconst valueId = `${payload.nodeid}-${payload.cmdclass}-${payload.instance}-${payload.cmdidx}`;\nmsg.query = {\n        nodeid: payload.nodeid,\n        values: { \n            $elemMatch:{\n                value_id: valueId\n            }\n        }\n};\n\nmsg.payload = {\n    'values.$.value': payload.value\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 550,
        "y": 1240,
        "wires": [
            [
                "e8b61997.5bc38"
            ]
        ]
    },
    {
        "id": "d02bbc76.64623",
        "type": "link out",
        "z": "7d373be5.bb59d4",
        "name": "",
        "links": [
            "473c9662.b157e8"
        ],
        "x": 935,
        "y": 1300,
        "wires": []
    },
    {
        "id": "7a1e4b3b.968e3c",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "get node",
        "func": "msg.originalPayload = msg.payload;\nmsg.payload = {nodeid: msg.payload.nodeid};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 1300,
        "wires": [
            [
                "67639dd0.21cf74"
            ]
        ]
    },
    {
        "id": "67639dd0.21cf74",
        "type": "mongodb in",
        "z": "7d373be5.bb59d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find in db",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 660,
        "y": 1300,
        "wires": [
            [
                "8cafeae2.6cb0b"
            ]
        ]
    },
    {
        "id": "8cafeae2.6cb0b",
        "type": "function",
        "z": "7d373be5.bb59d4",
        "name": "transform",
        "func": "const payload = msg.payload[0];\nconst originalPayload = msg.originalPayload;\nconst valueId = `${originalPayload.nodeid}-${originalPayload.cmdclass}-${originalPayload.instance}-${originalPayload.cmdidx}`;\n\nconst value = payload.values.find(x=>x.value_id === valueId);\n\nif(value) {\n    value.value = originalPayload.value;\n    \n    return {payload: value, topic: '/zwave/changevalue/response'};\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 820,
        "y": 1300,
        "wires": [
            [
                "d02bbc76.64623"
            ]
        ]
    },
    {
        "id": "1a48e53e.e1bcc3",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "find",
        "func": "return {payload: {nodeid: 20}};",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 360,
        "wires": [
            [
                "1cc245a5.f65f2a"
            ]
        ]
    },
    {
        "id": "1cc245a5.f65f2a",
        "type": "mongodb in",
        "z": "630512a0.49d8d4",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 450,
        "y": 360,
        "wires": [
            [
                "a297288f.39f65"
            ]
        ]
    },
    {
        "id": "a297288f.39f65",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "transform",
        "func": "if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-37-1-0`);\n    if(value != null && value.value === false) {\n        return msg;\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 360,
        "wires": [
            [
                "6d0a0e2a.e98e",
                "ac903912.2e7d28"
            ]
        ]
    },
    {
        "id": "e62cb442.e539e",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "cancel",
        "func": "flow.set('vika_override', false);\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "a85748cf.d8682",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "cancel",
        "func": "flow.set('livingroom_override', false);\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1350,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "e5a99225.29d01",
        "type": "RM",
        "z": "f924f1b0.7621d8",
        "name": "vika",
        "device": "8333b8e6.541fc8",
        "action": "_msg_",
        "remote": "",
        "button": "",
        "fix": 1,
        "RFSweep": "false",
        "x": 1710,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "a292158f.2f4038",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "generate id",
        "func": "let modetype = context.get('mt');\n\nif(!modetype) {\n    modetype = 2;\n}\n\nconst mode = 'c';\nlet temperature = context.get('t') || 28;\n\n\nlet fs = context.get('fs') || \"a\";\n\nif(modetype === 2) {\nif(fs === \"1\") {\n    fs = \"a\";\n    modetype = 1;\n}\nelse if(fs === \"a\") {\n    fs = \"3\";\n}\nelse if(fs === \"3\") {\n    fs = \"2\";\n}\nelse if(fs === \"2\") {\n    fs = \"1\";\n}\n}\n\n\nif(modetype === 1) {\n    temperature++;\n    modetype = 2;\n}\n\ncontext.set('fs', fs);\ncontext.set('mt', modetype);\ncontext.set('t', temperature);\n\nmsg.payload.id = `${mode}${temperature}${fs}`;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "e97181fb.6986f",
        "type": "RM",
        "z": "f924f1b0.7621d8",
        "name": "living",
        "device": "46e35d6a.85f28c",
        "action": "_msg_",
        "remote": "",
        "button": "",
        "fix": 1,
        "RFSweep": "false",
        "x": 1710,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "2eeabf52.161c98",
        "type": "link in",
        "z": "f924f1b0.7621d8",
        "name": "vika ir",
        "links": [
            "d8ae3474.bc6e48"
        ],
        "x": 1595,
        "y": 260,
        "wires": [
            [
                "e5a99225.29d01"
            ]
        ]
    },
    {
        "id": "42fd73c4.68a03c",
        "type": "link in",
        "z": "f924f1b0.7621d8",
        "name": "living ir",
        "links": [
            "5330dd29.3b208c"
        ],
        "x": 1595,
        "y": 320,
        "wires": [
            [
                "e97181fb.6986f"
            ]
        ]
    },
    {
        "id": "fa47b1a5.447418",
        "type": "mqtt in dynamic",
        "z": "f924f1b0.7621d8",
        "topic": "/conditionaire/request",
        "qos": "1",
        "name": "cond in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 120,
        "wires": [
            [
                "a56a6090.c81318"
            ]
        ]
    },
    {
        "id": "d6576fa1.5c2748",
        "type": "mqtt out dynamic",
        "z": "f924f1b0.7621d8",
        "name": "cond out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1730,
        "y": 420,
        "wires": []
    },
    {
        "id": "a7ab33a6.8c43c8",
        "type": "link in",
        "z": "f924f1b0.7621d8",
        "name": "cond out",
        "links": [
            "38017366.782794",
            "17264770.370069",
            "ac0af8e3.09725",
            "f23f624f.7f6e78"
        ],
        "x": 1595,
        "y": 420,
        "wires": [
            [
                "d6576fa1.5c2748"
            ]
        ]
    },
    {
        "id": "febce168.06066",
        "type": "inject",
        "z": "f924f1b0.7621d8",
        "name": "inject id",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 140,
        "y": 680,
        "wires": [
            [
                "a4f33bbc.433b78"
            ]
        ]
    },
    {
        "id": "88ad53f2.d78238",
        "type": "mongodb in",
        "z": "f924f1b0.7621d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "conditionare",
        "collection": "conditionare",
        "operation": "find",
        "x": 530,
        "y": 680,
        "wires": [
            [
                "15f4557f.a17103"
            ]
        ]
    },
    {
        "id": "38017366.782794",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "a7ab33a6.8c43c8"
        ],
        "x": 815,
        "y": 680,
        "wires": []
    },
    {
        "id": "a56a6090.c81318",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "generate command",
        "func": "let command = \"\";\n\nif(msg.payload.powerChange) {\n    command = msg.payload.enabled ? 'on' : \"off\";\n} else {\n    const fan = msg.payload.fan === 0 ? 'a' : msg.payload.fan;\n    const mode = msg.payload.mode === 'cool' ? 'c' : 'w';\n    \n    command = `${mode}${msg.payload.temperature}${fan}`;\n}\n\ndelete msg.payload.powerChange;\ndelete msg.payload._id;\n\nmsg.cache = msg.payload;\n\nmsg.payload = {id: command};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 120,
        "wires": [
            [
                "b0fa6548.e3dd58"
            ]
        ]
    },
    {
        "id": "9f540b1e.8fdff",
        "type": "switch",
        "z": "f924f1b0.7621d8",
        "name": "check command",
        "property": "code.id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 940,
        "y": 200,
        "wires": [
            [
                "948efc5a.415d9",
                "8f4da447.14c558",
                "5e30a504.7e3f1c"
            ],
            [
                "948efc5a.415d9",
                "8f4da447.14c558",
                "29aee74e.fa977"
            ],
            [
                "8f4da447.14c558",
                "f23f624f.7f6e78"
            ]
        ]
    },
    {
        "id": "b0fa6548.e3dd58",
        "type": "mongodb in",
        "z": "f924f1b0.7621d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get code",
        "collection": "conditionare",
        "operation": "find",
        "x": 560,
        "y": 120,
        "wires": [
            [
                "a304a7e8.1a8a98"
            ]
        ]
    },
    {
        "id": "a304a7e8.1a8a98",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "set code",
        "func": "msg.code = msg.payload[0];\nmsg.payload = msg.cache;\n\ndelete msg.cache;\n\nmsg.topic = '/conditionaire/response';\ndelete msg.clientId;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 120,
        "wires": [
            [
                "9f540b1e.8fdff"
            ]
        ]
    },
    {
        "id": "948efc5a.415d9",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "set loading",
        "func": "msg.payload.loading = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 180,
        "wires": [
            [
                "17264770.370069"
            ]
        ]
    },
    {
        "id": "e28c7d60.594898",
        "type": "mongodb out",
        "z": "f924f1b0.7621d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save",
        "collection": "conditionare",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 1750,
        "y": 500,
        "wires": []
    },
    {
        "id": "abb505d8.0e7ef8",
        "type": "link in",
        "z": "f924f1b0.7621d8",
        "name": "save",
        "links": [
            "17264770.370069",
            "ac0af8e3.09725",
            "f23f624f.7f6e78"
        ],
        "x": 1495,
        "y": 500,
        "wires": [
            [
                "d7639a.cf682c68"
            ]
        ]
    },
    {
        "id": "17264770.370069",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "a7ab33a6.8c43c8",
            "abb505d8.0e7ef8"
        ],
        "x": 1355,
        "y": 180,
        "wires": []
    },
    {
        "id": "5e30a504.7e3f1c",
        "type": "delay",
        "z": "f924f1b0.7621d8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1060,
        "y": 80,
        "wires": [
            [
                "8f8fd8e9.c0dcd"
            ]
        ]
    },
    {
        "id": "8f8fd8e9.c0dcd",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "set loading",
        "func": "msg.payload.loading = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1330,
        "y": 120,
        "wires": [
            [
                "ac0af8e3.09725"
            ]
        ]
    },
    {
        "id": "ac0af8e3.09725",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "a7ab33a6.8c43c8",
            "abb505d8.0e7ef8"
        ],
        "x": 1455,
        "y": 120,
        "wires": []
    },
    {
        "id": "8f4da447.14c558",
        "type": "switch",
        "z": "f924f1b0.7621d8",
        "name": "check type",
        "property": "payload.id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1210,
        "y": 280,
        "wires": [
            [
                "25879443.6bee2c"
            ],
            [
                "1a5d7400.5fe93c"
            ]
        ]
    },
    {
        "id": "5330dd29.3b208c",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "42fd73c4.68a03c"
        ],
        "x": 1455,
        "y": 240,
        "wires": []
    },
    {
        "id": "d8ae3474.bc6e48",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "2eeabf52.161c98"
        ],
        "x": 1475,
        "y": 300,
        "wires": []
    },
    {
        "id": "d7639a.cf682c68",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "prepare msg",
        "func": "const $set = {$set: msg.payload};\nconst query = {id: msg.payload.id};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1610,
        "y": 500,
        "wires": [
            [
                "e28c7d60.594898"
            ]
        ]
    },
    {
        "id": "f23f624f.7f6e78",
        "type": "link out",
        "z": "f924f1b0.7621d8",
        "name": "",
        "links": [
            "a7ab33a6.8c43c8",
            "abb505d8.0e7ef8"
        ],
        "x": 1055,
        "y": 300,
        "wires": []
    },
    {
        "id": "25879443.6bee2c",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "prepare",
        "func": "\nreturn {\n    payload: {\n    action: 'send',\n    data: msg.code.data\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 1350,
        "y": 240,
        "wires": [
            [
                "5330dd29.3b208c"
            ]
        ]
    },
    {
        "id": "1a5d7400.5fe93c",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "prepare",
        "func": "\nreturn {\n    payload: {\n    action: 'send',\n    data: msg.code.data\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 300,
        "wires": [
            [
                "d8ae3474.bc6e48"
            ]
        ]
    },
    {
        "id": "15f4557f.a17103",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "send all",
        "func": "msg.topic = '/conditionaire/all/response'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 680,
        "wires": [
            [
                "38017366.782794"
            ]
        ]
    },
    {
        "id": "fc081905.e8d9",
        "type": "mqtt in dynamic",
        "z": "f924f1b0.7621d8",
        "topic": "/conditionaire/all/request",
        "qos": "1",
        "name": "cond in",
        "broker": "7c5f5dec.00cb4c",
        "x": 140,
        "y": 740,
        "wires": [
            [
                "a4f33bbc.433b78"
            ]
        ]
    },
    {
        "id": "a4f33bbc.433b78",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "inject ids",
        "func": "msg.payload = {\"$or\":[{\"id\":1},{\"id\":2}]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 680,
        "wires": [
            [
                "88ad53f2.d78238"
            ]
        ]
    },
    {
        "id": "29aee74e.fa977",
        "type": "delay",
        "z": "f924f1b0.7621d8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1100,
        "y": 120,
        "wires": [
            [
                "8f8fd8e9.c0dcd",
                "a56a6090.c81318"
            ]
        ]
    },
    {
        "id": "a87ec694.864278",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "get weather",
        "func": "\nreturn {payload: {\n    id: 1\n}};",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 60,
        "wires": [
            [
                "288124bd.5f6bac"
            ]
        ]
    },
    {
        "id": "288124bd.5f6bac",
        "type": "mongodb in",
        "z": "51524d6e.749374",
        "mongodb": "3bb6209c.4b0d08",
        "name": "weather",
        "collection": "weather",
        "operation": "find",
        "x": 400,
        "y": 60,
        "wires": [
            [
                "86ed29f7.9d1"
            ]
        ]
    },
    {
        "id": "86ed29f7.9d1",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "get temperature",
        "func": "msg.weather = msg.payload[0];\nmsg.payload = {\"$or\":[{\"nodeid\":31},{\"nodeid\":33}]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 60,
        "wires": [
            [
                "bf481343.207ac"
            ]
        ]
    },
    {
        "id": "bf481343.207ac",
        "type": "mongodb in",
        "z": "51524d6e.749374",
        "mongodb": "3bb6209c.4b0d08",
        "name": "temperature",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 790,
        "y": 60,
        "wires": [
            [
                "33fc279f.aa3558"
            ]
        ]
    },
    {
        "id": "33fc279f.aa3558",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "get cond status",
        "func": "msg.zwave = msg.payload.map(x=>({nodeid: x.nodeid, temperature: x.values.filter(v=>v.class_id === 49 && v.instance === 1 && v.index === 1),  lux: x.values.filter(v=>v.class_id === 49 && v.instance === 1 && v.index === 3)}));\n\nmsg.payload = {\"$or\":[{\"id\":1},{\"id\":2}]};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 60,
        "wires": [
            [
                "951ddf41.6e6228"
            ]
        ]
    },
    {
        "id": "951ddf41.6e6228",
        "type": "mongodb in",
        "z": "51524d6e.749374",
        "mongodb": "3bb6209c.4b0d08",
        "name": "conditionaire",
        "collection": "conditionare",
        "operation": "find",
        "x": 1190,
        "y": 60,
        "wires": [
            [
                "b240eac9.bc07e"
            ]
        ]
    },
    {
        "id": "b240eac9.bc07e",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "conditionaire",
        "func": "msg.conditionaire = msg.payload;\n\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1380,
        "y": 60,
        "wires": [
            [
                "87bb5bca.865f6"
            ]
        ]
    },
    {
        "id": "d13420ce.1a5598",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "send msg",
        "links": [
            "9da7f97f.f96188",
            "e6cb3d54.3f435",
            "d8ef4103.060608",
            "af60162c.8e9ed8",
            "d1389f8f.76d4b",
            "58d53b80.bf190c",
            "7b39f177.908ba8",
            "4743e32.828441c",
            "3a9ff62f.f2931a",
            "7b1caaf1.615d34",
            "391db2c0.6e41e6",
            "a68fc278.938018",
            "a2adc5c5.ffe4f8",
            "d82ca6ec.e7dfd"
        ],
        "x": 1680,
        "y": 500,
        "wires": [
            [
                "5620af81.1245f"
            ]
        ]
    },
    {
        "id": "5620af81.1245f",
        "type": "mqtt out dynamic",
        "z": "51524d6e.749374",
        "name": "cond out",
        "topic": "/conditionaire/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1810,
        "y": 500,
        "wires": []
    },
    {
        "id": "ad3f1f6e.db221",
        "type": "RM",
        "z": "f924f1b0.7621d8",
        "name": "living",
        "device": "46e35d6a.85f28c",
        "action": "learn",
        "remote": "",
        "button": "",
        "fix": 1,
        "RFSweep": "false",
        "x": 1610,
        "y": 940,
        "wires": [
            [
                "454184fa.d840a4"
            ]
        ]
    },
    {
        "id": "1a507835.074878",
        "type": "inject",
        "z": "f924f1b0.7621d8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 1500,
        "y": 860,
        "wires": [
            [
                "ad3f1f6e.db221"
            ]
        ]
    },
    {
        "id": "454184fa.d840a4",
        "type": "debug",
        "z": "f924f1b0.7621d8",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "x": 1800,
        "y": 940,
        "wires": []
    },
    {
        "id": "8b6523e.75ef56",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "presence in",
        "links": [
            "9acedbd3.65f24",
            "1ed3b9e3.77038e",
            "7b7d1cfc.7040ec",
            "6c24e194.7efd7",
            "9bd922ac.a255f8"
        ],
        "x": 1955,
        "y": 60,
        "wires": []
    },
    {
        "id": "42fd4514.2e0834",
        "type": "mqtt in dynamic",
        "z": "1cc6b114.588857",
        "topic": "/system/presence",
        "qos": "1",
        "name": "presence event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1780,
        "y": 60,
        "wires": [
            [
                "8b6523e.75ef56"
            ]
        ]
    },
    {
        "id": "9acedbd3.65f24",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "8b6523e.75ef56"
        ],
        "x": 95,
        "y": 100,
        "wires": [
            [
                "d276f0d1.44b768"
            ]
        ]
    },
    {
        "id": "d276f0d1.44b768",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is presence",
        "func": "if(!msg.payload.presence) return;\n\nconst now = Date.now();\nconst doorSensor = global.get('door');\n\nif(!doorSensor) return;\nif(now - doorSensor.lastOpenDate > 10000) return;\n\nreturn {payload: {nodeid: 15}};",
        "outputs": 1,
        "noerr": 0,
        "x": 225,
        "y": 100,
        "wires": [
            [
                "2c5b8f3d.485e7"
            ]
        ]
    },
    {
        "id": "2c5b8f3d.485e7",
        "type": "mongodb in",
        "z": "1cc6b114.588857",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get lx",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 365,
        "y": 100,
        "wires": [
            [
                "5a65f1dd.5884"
            ]
        ]
    },
    {
        "id": "226740d3.cf6248",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lux",
        "func": "const lxParam = mag.lx.values.find(x=>x.value_id === '15-49-1-3');\n\nif(lxParam.value > 15) return null;\n\nreturn {payload:{}};",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 100,
        "wires": [
            [
                "2403eaf5.b22bd6"
            ]
        ]
    },
    {
        "id": "a3999674.cd246",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1315,
        "y": 100,
        "wires": []
    },
    {
        "id": "19554757.950051",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "zwave out",
        "links": [
            "a3999674.cd246",
            "f85a64a3.e91108",
            "96d43856.f6d0b8",
            "129daa0b.9f7d9e",
            "7671752c.808264",
            "33877f6c.fb786",
            "ed17cf3d.f0f14",
            "9da00f53.385f08",
            "8d53f094.ef08e",
            "b5b7e1a9.e16c",
            "11d70192.238a5e",
            "c380e9e3.4d7e48"
        ],
        "x": 1715,
        "y": 140,
        "wires": [
            [
                "38d46397.a4d84c"
            ]
        ]
    },
    {
        "id": "38d46397.a4d84c",
        "type": "mqtt out dynamic",
        "z": "1cc6b114.588857",
        "name": "zwave out",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1860,
        "y": 140,
        "wires": []
    },
    {
        "id": "d1cf7f67.2a7d08",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "Включение света в коридоре когда кто-то приходит",
        "info": "",
        "x": 295,
        "y": 60,
        "wires": []
    },
    {
        "id": "6549a59b.56bbdc",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "включение света там где кто-то есть при опускании штор на ночь",
        "info": "",
        "x": 345,
        "y": 180,
        "wires": []
    },
    {
        "id": "505750da.5a2bd8",
        "type": "mqtt out dynamic",
        "z": "a811a2d2.521d38",
        "name": "night",
        "topic": "/system/night",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1030,
        "y": 1260,
        "wires": []
    },
    {
        "id": "bbb90159.496258",
        "type": "nighttime",
        "z": "a811a2d2.521d38",
        "name": "",
        "lon": "37.617298",
        "lat": "55.755825",
        "start": "sunrise",
        "end": "sunset",
        "x": 760,
        "y": 1260,
        "wires": [
            [],
            [
                "e11636d6.05ab8"
            ]
        ]
    },
    {
        "id": "d4c414e3.6917",
        "type": "mqtt in dynamic",
        "z": "db61ef7a.7e00d8",
        "topic": "/system/night",
        "qos": "1",
        "name": "night event",
        "broker": "7c5f5dec.00cb4c",
        "x": 110,
        "y": 60,
        "wires": [
            [
                "5bfe614e.115c9"
            ]
        ]
    },
    {
        "id": "90abc034.2cd6b8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lamels",
        "func": "if(msg.payload.class_id === 38 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) {\n    let previous = context.get(`n_${msg.payload.node_id}`);\n    if(previous == null) {\n        previous = msg.payload.value;\n    }\n    \n     context.set(`n_${msg.payload.node_id}`, msg.payload.value);\n    \n    if(previous !== 0 && msg.payload.value === 0) {\n        return {\n            payload: {\n                nodeid: msg.payload.node_id\n            }\n        };\n    }\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 240,
        "wires": [
            [
                "861c9daa.1424f8",
                "5cd14e95.6224e8"
            ]
        ]
    },
    {
        "id": "6889d8d3.cb265",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "should turn on",
        "func": "const nodes = [];\nconst now = Date.now();\n\nconst movement = [33,31,29].map(x=>({id: x, data: global.get(`motion_${x}`)}))\n.map(x=>({id:x.id, movement: now - x.data.lastMotion <= (15 * 60) * 1000}));\n\n\nmovement.forEach(x=> {\n    if(x.id === 33 && x.movement &&  msg.payload.nodeid === 2) {\n        nodes.push(4);\n    }\n    if(x.id === 31 && x.movement && msg.payload.nodeid === 11) {\n        nodes.push(9);\n    }\n    if(x.id === 29 && x.movement && msg.payload.nodeid === 25) {\n        nodes.push(39);\n    }\n})\n\nreturn {payload: nodes};",
        "outputs": 1,
        "noerr": 0,
        "x": 1120,
        "y": 280,
        "wires": [
            [
                "eea36d69.29d5f"
            ]
        ]
    },
    {
        "id": "eea36d69.29d5f",
        "type": "split",
        "z": "1cc6b114.588857",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1290,
        "y": 280,
        "wires": [
            [
                "3e56bc89.74997c"
            ]
        ]
    },
    {
        "id": "e11636d6.05ab8",
        "type": "function",
        "z": "a811a2d2.521d38",
        "name": "set night",
        "func": "msg.payload = {night: msg.payload}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 1260,
        "wires": [
            [
                "505750da.5a2bd8"
            ]
        ]
    },
    {
        "id": "3e56bc89.74997c",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "set value",
        "func": "let value = {\n        node_id: msg.payload,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 50\n    };\n    \n    \n    if(msg.payload === 39) {\n        value = {\n        node_id: msg.payload,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n    }\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 280,
        "wires": [
            [
                "f85a64a3.e91108"
            ]
        ]
    },
    {
        "id": "f85a64a3.e91108",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1515,
        "y": 280,
        "wires": []
    },
    {
        "id": "f78b305d.f6a398",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "Свет на кухне вечером",
        "info": "",
        "x": 230,
        "y": 740,
        "wires": []
    },
    {
        "id": "509eb3a4.4b498c",
        "type": "function",
        "z": "630512a0.49d8d4",
        "name": "telegram transform (bath tubs)",
        "func": "return {\n    payload: {\n        content: 'Протечка в тех шкафу'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 140,
        "wires": [
            [
                "cdb485a8.0abe4"
            ]
        ]
    },
    {
        "id": "cdb485a8.0abe4",
        "type": "link out",
        "z": "630512a0.49d8d4",
        "name": "",
        "links": [
            "5cda4025.41c79"
        ],
        "x": 1015,
        "y": 140,
        "wires": []
    },
    {
        "id": "4d108938.e0b578",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check motion",
        "func": "if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 10 &&\nmsg.payload.value === 8 && (msg.payload.node_id === 15 || msg.payload.node_id === 47 || msg.payload.node_id === 29)) {\n    return {payload: {nodeid: msg.payload.node_id}};\n}\n\nreturn;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 170,
        "y": 800,
        "wires": [
            [
                "8a76daac.4fbd1"
            ]
        ]
    },
    {
        "id": "54b81fdd.74bf5",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "should turn on",
        "func": "const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1260,
        "y": 760,
        "wires": [
            [
                "96d43856.f6d0b8"
            ]
        ]
    },
    {
        "id": "96d43856.f6d0b8",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1395,
        "y": 760,
        "wires": []
    },
    {
        "id": "7288cee0.35c0e8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "should turn off",
        "func": "const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: false\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 880,
        "wires": [
            [
                "129daa0b.9f7d9e"
            ]
        ]
    },
    {
        "id": "129daa0b.9f7d9e",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1615,
        "y": 880,
        "wires": []
    },
    {
        "id": "503359fe.5c7278",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "sunset",
        "endTime": "sunrise",
        "startOffset": 0,
        "endOffset": "-60",
        "x": 1040,
        "y": 760,
        "wires": [
            [
                "54b81fdd.74bf5",
                "6bdd953.c0f7a6c"
            ],
            []
        ]
    },
    {
        "id": "548621e1.14e81",
        "type": "switch",
        "z": "1cc6b114.588857",
        "name": "switch node",
        "property": "payload.nodeid",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "15",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "16",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "29",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 840,
        "y": 800,
        "wires": [
            [
                "503359fe.5c7278"
            ],
            [
                "503359fe.5c7278"
            ],
            [
                "503359fe.5c7278"
            ]
        ]
    },
    {
        "id": "6bdd953.c0f7a6c",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "2",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 1260,
        "y": 900,
        "wires": [
            [
                "7288cee0.35c0e8"
            ],
            []
        ]
    },
    {
        "id": "c0afd2e9.b48dc",
        "type": "comment",
        "z": "d849a1af.eac2a8",
        "name": "Поднять температуру пола в ванной на время купашек",
        "info": "",
        "x": 350,
        "y": 580,
        "wires": []
    },
    {
        "id": "8f5dbdd7.bab3f8",
        "type": "mqtt in dynamic",
        "z": "d849a1af.eac2a8",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "get zwave params",
        "broker": "7c5f5dec.00cb4c",
        "x": 1290,
        "y": 60,
        "wires": [
            [
                "3b1849d6.4fe386"
            ]
        ]
    },
    {
        "id": "3b1849d6.4fe386",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "zwave in",
        "links": [
            "c74acfe5.df07"
        ],
        "x": 1435,
        "y": 60,
        "wires": []
    },
    {
        "id": "c74acfe5.df07",
        "type": "link in",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "3b1849d6.4fe386"
        ],
        "x": 75,
        "y": 780,
        "wires": [
            [
                "7022635c.73b9ac"
            ]
        ]
    },
    {
        "id": "7022635c.73b9ac",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "check humidity",
        "func": "if(msg.payload === 'stop') {\n    context.set('h', 0);\n    return;\n}\nconst humidity =  Number(context.get('h')) || 0;\n\nif(msg.payload.class_id === 49 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 5 && msg.payload.node_id === 48) {\n    if(humidity === 0) {\n         context.set('h', Number(msg.payload.value));\n         return {payload: 'stop'};\n    }\n    \n    if(Number(msg.payload.value) - humidity >= 5) {\n        context.set('h',  Number(msg.payload.value));\n        return msg;\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 200,
        "y": 780,
        "wires": [
            [
                "7bc2c097.abaec8"
            ]
        ]
    },
    {
        "id": "92a4b653.ade74",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "check motion",
        "func": "const now = Date.now();\nconst motion = global.get('motion_48');\n\nif(now - motion.lastMotion <= (25*60)*1000) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 550,
        "y": 780,
        "wires": [
            [
                "d3f0696.ccfd018"
            ]
        ]
    },
    {
        "id": "cd11820a.e9c2",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "enable",
        "func": "const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Heat (Default)'\n    };\n    \nflow.set('blockBath', true);\n\nreturn {\n    payload: {value: value}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 780,
        "wires": [
            [
                "f4a7fe6a.7b58c",
                "7b29d339.031a74"
            ]
        ]
    },
    {
        "id": "f4a7fe6a.7b58c",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "dbd4ae03.f94db",
            "c0382aa6.c634b"
        ],
        "x": 1335,
        "y": 720,
        "wires": []
    },
    {
        "id": "f7ef839b.957768",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "block disable",
        "func": "if(!!flow.get('blockBath') && msg.payload.value.node_id === 18) {\n    flow.set('disableBath', true);\n    return;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 180,
        "wires": [
            [
                "2bf814c2.6a22a4"
            ]
        ]
    },
    {
        "id": "bd99b157.5a1278",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "remove block",
        "func": "flow.set('disableBath', false);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 400,
        "wires": [
            [
                "154382e4.e646fd"
            ]
        ]
    },
    {
        "id": "7b29d339.031a74",
        "type": "stoptimer",
        "z": "d849a1af.eac2a8",
        "duration": "15",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 1420,
        "y": 780,
        "wires": [
            [
                "246ebb00.530cae"
            ],
            []
        ]
    },
    {
        "id": "246ebb00.530cae",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "check disable",
        "func": "flow.set('blockBath', false);\n\nif(!!flow.get('disableBath')) {\n    return [msg, null];\n}\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1620,
        "y": 760,
        "wires": [
            [
                "aff74b80.3bbb48"
            ],
            [
                "56255f3d.4a0b6"
            ]
        ]
    },
    {
        "id": "56255f3d.4a0b6",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "enable",
        "func": "const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Energy Heat'\n    };\n\nreturn {\n    payload: {value: value}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1810,
        "y": 780,
        "wires": [
            [
                "7d39247a.3785bc"
            ]
        ]
    },
    {
        "id": "aff74b80.3bbb48",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "disable",
        "func": "const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nreturn {\n    payload: {value: value}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1820,
        "y": 740,
        "wires": [
            [
                "7d39247a.3785bc"
            ]
        ]
    },
    {
        "id": "7d39247a.3785bc",
        "type": "link out",
        "z": "d849a1af.eac2a8",
        "name": "",
        "links": [
            "dbd4ae03.f94db",
            "c0382aa6.c634b"
        ],
        "x": 1955,
        "y": 760,
        "wires": []
    },
    {
        "id": "d3f0696.ccfd018",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "get bath thermo",
        "func": "msg.payload = {\"$or\":[{\"nodeid\":18},{\"nodeid\":17}]};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 780,
        "wires": [
            [
                "d36b5c11.845a68"
            ]
        ]
    },
    {
        "id": "d36b5c11.845a68",
        "type": "mongodb in",
        "z": "d849a1af.eac2a8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get zwave nodes",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 930,
        "y": 780,
        "wires": [
            [
                "dd42618.b8dd6a"
            ]
        ]
    },
    {
        "id": "dd42618.b8dd6a",
        "type": "function",
        "z": "d849a1af.eac2a8",
        "name": "check off",
        "func": "const bath = msg.payload.find(x=>x.nodeid === 18);\nconst light =  msg.payload.find(x=>x.nodeid === 17);\n\nif(!light.values.find(x=>x.value_id === '17-37-1-0').value) {\n    return;\n}\n\nif(bath.values.find(x=>x.value_id === '18-64-1-0').value === 'Off') {\n    flow.set('disableBath', true);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1100,
        "y": 780,
        "wires": [
            [
                "cd11820a.e9c2"
            ]
        ]
    },
    {
        "id": "516f7917.37a7f",
        "type": "mongodb in",
        "z": "1cc6b114.588857",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get zwave nodes",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 530,
        "y": 800,
        "wires": [
            [
                "d79bb8f3.11df38"
            ]
        ]
    },
    {
        "id": "d79bb8f3.11df38",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is on",
        "func": "const switchK = msg.payload[0];\nmsg.payload = msg.cache;\n\nif(switchK.values.some(x=>x.value_id === '39-37-1-0' && x.value)) {\n    return;\n}\n\nmsg.on = switchK.values.some(x=>x.value_id === '39-37-2-0' && x.value);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 800,
        "wires": [
            [
                "548621e1.14e81"
            ]
        ]
    },
    {
        "id": "8a76daac.4fbd1",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get switch",
        "func": "msg.cache = msg.payload;\nmsg.payload = {nodeid: 39};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 800,
        "wires": [
            [
                "516f7917.37a7f"
            ]
        ]
    },
    {
        "id": "3f7301b4.514c46",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "свет в ванной",
        "info": "",
        "x": 220,
        "y": 1020,
        "wires": []
    },
    {
        "id": "dcb28d36.d6ec6",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "общий свет",
        "info": "",
        "x": 210,
        "y": 1460,
        "wires": []
    },
    {
        "id": "36ca3b15.67a4ec",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check main",
        "func": "if(msg.payload.class_id === 37 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value && msg.payload.node_id === 39) {\n    return {payload: 'stop'}\n}\n\nreturn;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 880,
        "wires": [
            [
                "6bdd953.c0f7a6c"
            ]
        ]
    },
    {
        "id": "fe68c399.afabf",
        "type": "RM",
        "z": "fdd35751.cb5538",
        "name": "living",
        "device": "46e35d6a.85f28c",
        "action": "_msg_",
        "remote": "",
        "button": "",
        "fix": 1,
        "RFSweep": "false",
        "x": 1750,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "4186433d.30b20c",
        "type": "link in",
        "z": "fdd35751.cb5538",
        "name": "send message",
        "links": [
            "44bc88.16993378"
        ],
        "x": 1435,
        "y": 220,
        "wires": [
            [
                "f37f1e2a.a7a6b8"
            ]
        ]
    },
    {
        "id": "f37f1e2a.a7a6b8",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "prepare data",
        "func": "\nreturn {\n    payload: {\n        action: 'send',\n        data: msg.payload.data\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1570,
        "y": 220,
        "wires": [
            [
                "fe68c399.afabf"
            ]
        ]
    },
    {
        "id": "50f2694d.aa2aa",
        "type": "mqtt in dynamic",
        "z": "fdd35751.cb5538",
        "topic": "/media/request",
        "qos": "1",
        "name": "media in",
        "broker": "7c5f5dec.00cb4c",
        "x": 100,
        "y": 120,
        "wires": [
            [
                "c9531ead.358cf8"
            ]
        ]
    },
    {
        "id": "74ee808e.cbd578",
        "type": "switch",
        "z": "fdd35751.cb5538",
        "name": "command",
        "property": "payload.action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "pc",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "vol+",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "vol-",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "mute",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "tvoff",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "tvon",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "server",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 8,
        "x": 440,
        "y": 120,
        "wires": [
            [
                "270ea341.7cc754"
            ],
            [
                "72e4d08f.d1c2b8"
            ],
            [
                "82d56a33.f0cf3"
            ],
            [
                "d816176d.4c3ef"
            ],
            [
                "36db3b51.c25bdc"
            ],
            [
                "a0d196d6.b06718"
            ],
            [
                "327e5cfa.1ec9f4"
            ],
            [
                "25c8cfa7.cb4c18"
            ]
        ]
    },
    {
        "id": "c9531ead.358cf8",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "cache",
        "func": "msg.action = msg.payload.action;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 270,
        "y": 120,
        "wires": [
            [
                "74ee808e.cbd578",
                "54002ca0.54886c"
            ]
        ]
    },
    {
        "id": "995ea717.086b8",
        "type": "mongodb in",
        "z": "fdd35751.cb5538",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get",
        "collection": "media",
        "operation": "find",
        "x": 830,
        "y": 140,
        "wires": [
            [
                "990c0c2a.e98348"
            ]
        ]
    },
    {
        "id": "270ea341.7cc754",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {\"$or\":[{\"id\":\"ampon\"},{\"id\":\"switchon\"},{\"id\":\"switch1\"}]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 40,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "44bc88.16993378",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "4186433d.30b20c"
        ],
        "x": 1195,
        "y": 140,
        "wires": []
    },
    {
        "id": "36db3b51.c25bdc",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {\"$or\":[{\"id\":\"switchoff\"},{\"id\":\"ampoff\"},{\"id\":\"tvoff\"}]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 200,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "72e4d08f.d1c2b8",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {id: \"ampv+\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 80,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "82d56a33.f0cf3",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {id: \"ampv-\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 120,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "d816176d.4c3ef",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {id: \"ampmute\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 160,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "69b6701f.fdb08",
        "type": "link in",
        "z": "fdd35751.cb5538",
        "name": "save action",
        "links": [
            "f1e24a82.827e9"
        ],
        "x": 1435,
        "y": 160,
        "wires": [
            [
                "174d8176.f58307"
            ]
        ]
    },
    {
        "id": "4ad387e4.9c309",
        "type": "mongodb out",
        "z": "fdd35751.cb5538",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save media action",
        "collection": "media",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 1770,
        "y": 160,
        "wires": []
    },
    {
        "id": "f1e24a82.827e9",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "69b6701f.fdb08"
        ],
        "x": 475,
        "y": 460,
        "wires": []
    },
    {
        "id": "174d8176.f58307",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "prepare msg",
        "func": "const $set = {$set: {action: msg.action}};\nconst query = {id: \"status\"};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 160,
        "wires": [
            [
                "4ad387e4.9c309"
            ]
        ]
    },
    {
        "id": "e93b9ee2.d0fdb8",
        "type": "inject",
        "z": "fdd35751.cb5538",
        "name": "inject id",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.5",
        "x": 120,
        "y": 620,
        "wires": [
            [
                "9055dfd7.e378b8"
            ]
        ]
    },
    {
        "id": "a7990fec.c6fe6",
        "type": "mongodb in",
        "z": "fdd35751.cb5538",
        "mongodb": "3bb6209c.4b0d08",
        "name": "media",
        "collection": "media",
        "operation": "find",
        "x": 490,
        "y": 620,
        "wires": [
            [
                "abfb54e8.9a6e88"
            ]
        ]
    },
    {
        "id": "4f905663.4fa238",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "3bee2de6.c7d152"
        ],
        "x": 795,
        "y": 620,
        "wires": []
    },
    {
        "id": "abfb54e8.9a6e88",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "send all",
        "func": "msg.topic = '/media/all/response';\nmsg.payload = {action: msg.payload[0].action};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 620,
        "wires": [
            [
                "4f905663.4fa238"
            ]
        ]
    },
    {
        "id": "8d71c188.d3a938",
        "type": "mqtt in dynamic",
        "z": "fdd35751.cb5538",
        "topic": "/media/all/request",
        "qos": "1",
        "name": "media in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 680,
        "wires": [
            [
                "9055dfd7.e378b8"
            ]
        ]
    },
    {
        "id": "9055dfd7.e378b8",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "inject ids",
        "func": "msg.payload = {id: \"status\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 620,
        "wires": [
            [
                "a7990fec.c6fe6"
            ]
        ]
    },
    {
        "id": "3bee2de6.c7d152",
        "type": "link in",
        "z": "fdd35751.cb5538",
        "name": "mqtt out",
        "links": [
            "4f905663.4fa238",
            "767820bd.f779a8",
            "65211e02.66dd5"
        ],
        "x": 1435,
        "y": 280,
        "wires": [
            [
                "affea767.c13618"
            ]
        ]
    },
    {
        "id": "c72797fd.9bd97",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "send status",
        "func": "\nreturn {\n    topic: '/media/response',\n    payload: {\n        action: msg.action\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 420,
        "wires": [
            [
                "767820bd.f779a8"
            ]
        ]
    },
    {
        "id": "767820bd.f779a8",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "3bee2de6.c7d152"
        ],
        "x": 655,
        "y": 420,
        "wires": []
    },
    {
        "id": "affea767.c13618",
        "type": "mqtt out dynamic",
        "z": "fdd35751.cb5538",
        "name": "media out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1560,
        "y": 280,
        "wires": []
    },
    {
        "id": "990c0c2a.e98348",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "send with delay",
        "func": "function getNext(nodelay = false) {\n    if(!msg.payload.length) return;\n     const item = msg.payload.shift();\n     \n     setTimeout(() => {\n         node.send({payload: item});\n         getNext();\n     }, nodelay ? 0 : 3000);\n}\n\ngetNext(true);",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 140,
        "wires": [
            [
                "44bc88.16993378"
            ]
        ]
    },
    {
        "id": "54002ca0.54886c",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "save action",
        "func": "if(msg.payload.action === 'off' || msg.payload.action === 'pc' || msg.payload.action === 'server')\n    return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 420,
        "wires": [
            [
                "c72797fd.9bd97",
                "f1e24a82.827e9"
            ]
        ]
    },
    {
        "id": "d00b1d69.ffde88",
        "type": "function",
        "z": "f3145e9a.1298d",
        "name": "check smoke",
        "func": "if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value && msg.payload.node_id === 45) {\n    return {payload:{}};\n}\n\nreturn;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 140,
        "wires": [
            [
                "a427ac92.1811d",
                "6d7ba2c0.98dc74"
            ]
        ]
    },
    {
        "id": "d1120c30.60b3d",
        "type": "mqtt in dynamic",
        "z": "f3145e9a.1298d",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "get zwave params",
        "broker": "7c5f5dec.00cb4c",
        "x": 250,
        "y": 140,
        "wires": [
            [
                "d00b1d69.ffde88"
            ]
        ]
    },
    {
        "id": "6d7ba2c0.98dc74",
        "type": "function",
        "z": "f3145e9a.1298d",
        "name": "send vent off",
        "func": "return {\n    topic: '/ventilation/setpower/request',\n    payload: {value: 0}\n    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 100,
        "wires": [
            [
                "327c698f.371d9e"
            ]
        ]
    },
    {
        "id": "a427ac92.1811d",
        "type": "function",
        "z": "f3145e9a.1298d",
        "name": "smoke msg",
        "func": "return {\n    payload: {\n        content: 'Произошло задымление'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 200,
        "wires": [
            [
                "9784d4a7.08377"
            ]
        ]
    },
    {
        "id": "9784d4a7.08377",
        "type": "subflow:5b528460.e43bb4",
        "z": "f3145e9a.1298d",
        "name": "",
        "x": 880,
        "y": 200,
        "wires": []
    },
    {
        "id": "5976c2d1.3df93c",
        "type": "mqtt out dynamic",
        "z": "f3145e9a.1298d",
        "name": "",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1550,
        "y": 100,
        "wires": []
    },
    {
        "id": "33050fce.cd9ca8",
        "type": "link in",
        "z": "f3145e9a.1298d",
        "name": "mqtt out",
        "links": [
            "327c698f.371d9e"
        ],
        "x": 1415,
        "y": 100,
        "wires": [
            [
                "5976c2d1.3df93c"
            ]
        ]
    },
    {
        "id": "327c698f.371d9e",
        "type": "link out",
        "z": "f3145e9a.1298d",
        "name": "",
        "links": [
            "33050fce.cd9ca8"
        ],
        "x": 775,
        "y": 100,
        "wires": []
    },
    {
        "id": "d705c4fd.a24558",
        "type": "mqtt in dynamic",
        "z": "f0ffdbb3.6e78b",
        "topic": "/co2/response",
        "qos": "1",
        "name": "co2",
        "broker": "7c5f5dec.00cb4c",
        "x": 130,
        "y": 1160,
        "wires": [
            [
                "ee7d8752.59cfa"
            ]
        ]
    },
    {
        "id": "ee7d8752.59cfa",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "co2 in",
        "links": [
            "9991bbb3.27458",
            "2dc5b09e.d4f058",
            "33ef985d.fa3c6",
            "e68cfadc.320358"
        ],
        "x": 225,
        "y": 1160,
        "wires": []
    },
    {
        "id": "9991bbb3.27458",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "ee7d8752.59cfa"
        ],
        "x": 1075,
        "y": 940,
        "wires": [
            [
                "d57e2a56.8e1688"
            ]
        ]
    },
    {
        "id": "d57e2a56.8e1688",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "transform",
        "func": "const data = msg.payload;\n\nconst tags = {\n    co2: data.index\n}\n\nmsg.measurement = 'sensors';\nmsg.payload = [{\n            value: Number(data.co2)\n        }];\n        \n        msg.payload[1] = tags;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1190,
        "y": 940,
        "wires": [
            [
                "24690cbd.2694a4"
            ]
        ]
    },
    {
        "id": "24690cbd.2694a4",
        "type": "influxdb out",
        "z": "f0ffdbb3.6e78b",
        "influxdb": "aeffd74.491f0a8",
        "name": "save influx",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "x": 1370,
        "y": 940,
        "wires": []
    },
    {
        "id": "694bc047.99839",
        "type": "mqtt in dynamic",
        "z": "1cc6b114.588857",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "zwave in",
        "broker": "7c5f5dec.00cb4c",
        "x": 1740,
        "y": 200,
        "wires": [
            [
                "a7227347.fe94b"
            ]
        ]
    },
    {
        "id": "a7227347.fe94b",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "zwave in",
        "links": [
            "67fa80fd.ee7c7",
            "6b358373.980524",
            "840a16a5.544688",
            "8b3c626f.79c9b8"
        ],
        "x": 1855,
        "y": 200,
        "wires": []
    },
    {
        "id": "67fa80fd.ee7c7",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "a7227347.fe94b",
            "f7fa672c.d74928",
            "55f88d1a.ea6f14"
        ],
        "x": 100,
        "y": 880,
        "wires": [
            [
                "4d108938.e0b578",
                "36ca3b15.67a4ec"
            ]
        ]
    },
    {
        "id": "6b358373.980524",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "a7227347.fe94b",
            "f7fa672c.d74928",
            "55f88d1a.ea6f14"
        ],
        "x": 75,
        "y": 240,
        "wires": [
            [
                "d3191457.8c8518"
            ]
        ]
    },
    {
        "id": "861c9daa.1424f8",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "sunset",
        "endTime": "sunset",
        "startOffset": "-240",
        "endOffset": "120",
        "x": 920,
        "y": 200,
        "wires": [
            [
                "79681b13.e2d1e4"
            ],
            []
        ]
    },
    {
        "id": "604cdf5e.2e3e9",
        "type": "mqtt in dynamic",
        "z": "51524d6e.749374",
        "topic": "/system/presence",
        "qos": "1",
        "name": "presence",
        "broker": "7c5f5dec.00cb4c",
        "x": 1720,
        "y": 580,
        "wires": [
            [
                "84388961.86a0e"
            ]
        ]
    },
    {
        "id": "460350e9.008b58",
        "type": "mqtt in dynamic",
        "z": "51524d6e.749374",
        "topic": "/system/warmup",
        "qos": "1",
        "name": "warmup",
        "broker": "7c5f5dec.00cb4c",
        "x": 1720,
        "y": 620,
        "wires": [
            [
                "4f9055eb.2cc1dc"
            ]
        ]
    },
    {
        "id": "365afd44.4e89fa",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "params in",
        "links": [
            "4f9055eb.2cc1dc",
            "e40edfae.8569b8"
        ],
        "x": 95,
        "y": 60,
        "wires": [
            [
                "a87ec694.864278"
            ]
        ]
    },
    {
        "id": "1caad64a.028b72",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "c1783ccd.a18418"
        ],
        "x": 1735,
        "y": 60,
        "wires": []
    },
    {
        "id": "84388961.86a0e",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "presence in",
        "links": [
            "4abc9505.26a954",
            "98cac971.a67f8"
        ],
        "x": 1835,
        "y": 580,
        "wires": []
    },
    {
        "id": "4abc9505.26a954",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "6523cb5b.28d794",
            "84388961.86a0e"
        ],
        "x": 95,
        "y": 140,
        "wires": [
            [
                "37dbddb6.5427c2"
            ]
        ]
    },
    {
        "id": "37dbddb6.5427c2",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "no one home?",
        "func": "if(!msg.payload.presence) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 140,
        "wires": [
            [
                "119c5735.4e20f9"
            ]
        ]
    },
    {
        "id": "6be03f17.f975c",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "disable cond living",
        "func": "if(msg.c && !msg.c.enabled) return;\n\nreturn {\n    payload: {\n    id: 1,\n    temperature: 25,\n    fan : 0,\n    enabled : false,\n    mode : \"cool\",\n    powerChange: true\n}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 840,
        "wires": [
            [
                "a68fc278.938018"
            ]
        ]
    },
    {
        "id": "1085a32d.18939d",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "disable cond vika",
        "func": "\nif(msg.c && !msg.c.enabled) return;\n\nreturn {\n    payload: {\n    id: 2,\n    temperature: 25,\n    fan : 0,\n    enabled : false,\n    mode : \"cool\",\n    powerChange: true\n}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 800,
        "wires": [
            [
                "391db2c0.6e41e6"
            ]
        ]
    },
    {
        "id": "391db2c0.6e41e6",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "d13420ce.1a5598"
        ],
        "x": 1865,
        "y": 800,
        "wires": []
    },
    {
        "id": "a68fc278.938018",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "d13420ce.1a5598"
        ],
        "x": 1865,
        "y": 840,
        "wires": []
    },
    {
        "id": "cecb9b12.adcef8",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "disable vcond",
        "links": [
            "119c5735.4e20f9",
            "9d32b520.67174",
            "3e0f9913.18dcae",
            "fdaf3524.427888"
        ],
        "x": 1575,
        "y": 800,
        "wires": [
            [
                "1085a32d.18939d"
            ]
        ]
    },
    {
        "id": "66bf633b.3d2fc4",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "disable our cond",
        "links": [
            "119c5735.4e20f9",
            "cc85d946.87444",
            "ee751523.a63e88",
            "fdaf3524.427888"
        ],
        "x": 1575,
        "y": 840,
        "wires": [
            [
                "6be03f17.f975c"
            ]
        ]
    },
    {
        "id": "119c5735.4e20f9",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "cecb9b12.adcef8",
            "66bf633b.3d2fc4"
        ],
        "x": 355,
        "y": 140,
        "wires": []
    },
    {
        "id": "4f9055eb.2cc1dc",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "warmup in",
        "links": [
            "365afd44.4e89fa",
            "575451d9.0ce0a8"
        ],
        "x": 1835,
        "y": 620,
        "wires": []
    },
    {
        "id": "4846ed04.9b2ecc",
        "type": "inject",
        "z": "51524d6e.749374",
        "name": "every hour",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 1730,
        "y": 740,
        "wires": [
            [
                "e40edfae.8569b8"
            ]
        ]
    },
    {
        "id": "e40edfae.8569b8",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "every hour in",
        "links": [
            "365afd44.4e89fa",
            "575451d9.0ce0a8"
        ],
        "x": 1835,
        "y": 740,
        "wires": []
    },
    {
        "id": "2110b00c.03b05",
        "type": "mqtt in dynamic",
        "z": "51524d6e.749374",
        "topic": "/system/vacation",
        "qos": "1",
        "name": "vacation event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1720,
        "y": 680,
        "wires": [
            [
                "6523cb5b.28d794"
            ]
        ]
    },
    {
        "id": "6523cb5b.28d794",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "vacation in",
        "links": [
            "4abc9505.26a954",
            "575451d9.0ce0a8"
        ],
        "x": 1835,
        "y": 680,
        "wires": []
    },
    {
        "id": "38b34a7e.d0d8ce",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "enable cond living",
        "func": "if(msg.c)\n{\n    if(msg.c.enabled &&\n    msg.c.temperature === msg.payload.temperature &&\n    msg.c.mode === msg.payload.mode) {\n        return;\n    }\n}\n\nreturn {\n    payload: {\n    id: 1,\n    temperature: msg.payload.temperature,\n    fan : 0,\n    enabled : true,\n    mode : msg.payload.mode,\n    powerChange: !msg.c.enabled,\n}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 920,
        "wires": [
            [
                "a2adc5c5.ffe4f8"
            ]
        ]
    },
    {
        "id": "a8a8f748.96f9f8",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "enable cond vika",
        "func": "if(msg.c)\n{\n    if(msg.c.enabled &&\n    msg.c.temperature === msg.payload.temperature &&\n    msg.c.mode === msg.payload.mode) {\n        return;\n    }\n}\n\nreturn {\n    payload: {\n    id: 2,\n    temperature: msg.payload.temperature,\n    fan : 0,\n    enabled : true,\n    mode : msg.payload.mode,\n    powerChange: !msg.c.enabled,\n}\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 880,
        "wires": [
            [
                "d82ca6ec.e7dfd"
            ]
        ]
    },
    {
        "id": "af4ba7ce.a251d8",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "enable vcond",
        "links": [
            "b0813db.30ffac",
            "ffe865ce.113818"
        ],
        "x": 1575,
        "y": 880,
        "wires": [
            [
                "a8a8f748.96f9f8"
            ]
        ]
    },
    {
        "id": "a2adc5c5.ffe4f8",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "d13420ce.1a5598"
        ],
        "x": 1875,
        "y": 920,
        "wires": []
    },
    {
        "id": "d82ca6ec.e7dfd",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "d13420ce.1a5598"
        ],
        "x": 1875,
        "y": 880,
        "wires": []
    },
    {
        "id": "156a6894.8a8ddf",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "enable our cond",
        "links": [
            "d660e560.17bbb",
            "e888a670.4da1f8"
        ],
        "x": 1575,
        "y": 920,
        "wires": [
            [
                "38b34a7e.d0d8ce"
            ]
        ]
    },
    {
        "id": "c1783ccd.a18418",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "data in",
        "links": [
            "1caad64a.028b72"
        ],
        "x": 75,
        "y": 400,
        "wires": [
            [
                "e5a73b73.754268"
            ]
        ]
    },
    {
        "id": "e5a73b73.754268",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "duplicate",
        "func": "const vikaMsg = {...msg};\nconst livingMsg = {...msg};\n\nvikaMsg.payload = {\n    id: 2,\n    temperature: msg.zwave.find(x=>x.nodeid === 33).temperature[0]\n};\n\nlivingMsg.payload = {\n    id: 1,\n    temperature: msg.zwave.find(x=>x.nodeid === 31).temperature[0]\n};\n\nreturn [livingMsg, vikaMsg];",
        "outputs": 2,
        "noerr": 0,
        "x": 180,
        "y": 400,
        "wires": [
            [
                "8939f876.b93cc8"
            ],
            [
                "8939f876.b93cc8"
            ]
        ]
    },
    {
        "id": "8939f876.b93cc8",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "no one home",
        "func": "if(msg.presence) {\n    return [msg, null]\n}\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 350,
        "y": 400,
        "wires": [
            [
                "318891d2.a9d566"
            ],
            [
                "318891d2.a9d566",
                "e275b65c.5bdd88"
            ]
        ]
    },
    {
        "id": "fe8f690a.fabe",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "logic day",
        "func": "const temperature = msg.payload.temperature.value;\n\nconst result = {temperature: 27, mode: 'cool', id: msg.payload.id};\nlet disable = false;\n\nif(temperature <= 24) {\n    result.temperature = 24;\n    result.mode = 'warm';\n}\n\n\nif(temperature < 26 && temperature > 24) {\n    disable = true;\n}\n\n\nif(temperature >= 26 && temperature <= 27) {\n    result.temperature = 27;\n    result.mode = 'cool';\n}\n\nif(temperature > 27) {\n    result.temperature = 26;\n    result.mode = 'cool';\n}\n\nconst cond = msg.conditionaire.find(x=>x.id === msg.payload.id);\n\nreturn [!disable ? {payload: result, c: cond, weather: msg.weather} : null, !disable ? null : {payload: {id: msg.payload.id}, c: cond}];",
        "outputs": 2,
        "noerr": 0,
        "x": 780,
        "y": 380,
        "wires": [
            [
                "6b7e0a08.2f46e4"
            ],
            [
                "320d07ff.88fba8"
            ]
        ]
    },
    {
        "id": "320d07ff.88fba8",
        "type": "switch",
        "z": "51524d6e.749374",
        "name": "",
        "property": "payload.id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1150,
        "y": 460,
        "wires": [
            [
                "cc85d946.87444"
            ],
            [
                "9d32b520.67174"
            ]
        ]
    },
    {
        "id": "cc85d946.87444",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "66bf633b.3d2fc4"
        ],
        "x": 1245,
        "y": 440,
        "wires": []
    },
    {
        "id": "9d32b520.67174",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "cecb9b12.adcef8"
        ],
        "x": 1245,
        "y": 500,
        "wires": []
    },
    {
        "id": "e4067e34.7b113",
        "type": "switch",
        "z": "51524d6e.749374",
        "name": "",
        "property": "payload.id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1130,
        "y": 340,
        "wires": [
            [
                "d660e560.17bbb"
            ],
            [
                "b0813db.30ffac"
            ]
        ]
    },
    {
        "id": "d660e560.17bbb",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "156a6894.8a8ddf"
        ],
        "x": 1245,
        "y": 320,
        "wires": []
    },
    {
        "id": "b0813db.30ffac",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "af4ba7ce.a251d8"
        ],
        "x": 1245,
        "y": 380,
        "wires": []
    },
    {
        "id": "6249e9e7.3b9818",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "logic night",
        "func": "const temperature = msg.payload.temperature.value;\n\nconst result = {temperature: 27, mode: 'cool', id: msg.payload.id};\nlet disable = false;\n\nif(temperature <= 24) {\n    result.temperature = 24;\n    result.mode = 'warm';\n}\n\n\nif(temperature < 26.5 && temperature > 24) {\n    disable = true;\n}\n\n\nif(temperature >= 26.5 && temperature < 28) {\n    result.temperature = 27;\n    result.mode = 'cool';\n}\n\nif(temperature >= 28 && temperature < 30) {\n    result.temperature = 26;\n    result.mode = 'cool';\n}\n\nif(temperature >= 30) {\n    result.temperature = 25;\n    result.mode = 'cool';\n}\n\n\nconst cond = msg.conditionaire.find(x=>x.id === msg.payload.id);\n\n\nreturn [!disable ? {payload: result, c: cond, weather: msg.weather} : null, !disable ? null : {payload: {id: msg.payload.id}, c: cond}];",
        "outputs": 2,
        "noerr": 0,
        "x": 780,
        "y": 420,
        "wires": [
            [
                "6b7e0a08.2f46e4"
            ],
            [
                "320d07ff.88fba8"
            ]
        ]
    },
    {
        "id": "318891d2.a9d566",
        "type": "time-range-switch",
        "z": "51524d6e.749374",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "10:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": 0,
        "x": 580,
        "y": 400,
        "wires": [
            [
                "fe8f690a.fabe"
            ],
            [
                "6249e9e7.3b9818"
            ]
        ]
    },
    {
        "id": "fdaf3524.427888",
        "type": "link out",
        "z": "51524d6e.749374",
        "name": "",
        "links": [
            "cecb9b12.adcef8",
            "66bf633b.3d2fc4"
        ],
        "x": 655,
        "y": 500,
        "wires": []
    },
    {
        "id": "e275b65c.5bdd88",
        "type": "stoptimer",
        "z": "51524d6e.749374",
        "duration": "15",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 500,
        "y": 500,
        "wires": [
            [
                "fdaf3524.427888"
            ],
            []
        ]
    },
    {
        "id": "575451d9.0ce0a8",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "params in",
        "links": [
            "6523cb5b.28d794",
            "4f9055eb.2cc1dc",
            "e40edfae.8569b8"
        ],
        "x": 195,
        "y": 460,
        "wires": [
            [
                "a38ca81e.6efca8"
            ]
        ]
    },
    {
        "id": "a38ca81e.6efca8",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "set stop",
        "func": "\nreturn {payload: 'stop'};",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 500,
        "wires": [
            [
                "e275b65c.5bdd88"
            ]
        ]
    },
    {
        "id": "98cac971.a67f8",
        "type": "link in",
        "z": "51524d6e.749374",
        "name": "params in",
        "links": [
            "84388961.86a0e"
        ],
        "x": 35,
        "y": 540,
        "wires": [
            [
                "eb17c16b.d6fb78"
            ]
        ]
    },
    {
        "id": "eb17c16b.d6fb78",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "some one home?",
        "func": "if(msg.payload.presence) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 150,
        "y": 540,
        "wires": [
            [
                "a38ca81e.6efca8"
            ]
        ]
    },
    {
        "id": "88b72ec4.22fd7",
        "type": "mqtt in dynamic",
        "z": "db61ef7a.7e00d8",
        "topic": "/zwave/changevalue/response",
        "qos": "1",
        "name": "zwave in",
        "broker": "7c5f5dec.00cb4c",
        "x": 1500,
        "y": 80,
        "wires": [
            [
                "55f88d1a.ea6f14"
            ]
        ]
    },
    {
        "id": "55f88d1a.ea6f14",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "zwave in",
        "links": [
            "67fa80fd.ee7c7",
            "6b358373.980524",
            "1d238a9f.5f5825"
        ],
        "x": 1615,
        "y": 80,
        "wires": []
    },
    {
        "id": "1d238a9f.5f5825",
        "type": "link in",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "55f88d1a.ea6f14"
        ],
        "x": 135,
        "y": 1180,
        "wires": [
            [
                "cb758f1a.5176"
            ]
        ]
    },
    {
        "id": "36a06d57.ae268a",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "cache",
        "func": "msg.cache = msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 1180,
        "wires": [
            [
                "55b0a9a2.f5ab18",
                "711f9b26.8ccae4",
                "4f2c9d4f.4f498c"
            ]
        ]
    },
    {
        "id": "6a8c8c03.ac80b4",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get light vika",
        "func": "if(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 250) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 150) {\n    return [null, msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 2090,
        "y": 1140,
        "wires": [
            [
                "1a904ee.f693731"
            ],
            [
                "a232fa1.946f208"
            ]
        ]
    },
    {
        "id": "cb758f1a.5176",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "some one home? and nodes",
        "func": "if(msg.payload.node_id !== 33 && msg.payload.node_id !== 31 && msg.payload.node_id !== 29) return;\n\nif(global.get('presence') && !global.get('isNight')) {\n    return msg;\n}\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 1180,
        "wires": [
            [
                "36a06d57.ae268a"
            ]
        ]
    },
    {
        "id": "6d43a9e8.678f1",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get light living",
        "func": "if(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 350) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 250) {\n    return [null, msg];\n}\n",
        "outputs": 2,
        "noerr": 0,
        "x": 2100,
        "y": 1180,
        "wires": [
            [
                "4fb34741.6b0048"
            ],
            [
                "dc296cc4.a8691"
            ]
        ]
    },
    {
        "id": "51df6d03.3f8594",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get light kitchen",
        "func": "if(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 300) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 250) {\n    return [null, msg];\n}\n",
        "outputs": 2,
        "noerr": 0,
        "x": 2100,
        "y": 1220,
        "wires": [
            [
                "19532839.8fa6a"
            ],
            [
                "1906199e.dcd0b6"
            ]
        ]
    },
    {
        "id": "dc296cc4.a8691",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open livingroom",
        "func": "const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2380,
        "y": 1180,
        "wires": [
            [
                "d9503213.4c7f58"
            ]
        ]
    },
    {
        "id": "a232fa1.946f208",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open vika",
        "func": "const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2360,
        "y": 1100,
        "wires": [
            [
                "3f0b4999.8901b6"
            ]
        ]
    },
    {
        "id": "1906199e.dcd0b6",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "open kitchen",
        "func": "const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2370,
        "y": 1260,
        "wires": [
            [
                "d802fd19.de2c5"
            ]
        ]
    },
    {
        "id": "3f0b4999.8901b6",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2475,
        "y": 1100,
        "wires": []
    },
    {
        "id": "d9503213.4c7f58",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2495,
        "y": 1180,
        "wires": []
    },
    {
        "id": "d802fd19.de2c5",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2475,
        "y": 1260,
        "wires": []
    },
    {
        "id": "1a904ee.f693731",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "half open vika",
        "func": "const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2340,
        "y": 1060,
        "wires": [
            [
                "9a66e68f.c6802"
            ]
        ]
    },
    {
        "id": "9a66e68f.c6802",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2475,
        "y": 1060,
        "wires": []
    },
    {
        "id": "104ae36d.657df5",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2535,
        "y": 1140,
        "wires": []
    },
    {
        "id": "4fb34741.6b0048",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "half open livingroom",
        "func": "const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2400,
        "y": 1140,
        "wires": [
            [
                "104ae36d.657df5"
            ]
        ]
    },
    {
        "id": "94a2291.24efcd8",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "24024b7d.54181c",
            "56c6bee5.88f648"
        ],
        "x": 2515,
        "y": 1220,
        "wires": []
    },
    {
        "id": "19532839.8fa6a",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "half open kitchen",
        "func": "const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2390,
        "y": 1220,
        "wires": [
            [
                "94a2291.24efcd8"
            ]
        ]
    },
    {
        "id": "d98f62a7.6819b8",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "4",
        "units": "Second",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "90abc034.2cd6b8"
            ],
            []
        ]
    },
    {
        "id": "d3191457.8c8518",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check nodes",
        "func": "if(msg.payload.node_id !== 2 && msg.payload.node_id !== 11 && msg.payload.node_id !== 25) return;\n\nif(msg.payload.class_id === 38 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) return msg;\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 240,
        "wires": [
            [
                "4d4f13b7.d065ec"
            ]
        ]
    },
    {
        "id": "4d4f13b7.d065ec",
        "type": "switch",
        "z": "1cc6b114.588857",
        "name": "",
        "property": "payload.node_id",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "11",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "25",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 350,
        "y": 240,
        "wires": [
            [
                "d98f62a7.6819b8"
            ],
            [
                "aec591b8.0bf6f"
            ],
            [
                "85bbed8d.370ce"
            ]
        ]
    },
    {
        "id": "aec591b8.0bf6f",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "4",
        "units": "Second",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 540,
        "y": 260,
        "wires": [
            [
                "90abc034.2cd6b8"
            ],
            []
        ]
    },
    {
        "id": "85bbed8d.370ce",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "4",
        "units": "Second",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 540,
        "y": 300,
        "wires": [
            [
                "90abc034.2cd6b8"
            ],
            []
        ]
    },
    {
        "id": "f21d446e.f5b938",
        "type": "mqtt in dynamic",
        "z": "1cc6b114.588857",
        "topic": "/system/night",
        "qos": "1",
        "name": "night event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1750,
        "y": 260,
        "wires": [
            [
                "271a13f2.343d54"
            ]
        ]
    },
    {
        "id": "271a13f2.343d54",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check night",
        "func": "if(msg.payload.night === false) return;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1910,
        "y": 260,
        "wires": [
            [
                "6fed593c.628718"
            ]
        ]
    },
    {
        "id": "6fed593c.628718",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "night on",
        "links": [
            "33315af9.298eee"
        ],
        "x": 2035,
        "y": 260,
        "wires": []
    },
    {
        "id": "33315af9.298eee",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "6fed593c.628718"
        ],
        "x": 55,
        "y": 400,
        "wires": [
            [
                "441a0da3.befccc",
                "cfc9a029.05a648",
                "5d17b86a.40c4b8"
            ]
        ]
    },
    {
        "id": "441a0da3.befccc",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check vika",
        "func": "msg.payload = 2;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 360,
        "wires": [
            [
                "898614c0.e25018"
            ]
        ]
    },
    {
        "id": "cfc9a029.05a648",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check living",
        "func": "msg.payload = 11;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 400,
        "wires": [
            [
                "ce71d5a3.80abf"
            ]
        ]
    },
    {
        "id": "5d17b86a.40c4b8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check kitchen",
        "func": "msg.payload = 25;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 240,
        "y": 440,
        "wires": [
            [
                "5edcea09.cf9514"
            ]
        ]
    },
    {
        "id": "5edcea09.cf9514",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 460,
        "y": 440,
        "wires": [
            [],
            [
                "4cb0178d.85b2c"
            ]
        ]
    },
    {
        "id": "ce71d5a3.80abf",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "x": 460,
        "y": 400,
        "wires": [
            [],
            [
                "6313b837.b62ef8"
            ]
        ]
    },
    {
        "id": "898614c0.e25018",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 460,
        "y": 360,
        "wires": [
            [],
            [
                "cd6c1f73.59f12"
            ]
        ]
    },
    {
        "id": "cd6c1f73.59f12",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "set vika",
        "func": "msg.payload = {nodeid: 2};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 340,
        "wires": [
            [
                "79681b13.e2d1e4"
            ]
        ]
    },
    {
        "id": "6313b837.b62ef8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "set living",
        "func": "msg.payload = {nodeid: 11};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 380,
        "wires": [
            [
                "79681b13.e2d1e4"
            ]
        ]
    },
    {
        "id": "4cb0178d.85b2c",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "setkitchen",
        "func": "msg.payload = {nodeid: 25};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 420,
        "wires": [
            [
                "79681b13.e2d1e4"
            ]
        ]
    },
    {
        "id": "c548158c.0c6a98",
        "type": "influxdb out",
        "z": "5dede675.638c1",
        "influxdb": "aeffd74.491f0a8",
        "name": "save influx",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "x": 1190,
        "y": 240,
        "wires": []
    },
    {
        "id": "22a2d167.b7ec06",
        "type": "function",
        "z": "5dede675.638c1",
        "name": "add measurement",
        "func": "msg.measurement = 'weather';\nmsg.payload = [{\n            temperature: Number(msg.payload.currently.temperature),\n            precip: Number(msg.payload.currently.precipProbability * 100)\n        }];\n        \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 240,
        "wires": [
            [
                "c548158c.0c6a98"
            ]
        ]
    },
    {
        "id": "55b0a9a2.f5ab18",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get switch vika",
        "func": "msg.nodeid = 4;\nmsg.payload = {nodeid: 4};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1140,
        "wires": [
            [
                "f6cfffa9.42b3"
            ]
        ]
    },
    {
        "id": "f6cfffa9.42b3",
        "type": "mongodb in",
        "z": "db61ef7a.7e00d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get switch",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 1020,
        "y": 1140,
        "wires": [
            [
                "6950ef6d.0d6b48"
            ]
        ]
    },
    {
        "id": "711f9b26.8ccae4",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get switch living",
        "func": "msg.nodeid = 9;\nmsg.payload = {nodeid: 9};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1180,
        "wires": [
            [
                "531029c8.1d0838"
            ]
        ]
    },
    {
        "id": "4f2c9d4f.4f498c",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "get switch kitchen",
        "func": "msg.nodeid = 39;\nmsg.payload = {nodeid: 39};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 1220,
        "wires": [
            [
                "a26324c8.3a3b9"
            ]
        ]
    },
    {
        "id": "6950ef6d.0d6b48",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check light",
        "func": "const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1140,
        "wires": [
            [
                "be9289d6.5a926"
            ]
        ]
    },
    {
        "id": "be9289d6.5a926",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check vika",
        "func": "msg.payload = 2;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1430,
        "y": 1140,
        "wires": [
            [
                "c022bf06.4cb0d8"
            ]
        ]
    },
    {
        "id": "2110a6ed.3ae2ea",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check living",
        "func": "msg.payload = 11;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1430,
        "y": 1180,
        "wires": [
            [
                "17bbbbaa.ed2fd4"
            ]
        ]
    },
    {
        "id": "3c433ad3.3e3716",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check kitchen",
        "func": "msg.payload = 25;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1440,
        "y": 1220,
        "wires": [
            [
                "aec386d5.b6a3c"
            ]
        ]
    },
    {
        "id": "aec386d5.b6a3c",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "env": [],
        "x": 1660,
        "y": 1220,
        "wires": [
            [],
            [
                "484d4c3c.69ea54"
            ]
        ]
    },
    {
        "id": "17bbbbaa.ed2fd4",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "x": 1660,
        "y": 1180,
        "wires": [
            [],
            [
                "abc31e87.bed11"
            ]
        ]
    },
    {
        "id": "c022bf06.4cb0d8",
        "type": "subflow:b02e364.3dde7c8",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "env": [],
        "x": 1660,
        "y": 1140,
        "wires": [
            [],
            [
                "a6dd0087.b705"
            ]
        ]
    },
    {
        "id": "531029c8.1d0838",
        "type": "mongodb in",
        "z": "db61ef7a.7e00d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get switch",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 1020,
        "y": 1180,
        "wires": [
            [
                "e286998.a9b5668"
            ]
        ]
    },
    {
        "id": "e286998.a9b5668",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check light",
        "func": "const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1180,
        "wires": [
            [
                "2110a6ed.3ae2ea"
            ]
        ]
    },
    {
        "id": "a26324c8.3a3b9",
        "type": "mongodb in",
        "z": "db61ef7a.7e00d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get switch",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 1020,
        "y": 1220,
        "wires": [
            [
                "490feafe.e3ab1c"
            ]
        ]
    },
    {
        "id": "490feafe.e3ab1c",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "check light",
        "func": "const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1220,
        "wires": [
            [
                "3c433ad3.3e3716"
            ]
        ]
    },
    {
        "id": "c45d3ca3.7f1c9",
        "type": "cron scheduler",
        "z": "db61ef7a.7e00d8",
        "name": "weekday",
        "schedule": "0 40 6 * * *",
        "x": 80,
        "y": 300,
        "wires": [
            [
                "fd22373b.aa8dc"
            ]
        ]
    },
    {
        "id": "fd22373b.aa8dc",
        "type": "subflow:b21069c1.94ff18",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "x": 270,
        "y": 300,
        "wires": [
            [],
            [
                "e8b4aa28.783148"
            ]
        ]
    },
    {
        "id": "e8b4aa28.783148",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 470,
        "y": 300,
        "wires": [
            [
                "e5e24dbc.9db6d8",
                "efd47e20.e03908"
            ]
        ]
    },
    {
        "id": "8151b9f0.adcad",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 360,
        "wires": [
            [
                "27f58d31.4d21fa",
                "e5e24dbc.9db6d8",
                "efd47e20.e03908"
            ]
        ]
    },
    {
        "id": "840a16a5.544688",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "a7227347.fe94b"
        ],
        "x": 115,
        "y": 1720,
        "wires": [
            [
                "1d94d778.523601"
            ]
        ]
    },
    {
        "id": "fc06de44.5741a8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "cache",
        "func": "msg.cache = msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 1720,
        "wires": [
            [
                "b3f13ee1.27d7f",
                "53d6f881.8a596",
                "701e3f02.f8fed"
            ]
        ]
    },
    {
        "id": "1d94d778.523601",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "some one home? and nodes",
        "func": "if(msg.payload.node_id !== 33 &&\nmsg.payload.node_id !== 31 &&\nmsg.payload.node_id !== 29 &&\nmsg.payload.node_id !== 2 &&\nmsg.payload.node_id !== 11 &&\nmsg.payload.node_id !== 25) \nreturn;\n\nif(global.get('presence') && !global.get('isNight')) {\n    return msg;\n}\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 1720,
        "wires": [
            [
                "fc06de44.5741a8"
            ]
        ]
    },
    {
        "id": "b3f13ee1.27d7f",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check vika",
        "func": "msg.payload = 2;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 1540,
        "wires": [
            [
                "e297f733.f83ee"
            ]
        ]
    },
    {
        "id": "53d6f881.8a596",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check living",
        "func": "msg.payload = 11;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 1720,
        "wires": [
            [
                "ec104c6b.1292e8"
            ]
        ]
    },
    {
        "id": "701e3f02.f8fed",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check kitchen",
        "func": "msg.payload = 25;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 1880,
        "wires": [
            [
                "dd08c1ed.dd8e58"
            ]
        ]
    },
    {
        "id": "dd08c1ed.dd8e58",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 1000,
        "y": 1880,
        "wires": [
            [
                "ae92eae0.51566"
            ],
            [
                "2cd9363.85891ca"
            ]
        ]
    },
    {
        "id": "ec104c6b.1292e8",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "x": 980,
        "y": 1720,
        "wires": [
            [
                "e06cf87d.8cdab"
            ],
            [
                "a6608ca.c61267"
            ]
        ]
    },
    {
        "id": "e297f733.f83ee",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 960,
        "y": 1540,
        "wires": [
            [
                "f00e6e7d.d300e"
            ],
            [
                "85897c53.2859b8"
            ]
        ]
    },
    {
        "id": "dbbe4a6.52c1838",
        "type": "influxdb in",
        "z": "e3d814f7.61466",
        "influxdb": "aeffd74.491f0a8",
        "name": "get temp",
        "query": "SELECT MEAN(\"temperature\") FROM \"statistics\".\"autogen\".\"weather\" WHERE time > now() - 5d GROUP BY time(5d) fill(null)",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "x": 260,
        "y": 140,
        "wires": [
            [
                "eadcd6ba.255b08"
            ]
        ]
    },
    {
        "id": "c5910452.ddd318",
        "type": "inject",
        "z": "e3d814f7.61466",
        "name": "",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "86400",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 110,
        "y": 140,
        "wires": [
            [
                "dbbe4a6.52c1838"
            ]
        ]
    },
    {
        "id": "eadcd6ba.255b08",
        "type": "function",
        "z": "e3d814f7.61466",
        "name": "check avarage temp",
        "func": "const pop = {\n    payload: [7,24,32]\n};\n\nconst temp = msg.payload[1];\nif(temp.mean <= 14) {\n    return [pop, null];\n}\nreturn [null, pop];",
        "outputs": 2,
        "noerr": 0,
        "x": 490,
        "y": 140,
        "wires": [
            [
                "a3e4d1c1.0d15a"
            ],
            [
                "d5c61ff6.6738c"
            ]
        ]
    },
    {
        "id": "2fdd78b4.eb7f7",
        "type": "mqtt out dynamic",
        "z": "e3d814f7.61466",
        "name": "zwave out",
        "topic": "/zwave/changevalue/request",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1840,
        "y": 60,
        "wires": []
    },
    {
        "id": "6a76abc9.326d4c",
        "type": "link in",
        "z": "e3d814f7.61466",
        "name": "zwave out",
        "links": [
            "2c222059.58fea8",
            "c53032e3.bdd91"
        ],
        "x": 1695,
        "y": 60,
        "wires": [
            [
                "2fdd78b4.eb7f7"
            ]
        ]
    },
    {
        "id": "d0e3eb98.f8e9e",
        "type": "function",
        "z": "e3d814f7.61466",
        "name": "turn on",
        "func": "const value = {\n        node_id: msg.payload,\n        class_id: 67,\n        instance: 1,\n        index: 1,\n        value: 28\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 900,
        "y": 100,
        "wires": [
            [
                "c53032e3.bdd91"
            ]
        ]
    },
    {
        "id": "c53032e3.bdd91",
        "type": "link out",
        "z": "e3d814f7.61466",
        "name": "",
        "links": [
            "6a76abc9.326d4c"
        ],
        "x": 1005,
        "y": 100,
        "wires": []
    },
    {
        "id": "a28a14f0.e83818",
        "type": "function",
        "z": "e3d814f7.61466",
        "name": "turn off",
        "func": "const value = {\n        node_id: msg.payload,\n        class_id: 67,\n        instance: 1,\n        index: 1,\n        value: 20\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 900,
        "y": 160,
        "wires": [
            [
                "2c222059.58fea8"
            ]
        ]
    },
    {
        "id": "2c222059.58fea8",
        "type": "link out",
        "z": "e3d814f7.61466",
        "name": "",
        "links": [
            "6a76abc9.326d4c"
        ],
        "x": 1005,
        "y": 160,
        "wires": []
    },
    {
        "id": "43e612e7.67d9bc",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn on",
        "func": "const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2260,
        "y": 1480,
        "wires": [
            [
                "7671752c.808264"
            ]
        ]
    },
    {
        "id": "7671752c.808264",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 2375,
        "y": 1480,
        "wires": []
    },
    {
        "id": "a3e4d1c1.0d15a",
        "type": "split",
        "z": "e3d814f7.61466",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 690,
        "y": 120,
        "wires": [
            [
                "d0e3eb98.f8e9e"
            ]
        ]
    },
    {
        "id": "d5c61ff6.6738c",
        "type": "split",
        "z": "e3d814f7.61466",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 690,
        "y": 160,
        "wires": [
            [
                "a28a14f0.e83818"
            ]
        ]
    },
    {
        "id": "12657579.abec7b",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn on",
        "func": "const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2300,
        "y": 1700,
        "wires": [
            [
                "33877f6c.fb786"
            ]
        ]
    },
    {
        "id": "33877f6c.fb786",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 2415,
        "y": 1700,
        "wires": []
    },
    {
        "id": "dbf3058b.2e1518",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn on",
        "func": "const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2360,
        "y": 1920,
        "wires": [
            [
                "ed17cf3d.f0f14"
            ]
        ]
    },
    {
        "id": "ed17cf3d.f0f14",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 2475,
        "y": 1920,
        "wires": []
    },
    {
        "id": "eaccc5b8.5c0868",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "30",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 2100,
        "y": 1440,
        "wires": [
            [
                "1bf382a2.802fbd"
            ],
            []
        ]
    },
    {
        "id": "1bf382a2.802fbd",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn off",
        "func": "const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 1\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2260,
        "y": 1440,
        "wires": [
            [
                "7671752c.808264"
            ]
        ]
    },
    {
        "id": "c23c47c.7e5b338",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn off",
        "func": "const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2300,
        "y": 1660,
        "wires": [
            [
                "33877f6c.fb786"
            ]
        ]
    },
    {
        "id": "a03227d6.a4bb3",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "30",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 2120,
        "y": 1660,
        "wires": [
            [
                "c23c47c.7e5b338"
            ],
            []
        ]
    },
    {
        "id": "55efbdcf.1a6d64",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "30",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 2200,
        "y": 1840,
        "wires": [
            [
                "cbac03e1.e91ed"
            ],
            []
        ]
    },
    {
        "id": "cbac03e1.e91ed",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn off",
        "func": "const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 2360,
        "y": 1880,
        "wires": [
            [
                "ed17cf3d.f0f14"
            ]
        ]
    },
    {
        "id": "5cc41779.465918",
        "type": "function",
        "z": "479f7f9c.36dc5",
        "name": "check db",
        "func": "msg.payload = {nodeid: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 240,
        "y": 140,
        "wires": [
            [
                "9f87b7a5.ac7458"
            ]
        ]
    },
    {
        "id": "9f87b7a5.ac7458",
        "type": "mongodb in",
        "z": "479f7f9c.36dc5",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find in db",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 380,
        "y": 140,
        "wires": [
            [
                "8bffe03.ee48ba"
            ]
        ]
    },
    {
        "id": "8bffe03.ee48ba",
        "type": "function",
        "z": "479f7f9c.36dc5",
        "name": "get lux",
        "func": "if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-49-1-3`);\n        if(value)\n        return {payload: value.value};\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "85897c53.2859b8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get movement vika",
        "func": "if(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n      return {payload: 33};\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 1560,
        "wires": [
            [
                "709ee0b5.fcbfb"
            ]
        ]
    },
    {
        "id": "709ee0b5.fcbfb",
        "type": "subflow:479f7f9c.36dc5",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 1530,
        "y": 1560,
        "wires": [
            [
                "9e8065e8.8065a8"
            ]
        ]
    },
    {
        "id": "9e8065e8.8065a8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lux",
        "func": "if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 1560,
        "wires": [
            [
                "2e5e1bed.90e804",
                "3b6702f3.6ff7be"
            ]
        ]
    },
    {
        "id": "919c2cb6.37c378",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lux",
        "func": "if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1700,
        "y": 1760,
        "wires": [
            [
                "6970d96c.b5e3e",
                "366615c1.74ebe2"
            ]
        ]
    },
    {
        "id": "f7fc6221.f0eee8",
        "type": "subflow:479f7f9c.36dc5",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 1570,
        "y": 1760,
        "wires": [
            [
                "919c2cb6.37c378"
            ]
        ]
    },
    {
        "id": "a6608ca.c61267",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get movement living",
        "func": "if(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n      return {payload: 31};\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1380,
        "y": 1760,
        "wires": [
            [
                "f7fc6221.f0eee8"
            ]
        ]
    },
    {
        "id": "2cd9363.85891ca",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get movement kitchen",
        "func": "if(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n    return {payload: 29};\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 1940,
        "wires": [
            [
                "9499a47b.9a2e48"
            ]
        ]
    },
    {
        "id": "9499a47b.9a2e48",
        "type": "subflow:479f7f9c.36dc5",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 1670,
        "y": 1940,
        "wires": [
            [
                "e420c2ba.8d445"
            ]
        ]
    },
    {
        "id": "e420c2ba.8d445",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lux",
        "func": "if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1800,
        "y": 1940,
        "wires": [
            [
                "8c3dd423.902f28",
                "35b24642.374a52"
            ]
        ]
    },
    {
        "id": "8b3c626f.79c9b8",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "a7227347.fe94b"
        ],
        "x": 75,
        "y": 1160,
        "wires": [
            [
                "4467b096.601fe",
                "eea459f2.96f2e8"
            ]
        ]
    },
    {
        "id": "4467b096.601fe",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check motion",
        "func": "if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 10 &&\nmsg.payload.value === 8 && \nmsg.payload.node_id === 48) {\n    const status = flow.get('bth_status');\n\n    if(status !== 'closed') {\n         return {payload: {}};\n    }\n}\n\nreturn;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 1160,
        "wires": [
            [
                "9e461386.92b188",
                "1fa4c3b8.7f1ea4",
                "25685085.23544"
            ]
        ]
    },
    {
        "id": "eea459f2.96f2e8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check door",
        "func": "const status = flow.get('bth_status');\n\nif(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.node_id === 35) {\n    if(!msg.payload.value) {\n        flow.set('bth_status', 'closed');\n        return [{payload: 'stop'}, null];\n    }\n    \n     if(msg.payload.value && status === 'closed') {\n        flow.set('bth_status', undefined);\n        return [null, {payload: {}}];\n    }\n}\n\nreturn;\n",
        "outputs": 2,
        "noerr": 0,
        "x": 190,
        "y": 1280,
        "wires": [
            [
                "a3652b59.5863b8",
                "d212c1b7.63fc"
            ],
            [
                "d212c1b7.63fc"
            ]
        ]
    },
    {
        "id": "80d48885.be9398",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "should turn on",
        "func": "const value = {\n        node_id: 17,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 1120,
        "wires": [
            [
                "9da00f53.385f08"
            ]
        ]
    },
    {
        "id": "9da00f53.385f08",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1055,
        "y": 1120,
        "wires": []
    },
    {
        "id": "a3652b59.5863b8",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "15",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 920,
        "y": 1180,
        "wires": [
            [
                "d5bd43e1.0c9df8"
            ],
            []
        ]
    },
    {
        "id": "d9d901bc.df1a78",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "should turn off",
        "func": "const value = {\n        node_id: 17,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n    \n    flow.set('bth_status', undefined);\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1680,
        "y": 1180,
        "wires": [
            [
                "8d53f094.ef08e"
            ]
        ]
    },
    {
        "id": "8d53f094.ef08e",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 1815,
        "y": 1180,
        "wires": []
    },
    {
        "id": "d212c1b7.63fc",
        "type": "stoptimer",
        "z": "1cc6b114.588857",
        "duration": "2",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "",
        "x": 920,
        "y": 1240,
        "wires": [
            [
                "d9d901bc.df1a78"
            ],
            []
        ]
    },
    {
        "id": "7bc2c097.abaec8",
        "type": "switch",
        "z": "d849a1af.eac2a8",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "stop",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 350,
        "y": 780,
        "wires": [
            [
                "d6b65947.0f035"
            ],
            [
                "92a4b653.ade74"
            ]
        ]
    },
    {
        "id": "d6b65947.0f035",
        "type": "delay",
        "z": "d849a1af.eac2a8",
        "name": "",
        "pauseType": "delay",
        "timeout": "30",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 310,
        "y": 720,
        "wires": [
            [
                "7022635c.73b9ac"
            ]
        ]
    },
    {
        "id": "9e461386.92b188",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "stop off",
        "func": "return {payload: 'stop'};",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 1080,
        "wires": [
            [
                "d212c1b7.63fc"
            ]
        ]
    },
    {
        "id": "61ef3aad.77d0fc",
        "type": "function",
        "z": "66ec50f7.5c938",
        "name": "check db",
        "func": "msg.payload = {nodeid: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 100,
        "wires": [
            [
                "86a28709.4dfbf8"
            ]
        ]
    },
    {
        "id": "86a28709.4dfbf8",
        "type": "mongodb in",
        "z": "66ec50f7.5c938",
        "mongodb": "3bb6209c.4b0d08",
        "name": "find in db",
        "collection": "zwave-nodes",
        "operation": "find",
        "x": 420,
        "y": 100,
        "wires": [
            [
                "cf8b7f55.70304"
            ]
        ]
    },
    {
        "id": "cf8b7f55.70304",
        "type": "function",
        "z": "66ec50f7.5c938",
        "name": "get humidity",
        "func": "if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-49-1-5`);\n        if(value)\n        return {payload: value.value};\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "c55c29ff.49018",
        "type": "subflow:66ec50f7.5c938",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 550,
        "y": 1180,
        "wires": [
            [
                "589ebd62.b5a7bc"
            ]
        ]
    },
    {
        "id": "1fa4c3b8.7f1ea4",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get hum",
        "func": "return {payload: 48};",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 1180,
        "wires": [
            [
                "c55c29ff.49018"
            ]
        ]
    },
    {
        "id": "589ebd62.b5a7bc",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "save hum",
        "func": "flow.set('bath_hum', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 1180,
        "wires": [
            [
                "a3652b59.5863b8"
            ]
        ]
    },
    {
        "id": "d5bd43e1.0c9df8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "get hum",
        "func": "return {payload: 48};",
        "outputs": 1,
        "noerr": 0,
        "x": 1080,
        "y": 1180,
        "wires": [
            [
                "eb844510.e6ce78"
            ]
        ]
    },
    {
        "id": "eb844510.e6ce78",
        "type": "subflow:66ec50f7.5c938",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 1240,
        "y": 1180,
        "wires": [
            [
                "846a24f7.767da"
            ]
        ]
    },
    {
        "id": "846a24f7.767da",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check hum",
        "func": "const savedHum = flow.get('bath_hum');\n\nif(savedHum < msg.payload) {\n    return [{payload:{}}, null];\n}\n\nreturn [null, {payload:{}}];",
        "outputs": 2,
        "noerr": 0,
        "x": 1410,
        "y": 1120,
        "wires": [
            [
                "a3652b59.5863b8"
            ],
            [
                "d9d901bc.df1a78"
            ]
        ]
    },
    {
        "id": "1ed3b9e3.77038e",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "8b6523e.75ef56"
        ],
        "x": 160,
        "y": 2420,
        "wires": [
            [
                "e814ecb1.661578"
            ]
        ]
    },
    {
        "id": "1e9dd070.689718",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "switch off",
        "func": "const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: false\n    };\n    \n    const value1 = {\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n    \n    const nodes = [39, 17].\n    map(x=> ({...value1, node_id: x}));\n    \n    nodes.push(value);\n    \n    \nreturn {payload: nodes};",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 2400,
        "wires": [
            [
                "1a198b82.3ab1e4"
            ]
        ]
    },
    {
        "id": "e3218ed.d599c7",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "switch off dimmers",
        "func": "const value = {\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 0\n    };\n    \n    \nconst nodes = [4, 5, 9, 10, 14].map(x=>({\n    node_id: x,\n    ...value\n}));\n    \n    \nreturn {payload: nodes};",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 2440,
        "wires": [
            [
                "1a198b82.3ab1e4"
            ]
        ]
    },
    {
        "id": "b5b7e1a9.e16c",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 975,
        "y": 2420,
        "wires": []
    },
    {
        "id": "1a198b82.3ab1e4",
        "type": "split",
        "z": "1cc6b114.588857",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 690,
        "y": 2420,
        "wires": [
            [
                "4b8d73d1.815334"
            ]
        ]
    },
    {
        "id": "4b8d73d1.815334",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "map to value",
        "func": "\nreturn {\n    payload: {\n        value: msg.payload\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 2420,
        "wires": [
            [
                "b5b7e1a9.e16c"
            ]
        ]
    },
    {
        "id": "700d653f.8a9cdc",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "выключить весь свет когда все ушли",
        "info": "",
        "x": 350,
        "y": 2320,
        "wires": []
    },
    {
        "id": "3b6702f3.6ff7be",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "sunset",
        "endTime": "sunrise",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1880,
        "y": 1520,
        "wires": [
            [
                "43e612e7.67d9bc",
                "eaccc5b8.5c0868"
            ],
            []
        ]
    },
    {
        "id": "2e5e1bed.90e804",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "13:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1880,
        "y": 1560,
        "wires": [
            [
                "43e612e7.67d9bc",
                "eaccc5b8.5c0868"
            ],
            []
        ]
    },
    {
        "id": "6970d96c.b5e3e",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "13:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1900,
        "y": 1760,
        "wires": [
            [
                "a03227d6.a4bb3",
                "12657579.abec7b"
            ],
            []
        ]
    },
    {
        "id": "366615c1.74ebe2",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "sunset",
        "endTime": "sunrise",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1900,
        "y": 1720,
        "wires": [
            [
                "a03227d6.a4bb3",
                "12657579.abec7b"
            ],
            []
        ]
    },
    {
        "id": "8c3dd423.902f28",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "13:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1980,
        "y": 1940,
        "wires": [
            [
                "55efbdcf.1a6d64",
                "dbf3058b.2e1518"
            ],
            []
        ]
    },
    {
        "id": "35b24642.374a52",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "sunset",
        "endTime": "sunrise",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1980,
        "y": 1900,
        "wires": [
            [
                "55efbdcf.1a6d64",
                "dbf3058b.2e1518"
            ],
            []
        ]
    },
    {
        "id": "f7f61a33.14952",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "check dimmer",
        "func": "msg.cache = msg.payload;\nmsg.payload = {id: 'dimmer'};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 400,
        "wires": [
            [
                "a245ce21.d75f3"
            ]
        ]
    },
    {
        "id": "a245ce21.d75f3",
        "type": "mongodb in",
        "z": "f924f1b0.7621d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "get code",
        "collection": "conditionare",
        "operation": "find",
        "x": 1000,
        "y": 400,
        "wires": [
            [
                "a522e90a.607c"
            ]
        ]
    },
    {
        "id": "a522e90a.607c",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "set code",
        "func": "msg.code = msg.payload[0];\nmsg.payload = msg.cache;\n\ndelete msg.cache;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "8f4da447.14c558"
            ]
        ]
    },
    {
        "id": "f00e6e7d.d300e",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "stop timer",
        "func": "return {\n    payload: 'stop'\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1240,
        "y": 1480,
        "wires": [
            [
                "eaccc5b8.5c0868"
            ]
        ]
    },
    {
        "id": "e06cf87d.8cdab",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "stop timer",
        "func": "return {\n    payload: 'stop'\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1300,
        "y": 1700,
        "wires": [
            [
                "a03227d6.a4bb3"
            ]
        ]
    },
    {
        "id": "ae92eae0.51566",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "stop timer",
        "func": "return {\n    payload: 'stop'\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 1860,
        "wires": [
            [
                "55efbdcf.1a6d64"
            ]
        ]
    },
    {
        "id": "10c7dbe9.50c354",
        "type": "mongodb in",
        "z": "f924f1b0.7621d8",
        "mongodb": "3bb6209c.4b0d08",
        "name": "conditionaire",
        "collection": "conditionare",
        "operation": "find",
        "x": 290,
        "y": 240,
        "wires": [
            [
                "2920da7a.bfd416"
            ]
        ]
    },
    {
        "id": "fcdabeb.6f7fb4",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "get cond status",
        "func": "msg.cache = msg.payload;\nmsg.payload = {id: msg.payload.id};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 120,
        "y": 240,
        "wires": [
            [
                "10c7dbe9.50c354"
            ]
        ]
    },
    {
        "id": "2920da7a.bfd416",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "set cond",
        "func": "msg.c = msg.payload[0];\n\nmsg.payload = msg.cache;\ndelete msg.cache;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 240,
        "wires": [
            [
                "21b55174.de198e"
            ]
        ]
    },
    {
        "id": "21b55174.de198e",
        "type": "function",
        "z": "f924f1b0.7621d8",
        "name": "is on",
        "func": "if(msg.c.enabled) {\n    return [msg, null];\n}\n\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 570,
        "y": 240,
        "wires": [
            [
                "8951d4fa.b71338"
            ],
            [
                "9f540b1e.8fdff"
            ]
        ]
    },
    {
        "id": "38eb4d57.ea1602",
        "type": "delay",
        "z": "f924f1b0.7621d8",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 660,
        "y": 400,
        "wires": [
            [
                "f7f61a33.14952"
            ]
        ]
    },
    {
        "id": "8951d4fa.b71338",
        "type": "delay",
        "z": "f924f1b0.7621d8",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 720,
        "y": 200,
        "wires": [
            [
                "9f540b1e.8fdff"
            ]
        ]
    },
    {
        "id": "b181cf2f.9c8428",
        "type": "inject",
        "z": "7d373be5.bb59d4",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 120,
        "y": 1440,
        "wires": [
            [
                "b9336183.e038d"
            ]
        ]
    },
    {
        "id": "a6dd0087.b705",
        "type": "time-range-switch",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "14:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1900,
        "y": 1140,
        "wires": [
            [
                "6a8c8c03.ac80b4"
            ],
            []
        ]
    },
    {
        "id": "abc31e87.bed11",
        "type": "time-range-switch",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "14:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1900,
        "y": 1180,
        "wires": [
            [
                "6d43a9e8.678f1"
            ],
            []
        ]
    },
    {
        "id": "484d4c3c.69ea54",
        "type": "time-range-switch",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "14:00",
        "endTime": "sunset",
        "startOffset": 0,
        "endOffset": "0",
        "x": 1900,
        "y": 1220,
        "wires": [
            [
                "51df6d03.3f8594"
            ],
            []
        ]
    },
    {
        "id": "e814ecb1.661578",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is presence",
        "func": "if(msg.payload.presence) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 290,
        "y": 2420,
        "wires": [
            [
                "e3218ed.d599c7",
                "1e9dd070.689718"
            ]
        ]
    },
    {
        "id": "be57ca25.f50cf",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "presence in",
        "links": [
            "b2410d22.c2f858"
        ],
        "x": 1675,
        "y": 360,
        "wires": []
    },
    {
        "id": "807d5762.95d948",
        "type": "mqtt in dynamic",
        "z": "fdd35751.cb5538",
        "topic": "/system/presence",
        "qos": "1",
        "name": "presence event",
        "broker": "7c5f5dec.00cb4c",
        "x": 1500,
        "y": 360,
        "wires": [
            [
                "be57ca25.f50cf"
            ]
        ]
    },
    {
        "id": "b2410d22.c2f858",
        "type": "link in",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "be57ca25.f50cf"
        ],
        "x": 55,
        "y": 800,
        "wires": [
            [
                "60f36eb4.c858a"
            ]
        ]
    },
    {
        "id": "60f36eb4.c858a",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "is presence",
        "func": "if(!msg.payload.presence) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 185,
        "y": 800,
        "wires": [
            [
                "5e531168.278f9"
            ]
        ]
    },
    {
        "id": "5e531168.278f9",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "send status",
        "func": "\nreturn {\n    topic: '/media/request',\n    payload: {\n        action: 'off'\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 800,
        "wires": [
            [
                "65211e02.66dd5"
            ]
        ]
    },
    {
        "id": "65211e02.66dd5",
        "type": "link out",
        "z": "fdd35751.cb5538",
        "name": "",
        "links": [
            "3bee2de6.c7d152"
        ],
        "x": 495,
        "y": 800,
        "wires": []
    },
    {
        "id": "5a65f1dd.5884",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check kitchen",
        "func": "msg.lx = msg.payload[0];\n\nmsg.payload = 25;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 100,
        "wires": [
            [
                "9170e9b2.dafcb"
            ]
        ]
    },
    {
        "id": "9170e9b2.dafcb",
        "type": "subflow:b02e364.3dde7c8",
        "z": "1cc6b114.588857",
        "name": "",
        "env": [],
        "x": 760,
        "y": 100,
        "wires": [
            [
                "2403eaf5.b22bd6"
            ],
            [
                "226740d3.cf6248"
            ]
        ]
    },
    {
        "id": "2403eaf5.b22bd6",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "send on",
        "func": "const value = {\n        node_id: 14,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 100,
        "wires": [
            [
                "a3999674.cd246"
            ]
        ]
    },
    {
        "id": "2dc5b09e.d4f058",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "ee7d8752.59cfa"
        ],
        "x": 675,
        "y": 1160,
        "wires": [
            [
                "70173e09.a05898"
            ]
        ]
    },
    {
        "id": "70173e09.a05898",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "check co2",
        "func": "const co2 = msg.payload.co2;\nconst savedCo2 = context.get('co2') || 0;\n\nif(savedCo2 === 0) {\n    context.set('co2', co2);\n    return;\n}\n\nconst diff = co2 - savedCo2;\n\nif(co2 > 550) {\n    if(diff >= 100 || co2 >= 700) {\n        context.set('co2', co2);\n        \n        return {payload: co2 >= 700 ? 2 : 1};\n    }\n}\nelse {\n     if(diff <= -100 || co2 <= 500) {\n        context.set('co2', co2);\n        return {payload: -1};\n    }\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 1160,
        "wires": [
            [
                "118b2cc0.d53de3"
            ]
        ]
    },
    {
        "id": "d0bce55e.d6b86",
        "type": "subflow:ecf602b6.267b58",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "env": [],
        "x": 1100,
        "y": 1160,
        "wires": [
            [
                "7c6bcade.33de64"
            ]
        ]
    },
    {
        "id": "7c6bcade.33de64",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "set speed",
        "func": "if(msg.payload.enabled) {\n    msg.temperature = msg.payload.temperature;\n    const speed = msg.payload.settedSpeed;\n    if(msg.cachedPayload > 0 && speed < 100) {\n        \n        let resultSpeed = speed + (msg.cachedPayload * 10) - (speed === 15 ? 5 : 0);\n        if(resultSpeed > 100) resultSpeed = 100;\n        return {temperature: msg.temperature, payload: resultSpeed};\n    }\n    if(msg.cachedPayload < 0 && speed > 15) {\n        let resultSpeed1 = speed + (msg.cachedPayload * 10);\n        if(resultSpeed1 < 15) resultSpeed1 = 15;\n        return {temperature: msg.temperature, payload: resultSpeed1};\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 1160,
        "wires": [
            [
                "cfe6f07a.dcb5e"
            ]
        ]
    },
    {
        "id": "d6cf47e4.bace18",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "25cbd97a.b4528e"
        ],
        "x": 2295,
        "y": 1180,
        "wires": []
    },
    {
        "id": "cfe6f07a.dcb5e",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "get weather",
        "func": "msg.cachedPayload = msg.payload;\nmsg.payload = {id: 1};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1490,
        "y": 1160,
        "wires": [
            [
                "e918b09d.3bde7"
            ]
        ]
    },
    {
        "id": "e918b09d.3bde7",
        "type": "mongodb in",
        "z": "f0ffdbb3.6e78b",
        "mongodb": "3bb6209c.4b0d08",
        "name": "weather",
        "collection": "weather",
        "operation": "find",
        "x": 1660,
        "y": 1160,
        "wires": [
            [
                "cbbf422a.b35b38"
            ]
        ]
    },
    {
        "id": "cbbf422a.b35b38",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "limit speed",
        "func": "const weather = msg.payload[0];\nmsg.payload = msg.cachedPayload;\n\nif(weather.currently.temperature <= 12.5 && msg.payload > 40) {\n    msg.payload = 40;\n    \n    if(weather.currently.temperature <= 0) {\n        msg.payload = 30;\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1830,
        "y": 1160,
        "wires": [
            [
                "18bca56e.d982c3"
            ]
        ]
    },
    {
        "id": "33ef985d.fa3c6",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "ee7d8752.59cfa"
        ],
        "x": 735,
        "y": 1240,
        "wires": [
            [
                "dcb22b85.bdd4c"
            ]
        ]
    },
    {
        "id": "be84b84b.906d4",
        "type": "mongodb out",
        "z": "f0ffdbb3.6e78b",
        "mongodb": "3bb6209c.4b0d08",
        "name": "save co2",
        "collection": "co2",
        "payonly": true,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1080,
        "y": 1240,
        "wires": []
    },
    {
        "id": "dcb22b85.bdd4c",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "prepare msg",
        "func": "const $set = {$set: msg.payload};\nconst query = {index: msg.payload.index};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 870,
        "y": 1240,
        "wires": [
            [
                "be84b84b.906d4"
            ]
        ]
    },
    {
        "id": "412e0730.3ed3b",
        "type": "inject",
        "z": "f0ffdbb3.6e78b",
        "name": "inject id",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 800,
        "y": 1320,
        "wires": [
            [
                "450bf3a5.c2d28c"
            ]
        ]
    },
    {
        "id": "2430b995.65c346",
        "type": "mongodb in",
        "z": "f0ffdbb3.6e78b",
        "mongodb": "3bb6209c.4b0d08",
        "name": "co2",
        "collection": "co2",
        "operation": "find",
        "x": 1170,
        "y": 1320,
        "wires": [
            [
                "8346e28b.30f9d"
            ]
        ]
    },
    {
        "id": "7d9a217f.8d90a",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "83932c7b.2477b"
        ],
        "x": 1475,
        "y": 1320,
        "wires": []
    },
    {
        "id": "8346e28b.30f9d",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "send all",
        "func": "msg.topic = '/co2/all/response'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 1320,
        "wires": [
            [
                "7d9a217f.8d90a"
            ]
        ]
    },
    {
        "id": "450bf3a5.c2d28c",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "inject ids",
        "func": "msg.payload = {index: 1};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 1320,
        "wires": [
            [
                "2430b995.65c346"
            ]
        ]
    },
    {
        "id": "fffb64fa.fe3038",
        "type": "mqtt in dynamic",
        "z": "f0ffdbb3.6e78b",
        "topic": "/co2/all/request",
        "qos": "1",
        "name": "co2 all in",
        "broker": "7c5f5dec.00cb4c",
        "x": 120,
        "y": 1240,
        "wires": [
            [
                "ea1a15fa.0d5a5"
            ]
        ]
    },
    {
        "id": "ea1a15fa.0d5a5",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "co2 interface in",
        "links": [
            "6e8d04de.fdd2b4"
        ],
        "x": 235,
        "y": 1240,
        "wires": []
    },
    {
        "id": "6e8d04de.fdd2b4",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "ea1a15fa.0d5a5"
        ],
        "x": 835,
        "y": 1380,
        "wires": [
            [
                "450bf3a5.c2d28c"
            ]
        ]
    },
    {
        "id": "83932c7b.2477b",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "co2 interface out",
        "links": [
            "7d9a217f.8d90a",
            "e6714b04.b66d78"
        ],
        "x": 75,
        "y": 1300,
        "wires": [
            [
                "a6725f49.c80658"
            ]
        ]
    },
    {
        "id": "a6725f49.c80658",
        "type": "mqtt out dynamic",
        "z": "f0ffdbb3.6e78b",
        "name": "co2 interface out",
        "topic": "",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 230,
        "y": 1300,
        "wires": []
    },
    {
        "id": "e6714b04.b66d78",
        "type": "link out",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "83932c7b.2477b"
        ],
        "x": 995,
        "y": 1520,
        "wires": []
    },
    {
        "id": "e68cfadc.320358",
        "type": "link in",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "links": [
            "ee7d8752.59cfa"
        ],
        "x": 755,
        "y": 1520,
        "wires": [
            [
                "812c8325.a5f7d"
            ]
        ]
    },
    {
        "id": "812c8325.a5f7d",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "prepare msg",
        "func": "msg.topic = '/co2/interface/response';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 880,
        "y": 1520,
        "wires": [
            [
                "e6714b04.b66d78"
            ]
        ]
    },
    {
        "id": "307c123c.f4c466",
        "type": "stoptimer",
        "z": "ed3957ea.447518",
        "duration": "2",
        "units": "Minute",
        "payloadtype": "num",
        "payloadval": "0",
        "name": "wait",
        "x": 1850,
        "y": 380,
        "wires": [
            [
                "682993d4.ccf554"
            ],
            []
        ]
    },
    {
        "id": "409472b4.52046c",
        "type": "subflow:5b528460.e43bb4",
        "z": "ed3957ea.447518",
        "name": "",
        "env": [],
        "x": 2420,
        "y": 560,
        "wires": []
    },
    {
        "id": "f4c2304b.dcbf48",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "telegram transform",
        "func": "return {\n    payload: {\n        content: 'Действие подтверждено'\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2220,
        "y": 560,
        "wires": [
            [
                "409472b4.52046c"
            ]
        ]
    },
    {
        "id": "7b7d1cfc.7040ec",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "8b6523e.75ef56"
        ],
        "x": 815,
        "y": 1460,
        "wires": [
            [
                "6b258f36.566648"
            ]
        ]
    },
    {
        "id": "6b258f36.566648",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is presence",
        "func": "if(msg.payload.presence) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 945,
        "y": 1460,
        "wires": [
            [
                "f00e6e7d.d300e"
            ]
        ]
    },
    {
        "id": "6c24e194.7efd7",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "8b6523e.75ef56"
        ],
        "x": 915,
        "y": 1660,
        "wires": [
            [
                "5d393c32.d42144"
            ]
        ]
    },
    {
        "id": "5d393c32.d42144",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is presence",
        "func": "if(msg.payload.presence) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1045,
        "y": 1660,
        "wires": [
            [
                "e06cf87d.8cdab"
            ]
        ]
    },
    {
        "id": "9bd922ac.a255f8",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "8b6523e.75ef56"
        ],
        "x": 915,
        "y": 1820,
        "wires": [
            [
                "58dc2de6.f97d74"
            ]
        ]
    },
    {
        "id": "58dc2de6.f97d74",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "is presence",
        "func": "if(msg.payload.presence) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1045,
        "y": 1820,
        "wires": [
            [
                "ae92eae0.51566"
            ]
        ]
    },
    {
        "id": "18bca56e.d982c3",
        "type": "time-range-switch",
        "z": "f0ffdbb3.6e78b",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "23:05",
        "endTime": "06:55",
        "startOffset": 0,
        "endOffset": "0",
        "x": 2020,
        "y": 1160,
        "wires": [
            [
                "bafc8de4.0a715"
            ],
            [
                "d6cf47e4.bace18"
            ]
        ]
    },
    {
        "id": "bafc8de4.0a715",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "limit speed",
        "func": "if(msg.payload > 40) {\n    msg.payload = 40;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2210,
        "y": 1100,
        "wires": [
            [
                "d6cf47e4.bace18"
            ]
        ]
    },
    {
        "id": "5cd14e95.6224e8",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "lamels down",
        "links": [
            "f182b022.50c4a",
            "6bfd7748.5d6418",
            "198ee04f.949f2"
        ],
        "x": 855,
        "y": 160,
        "wires": []
    },
    {
        "id": "f182b022.50c4a",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "5cd14e95.6224e8"
        ],
        "x": 815,
        "y": 1400,
        "wires": [
            [
                "4ed0546d.6aaadc"
            ]
        ]
    },
    {
        "id": "4ed0546d.6aaadc",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lamels",
        "func": "if(msg.payload.nodeid === 2)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 1400,
        "wires": [
            [
                "f00e6e7d.d300e"
            ]
        ]
    },
    {
        "id": "6bfd7748.5d6418",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "5cd14e95.6224e8"
        ],
        "x": 915,
        "y": 1600,
        "wires": [
            [
                "e7f33173.e21ab"
            ]
        ]
    },
    {
        "id": "e7f33173.e21ab",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lamels",
        "func": "if(msg.payload.nodeid === 11)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 1600,
        "wires": [
            [
                "e06cf87d.8cdab"
            ]
        ]
    },
    {
        "id": "198ee04f.949f2",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "5cd14e95.6224e8"
        ],
        "x": 915,
        "y": 1780,
        "wires": [
            [
                "6766e9c1.5d205"
            ]
        ]
    },
    {
        "id": "6766e9c1.5d205",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check lamels",
        "func": "if(msg.payload.nodeid === 25)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 1780,
        "wires": [
            [
                "ae92eae0.51566"
            ]
        ]
    },
    {
        "id": "79681b13.e2d1e4",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "some one home?",
        "func": "if(global.get('presence'))\n{\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 220,
        "wires": [
            [
                "6889d8d3.cb265"
            ]
        ]
    },
    {
        "id": "3255abc0.2007b4",
        "type": "inject",
        "z": "a811a2d2.521d38",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 140,
        "y": 980,
        "wires": [
            [
                "8369ccd4.cdde6"
            ]
        ]
    },
    {
        "id": "a5c96fd9.79e06",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "format",
        "func": "const doorSensor = global.get('door');\nlet motionSensors = [15, 47, 46, 29, 31, 33]\n        .map(x =>({id: x, data: global.get(`motion_${x}`)})).filter(x=>x.data != null);\n    const joined = motionSensors.map(x => \" motion_\" + x.id + \": \" + x.data.lastMotion).join(\", \");    \n        \n\n\nlet message = doorSensor != null ? \" door: \" + doorSensor.lastOpenDate : \"\";\nmessage += joined;\n\nreturn {\n    payload: {\n        content: \"дома \" + message\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1790,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "358b82b8.d3274e",
        "type": "function",
        "z": "ed3957ea.447518",
        "name": "format",
        "func": "const doorSensor = global.get('door');\nif(doorSensor)\n{\n    const doorClosedPeriod = doorSensor.lastCloseDate - doorSensor.lastOpenDate;\nif(global.get('presence') && doorClosedPeriod <= (60000 * 5)) \n{\n    return {\n    payload: {\n        content: \"движение или дверь \" + JSON.stringify(msg.payload)\n    }\n}\n}\n\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1070,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "118b2cc0.d53de3",
        "type": "function",
        "z": "f0ffdbb3.6e78b",
        "name": "some one home?",
        "func": "if(global.get('presence')) {\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 930,
        "y": 1100,
        "wires": [
            [
                "d0bce55e.d6b86"
            ]
        ]
    },
    {
        "id": "25c8cfa7.cb4c18",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {\"$or\":[{\"id\":\"ampon\"},{\"id\":\"switchon\"},{\"id\":\"switch2\"},{\"id\":\"tvon\"}]};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 320,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "327e5cfa.1ec9f4",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {id: \"tvon\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 280,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "a0d196d6.b06718",
        "type": "function",
        "z": "fdd35751.cb5538",
        "name": "get data",
        "func": "msg.payload = {id: \"tvoff\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "995ea717.086b8"
            ]
        ]
    },
    {
        "id": "eff3c0ca.e282e8",
        "type": "mqtt out dynamic",
        "z": "db61ef7a.7e00d8",
        "name": "send blinds open",
        "topic": "/system/blinds/open",
        "qos": "1",
        "retain": "",
        "broker": "7c5f5dec.00cb4c",
        "x": 1910,
        "y": 80,
        "wires": []
    },
    {
        "id": "a2bf4b4c.efd5f8",
        "type": "link in",
        "z": "db61ef7a.7e00d8",
        "name": "send blind open",
        "links": [
            "f7f516c.8b2f268",
            "fa0cc817.93c94"
        ],
        "x": 1755,
        "y": 80,
        "wires": [
            [
                "eff3c0ca.e282e8"
            ]
        ]
    },
    {
        "id": "c169c1a.67fd24",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "vika transform",
        "func": "return {\n    payload: {room: \"vika\"}\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1460,
        "y": 160,
        "wires": [
            [
                "f7f516c.8b2f268"
            ]
        ]
    },
    {
        "id": "f7f516c.8b2f268",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "a2bf4b4c.efd5f8"
        ],
        "x": 1595,
        "y": 180,
        "wires": []
    },
    {
        "id": "fa0cc817.93c94",
        "type": "link out",
        "z": "db61ef7a.7e00d8",
        "name": "",
        "links": [
            "a2bf4b4c.efd5f8"
        ],
        "x": 1955,
        "y": 420,
        "wires": []
    },
    {
        "id": "3ff232b7.5decf6",
        "type": "function",
        "z": "db61ef7a.7e00d8",
        "name": "living transform",
        "func": "return {\n    payload: {room: \"living\"}\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1800,
        "y": 380,
        "wires": [
            [
                "fa0cc817.93c94"
            ]
        ]
    },
    {
        "id": "3a938319.399234",
        "type": "comment",
        "z": "1cc6b114.588857",
        "name": "Включить свет в комнатах на подъем штор по будильнику",
        "info": "",
        "x": 360,
        "y": 2560,
        "wires": []
    },
    {
        "id": "976dd915.69a72",
        "type": "mqtt in dynamic",
        "z": "1cc6b114.588857",
        "topic": "/system/blinds/open",
        "qos": "1",
        "name": "blinds open in",
        "broker": "7c5f5dec.00cb4c",
        "x": 1770,
        "y": 340,
        "wires": [
            [
                "6e8ea604.09bc98"
            ]
        ]
    },
    {
        "id": "6e8ea604.09bc98",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "blinds open in",
        "links": [
            "2f9b1732.e41b3"
        ],
        "x": 1900,
        "y": 340,
        "wires": []
    },
    {
        "id": "2f9b1732.e41b3",
        "type": "link in",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "6e8ea604.09bc98"
        ],
        "x": 75,
        "y": 2700,
        "wires": [
            [
                "c189dd53.98591"
            ]
        ]
    },
    {
        "id": "c189dd53.98591",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check date",
        "func": "const now = new Date();\nconst month = now.getMonth();\n\nif(month < 2 || month >= 10)\n    return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 200,
        "y": 2700,
        "wires": [
            [
                "1e01e97c.d9ea3f"
            ]
        ]
    },
    {
        "id": "f927af5a.70d22",
        "type": "switch",
        "z": "1cc6b114.588857",
        "name": "check blinds",
        "property": "payload.room",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "vika",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "living",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 470,
        "y": 2700,
        "wires": [
            [
                "6e90ed4c.3195ec"
            ],
            [
                "9f54de1d.a117d"
            ]
        ]
    },
    {
        "id": "9f54de1d.a117d",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn on living",
        "func": "const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: msg.value || 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 2760,
        "wires": [
            [
                "fa79af41.c51738",
                "11d70192.238a5e"
            ]
        ]
    },
    {
        "id": "fa79af41.c51738",
        "type": "delay",
        "z": "1cc6b114.588857",
        "name": "",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 850,
        "y": 2760,
        "wires": [
            [
                "6ca37c69.26556c"
            ]
        ]
    },
    {
        "id": "6ca37c69.26556c",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check param",
        "func": "if(msg.payload.value.value < 50)\nreturn {value: msg.payload.value.value + 1};",
        "outputs": 1,
        "noerr": 0,
        "x": 1070,
        "y": 2760,
        "wires": [
            [
                "9f54de1d.a117d"
            ]
        ]
    },
    {
        "id": "11d70192.238a5e",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 765,
        "y": 2820,
        "wires": []
    },
    {
        "id": "6e90ed4c.3195ec",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "turn on vika",
        "func": "const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: msg.value || 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 2620,
        "wires": [
            [
                "764c61ef.dfa38",
                "c380e9e3.4d7e48"
            ]
        ]
    },
    {
        "id": "764c61ef.dfa38",
        "type": "delay",
        "z": "1cc6b114.588857",
        "name": "",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 900,
        "y": 2620,
        "wires": [
            [
                "642ec97f.d246c8"
            ]
        ]
    },
    {
        "id": "642ec97f.d246c8",
        "type": "function",
        "z": "1cc6b114.588857",
        "name": "check param",
        "func": "if(msg.payload.value.value < 50)\nreturn {value: msg.payload.value.value + 1};",
        "outputs": 1,
        "noerr": 0,
        "x": 1120,
        "y": 2620,
        "wires": [
            [
                "6e90ed4c.3195ec"
            ]
        ]
    },
    {
        "id": "c380e9e3.4d7e48",
        "type": "link out",
        "z": "1cc6b114.588857",
        "name": "",
        "links": [
            "19554757.950051"
        ],
        "x": 805,
        "y": 2680,
        "wires": []
    },
    {
        "id": "1e01e97c.d9ea3f",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "03:00",
        "endTime": "09:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 340,
        "y": 2760,
        "wires": [
            [
                "f927af5a.70d22"
            ],
            []
        ]
    },
    {
        "id": "6b7e0a08.2f46e4",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "checks",
        "func": "const vacation = global.get('vacation');\n\nif(vacation) return;\n\nif(msg.weather.currently.temperature < 1) return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 340,
        "wires": [
            [
                "e4067e34.7b113"
            ]
        ]
    },
    {
        "id": "87bb5bca.865f6",
        "type": "function",
        "z": "51524d6e.749374",
        "name": "checks presence",
        "func": "const presence = global.get('presence');\n\nmsg.presence = presence;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1570,
        "y": 60,
        "wires": [
            [
                "1caad64a.028b72"
            ]
        ]
    },
    {
        "id": "25685085.23544",
        "type": "time-range-switch",
        "z": "1cc6b114.588857",
        "name": "",
        "lat": "55.755825",
        "lon": "37.617298",
        "startTime": "23:00",
        "endTime": "06:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 640,
        "y": 1100,
        "wires": [
            [],
            [
                "80d48885.be9398"
            ]
        ]
    }
]